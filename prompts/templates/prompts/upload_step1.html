{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5 mb-5">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="h3 mb-3" style="font-weight: 400; color: #1f2937;">
            Share your prompts and let the world discover them
        </h1>
        <p class="text-muted mb-5" style="font-size: 16px; color: #6b7280;">
            Share your first 10 prompts to introduce yourself to millions of Prompt Finders.
        </p>
    </div>

    <!-- Spacing -->
    <div class="mb-5"></div>

    <!-- CSRF token for AJAX requests -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <!-- Drag-drop upload area -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="drop-zone"
                 class="border border-2 rounded-3 p-5 text-center"
                 style="
                     min-height: 400px;
                     cursor: pointer;
                     transition: all 0.3s;
                     border-style: dashed !important;
                     border-color: #d1d5db !important;
                     background-color: #fafafa;
                     position: relative;
                 ">
                <!-- Upload counter in top-right -->
                <div style="position: absolute; top: 20px; right: 20px;">
                    <span style="color: var(--gray-400); font-size: 14px;">({{ uploads_this_week }}/{{ weekly_limit }})</span>
                </div>

                <div class="my-5">
                    <!-- Font Awesome icon -->
                    <div class="mb-4">
                        <i class="fas fa-images" style="font-size: 80px; color: #05a081;"></i>
                    </div>

                    <h3 class="mb-3" style="font-weight: 400; color: #1f2937; font-size: 24px;">
                        Drag and drop to upload, or
                    </h3>
                    <button type="button" class="btn btn-lg" id="browse-btn"
                            style="
                                background-color: #05a081;
                                color: white;
                                border: none;
                                padding: 12px 32px;
                                border-radius: 8px;
                                font-weight: 500;
                            ">
                        Browse
                    </button>
                    <input type="file" id="file-input" accept="image/*,video/*" style="display:none;">

                    <p class="text-muted mt-3 small" style="color: #6b7280;">
                        (You have <strong>{{ uploads_remaining }}</strong> upload{{ uploads_remaining|pluralize }} left for the day)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced 5-Step Progress Indicator -->
    <div id="upload-progress" class="mt-4" style="display:none;">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- Step Indicators -->
                <div class="progress-steps">
                    <div class="progress-step" data-step="1">
                        <div class="step-dot"></div>
                        <span class="step-label">Analyze</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-dot"></div>
                        <span class="step-label">Safety</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-dot"></div>
                        <span class="step-label">Tags</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-dot"></div>
                        <span class="step-label">Upload</span>
                    </div>
                    <div class="progress-step" data-step="5">
                        <div class="step-dot"></div>
                        <span class="step-label">Finalize</span>
                    </div>
                </div>

                <!-- Status Message -->
                <div class="progress-status text-center mt-4" role="status" aria-live="polite">
                    <h4 id="progress-message" class="mb-2">Preparing your upload...</h4>
                    <p id="progress-detail" class="text-muted mb-0" aria-live="polite">Please wait</p>
                </div>

                <!-- Upload Progress Bar (shown during B2 upload) -->
                <div id="upload-bar-container" class="mt-3" style="display:none;">
                    <div class="progress" style="height: 8px; border-radius: 4px;">
                        <div class="progress-bar"
                             role="progressbar"
                             style="width: 0%; background-color: #05a081; transition: width 0.3s ease;"
                             id="progress-bar"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                    <p class="text-center mt-2 mb-0">
                        <span id="progress-percent">0%</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Step Styles -->
    <style>
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            padding: 0 10px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 30px;
            right: 30px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            flex: 1;
            max-width: 80px;
        }

        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e0e0e0;
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .step-dot::after {
            content: '';
            font-size: 12px;
            color: white;
        }

        .step-label {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            text-align: center;
            transition: color 0.3s ease;
        }

        /* Active step - pulsing animation */
        .progress-step.active .step-dot {
            background-color: #05a081;
            border-color: #05a081;
            animation: pulse 1.5s infinite;
        }

        .progress-step.active .step-label {
            color: #05a081;
            font-weight: 500;
        }

        /* Completed step - checkmark */
        .progress-step.completed .step-dot {
            background-color: #05a081;
            border-color: #05a081;
            animation: none;
        }

        .progress-step.completed .step-dot::after {
            content: '✓';
        }

        .progress-step.completed .step-label {
            color: #05a081;
        }

        /* Error state */
        .progress-step.error .step-dot {
            background-color: #dc3545;
            border-color: #dc3545;
            animation: none;
        }

        .progress-step.error .step-dot::after {
            content: '✕';
        }

        .progress-step.error .step-label {
            color: #dc3545;
        }

        /* Pulse animation for active step */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(5, 160, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(5, 160, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(5, 160, 129, 0);
            }
        }

        /* Success state for final completion */
        .progress-status.success #progress-message {
            color: #05a081;
        }

        .progress-status.error #progress-message {
            color: #dc3545;
        }

        /* Mobile responsive */
        @media (max-width: 576px) {
            .step-label {
                font-size: 9px;
            }
            .step-dot {
                width: 20px;
                height: 20px;
            }
            .progress-steps::before {
                top: 10px;
            }
        }

        /* L8-PROGRESS-ANIMATE: Animated dots for finalizing state */
        .animated-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* L8-PROGRESS-ANIMATE: Fade transition for rotating messages */
        #progress-detail {
            transition: opacity 0.3s ease-in-out;
        }

        #progress-detail.fading {
            opacity: 0;
        }
    </style>

    <!-- Spacing -->
    <div class="mb-5"></div>

    <!-- Guidelines in 3 columns -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-10">
            <div class="row">
                <!-- Column 1 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Original content you created or have rights to
                        </li>
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Excludes nudity, violence, or hate
                        </li>
                    </ul>
                </div>

                <!-- Column 2 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Mindful of the rights of others
                        </li>
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Free to use for the community
                        </li>
                    </ul>
                </div>

                <!-- Column 3 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            High quality images and videos
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Skip upload link -->
    <div class="text-center mt-4">
        <a href="/"
           style="color: #6b7280; text-decoration: none; font-size: 15px;">
            Skip upload
        </a>
    </div>
</div>

<script>
// Drag-and-drop functionality
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const browseBtn = document.getElementById('browse-btn');
const uploadProgress = document.getElementById('upload-progress');
const progressBar = document.getElementById('progress-bar');
const progressPercent = document.getElementById('progress-percent');

// Progress UI Manager - Controls 5-step visual progress
const ProgressUI = {
    steps: [
        { step: 1, message: 'Analyzing your image...', detail: 'Please wait while we process your upload' },
        { step: 2, message: 'Checking content safety...', detail: 'Ensuring your image meets our guidelines' },
        { step: 3, message: 'Generating tags...', detail: 'AI is suggesting relevant tags' },
        { step: 4, message: 'Uploading to cloud...', detail: 'Uploading: 0%' },
        { step: 5, message: 'Finalizing...', detail: 'Almost there!' }
    ],

    currentStep: 0,

    // L8-PROGRESS-ANIMATE: Properties for animated finalizing state
    finalizingMessages: ['Almost there!', 'Processing variants...', 'Wrapping up!'],
    finalizingMessageIndex: 0,
    finalizingInterval: null,

    show() {
        uploadProgress.style.display = 'block';
        dropZone.style.display = 'none';
        this.resetSteps();
    },

    hide() {
        uploadProgress.style.display = 'none';
        dropZone.style.display = 'block';
    },

    resetSteps() {
        this.currentStep = 0;
        document.querySelectorAll('.progress-step').forEach(el => {
            el.classList.remove('active', 'completed', 'error');
        });
        document.getElementById('upload-bar-container').style.display = 'none';
        document.querySelector('.progress-status').classList.remove('success', 'error');
    },

    updateStep(stepNumber, customDetail = null) {
        const stepData = this.steps.find(s => s.step === stepNumber);
        if (!stepData) return;

        this.currentStep = stepNumber;

        // Mark previous steps as completed
        document.querySelectorAll('.progress-step').forEach(el => {
            const elStep = parseInt(el.dataset.step);
            el.classList.remove('active', 'completed', 'error');
            if (elStep < stepNumber) {
                el.classList.add('completed');
            } else if (elStep === stepNumber) {
                el.classList.add('active');
            }
        });

        // Update message and detail
        document.getElementById('progress-message').textContent = stepData.message;
        document.getElementById('progress-detail').textContent = customDetail || stepData.detail;

        // Show progress bar only for step 4 (upload)
        const barContainer = document.getElementById('upload-bar-container');
        if (stepNumber === 4) {
            barContainer.style.display = 'block';
        } else {
            barContainer.style.display = 'none';
        }
    },

    setUploadProgress(percent) {
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressPercent.textContent = percent + '%';
        document.getElementById('progress-detail').textContent = `Uploading: ${percent}%`;
    },

    complete() {
        // Mark all steps as completed
        document.querySelectorAll('.progress-step').forEach(el => {
            el.classList.remove('active', 'error');
            el.classList.add('completed');
        });

        document.getElementById('progress-message').textContent = 'Success! Redirecting...';
        document.getElementById('progress-detail').textContent = '';
        document.querySelector('.progress-status').classList.add('success');
        document.getElementById('upload-bar-container').style.display = 'none';
    },

    error(message) {
        // Mark current step as error
        const currentStepEl = document.querySelector(`.progress-step[data-step="${this.currentStep}"]`);
        if (currentStepEl) {
            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('error');
        }

        document.getElementById('progress-message').textContent = 'Upload Failed';
        document.getElementById('progress-detail').textContent = message || 'Please try again';
        document.querySelector('.progress-status').classList.add('error');
        document.getElementById('upload-bar-container').style.display = 'none';
    },

    // L8-PROGRESS-ANIMATE: Start animated finalizing state with rotating messages
    startFinalizing() {
        // Mark steps 1-4 as completed, keep step 5 active (pulsing)
        document.querySelectorAll('.progress-step').forEach(el => {
            const elStep = parseInt(el.dataset.step);
            el.classList.remove('active', 'completed', 'error');
            if (elStep < 5) {
                el.classList.add('completed');
            } else {
                el.classList.add('active'); // Keep step 5 pulsing
            }
        });

        // Set animated "Finalizing" message with CSS animated dots
        const messageEl = document.getElementById('progress-message');
        messageEl.textContent = 'Finalizing';
        messageEl.classList.add('animated-dots');

        // Set initial subtext message
        this.finalizingMessageIndex = 0;
        document.getElementById('progress-detail').textContent = this.finalizingMessages[0];

        // Hide progress bar
        document.getElementById('upload-bar-container').style.display = 'none';

        // Apply success color to message
        document.querySelector('.progress-status').classList.add('success');

        // Start rotating messages every 2 seconds
        this.finalizingInterval = setInterval(() => {
            this.updateFinalizingMessage();
        }, 2000);
    },

    // L8-PROGRESS-ANIMATE: Update to next message in rotation
    updateFinalizingMessage() {
        this.finalizingMessageIndex = (this.finalizingMessageIndex + 1) % this.finalizingMessages.length;
        this.fadeAndUpdateMessage(this.finalizingMessages[this.finalizingMessageIndex]);
    },

    // L8-PROGRESS-ANIMATE: Fade out, change text, fade in
    fadeAndUpdateMessage(newText) {
        const detailEl = document.getElementById('progress-detail');

        // Fade out
        detailEl.classList.add('fading');

        // After fade out, change text and fade in
        setTimeout(() => {
            detailEl.textContent = newText;
            detailEl.classList.remove('fading');
        }, 300); // Match CSS transition duration
    },

    // L8-PROGRESS-ANIMATE: Clean up interval and redirect
    completeAndRedirect(redirectUrl) {
        // Clear interval to prevent memory leaks
        if (this.finalizingInterval) {
            clearInterval(this.finalizingInterval);
            this.finalizingInterval = null;
        }

        // Mark all steps as completed
        document.querySelectorAll('.progress-step').forEach(el => {
            el.classList.remove('active', 'error');
            el.classList.add('completed');
        });

        // Remove animated dots class
        const messageEl = document.getElementById('progress-message');
        messageEl.classList.remove('animated-dots');
        messageEl.textContent = 'Success!';

        // Final message before redirect
        document.getElementById('progress-detail').textContent = 'Redirecting...';

        // Brief delay then redirect
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 500);
    }
};

// Click to browse
browseBtn.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('click', (e) => {
    if (e.target !== browseBtn) {
        fileInput.click();
    }
});

// Drag over effect
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#05a081';
    dropZone.style.backgroundColor = '#f0fdf4';
});

dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = '#d1d5db';
    dropZone.style.backgroundColor = '#fafafa';
});

// Handle drop
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#d1d5db';
    dropZone.style.backgroundColor = '#fafafa';

    const file = e.dataTransfer.files[0];
    if (file) {
        handleFileUpload(file);
    }
});

// Handle file input change
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        handleFileUpload(file);
    }
});

// File upload handler
function handleFileUpload(file) {
    // Validate file
    if (!validateFile(file)) return;

    // Show progress UI and start step 1
    ProgressUI.show();
    ProgressUI.updateStep(1);

    // Upload to B2
    uploadToB2(file);
}

// Validate file size and type
function validateFile(file) {
    const maxImageSize = 10 * 1024 * 1024;  // 10MB
    const maxVideoSize = 100 * 1024 * 1024;  // 100MB

    if (file.type.startsWith('image/')) {
        if (file.size > maxImageSize) {
            showUploadError('Image must be under 10MB. Your file is ' + (file.size / 1024 / 1024).toFixed(1) + 'MB');
            return false;
        }
    } else if (file.type.startsWith('video/')) {
        if (file.size > maxVideoSize) {
            showUploadError('Video must be under 100MB. Your file is ' + (file.size / 1024 / 1024).toFixed(1) + 'MB');
            return false;
        }
        // Note: Duration check happens after upload (can't check before)
    } else {
        showUploadError('Please upload an image (JPG, PNG, WebP) or video (MP4, MOV, WebM)');
        return false;
    }

    return true;
}

// Helper function to get CSRF token (tries multiple sources)
function getCSRFToken() {
    // Method 1: Try hidden input first (most reliable in Django)
    const hiddenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (hiddenInput) {
        return hiddenInput.value;
    }

    // Method 2: Try meta tag (if present)
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }

    // Method 3: Fall back to cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to escape HTML (XSS prevention)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Show error message to user with inline Bootstrap alert
function showUploadError(message) {
    // Update ProgressUI to error state if it's visible
    if (uploadProgress.style.display !== 'none') {
        ProgressUI.error(message);
        // Wait 2 seconds then hide progress and show drop zone with error
        setTimeout(() => {
            ProgressUI.hide();
            ProgressUI.resetSteps();
            showErrorAlert(message);
        }, 2000);
    } else {
        showErrorAlert(message);
    }

    // Reset file input
    fileInput.value = '';
}

// Show error alert element
function showErrorAlert(message) {
    // Find or create error element
    let errorEl = document.getElementById('upload-error-message');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = 'upload-error-message';
        errorEl.className = 'alert alert-danger mt-3';
        errorEl.setAttribute('role', 'alert');

        // Insert after the drop zone container
        const dropZoneContainer = dropZone.closest('.col-md-8');
        if (dropZoneContainer) {
            dropZoneContainer.appendChild(errorEl);
        }
    }

    // Set error content with close button
    errorEl.innerHTML = '<strong>Upload Error:</strong> ' + escapeHtml(message) +
        '<button type="button" class="btn-close float-end" aria-label="Close"></button>';
    errorEl.style.display = 'block';

    // Add close button handler
    const closeBtn = errorEl.querySelector('.btn-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            errorEl.style.display = 'none';
        });
    }

    // Reset progress bar
    progressBar.style.width = '0%';
    progressPercent.textContent = '0%';
}

// Validate B2 API response schema
function validateB2Response(response) {
    // Check required top-level fields
    if (typeof response.success !== 'boolean') {
        return { valid: false, error: 'Invalid response format' };
    }

    if (!response.success) {
        // Error response - just needs error message
        return { valid: true };
    }

    // Success response - check required fields
    if (!response.urls || typeof response.urls !== 'object') {
        return { valid: false, error: 'Missing URLs in response' };
    }

    if (!response.urls.original) {
        return { valid: false, error: 'Missing original URL in response' };
    }

    if (!response.filename) {
        return { valid: false, error: 'Missing filename in response' };
    }

    return { valid: true };
}

// L8-DIRECT: Upload directly to B2 using presigned URLs
// This eliminates the double-hop (Browser → Heroku → B2) and reduces upload time by ~87%
async function uploadToB2(file) {
    const isVideo = file.type.startsWith('video/');
    const resourceType = isVideo ? 'video' : 'image';

    const csrftoken = getCSRFToken();
    if (!csrftoken) {
        showUploadError('Session expired. Please refresh the page and try again.');
        return;
    }

    try {
        // UI Step 1: Analyzing (already set in handleFileUpload)
        // Simulate brief analysis time for better UX
        await new Promise(resolve => setTimeout(resolve, 300));

        // UI Step 2: Content safety check
        ProgressUI.updateStep(2);

        const presignParams = new URLSearchParams({
            content_type: file.type,
            content_length: file.size,
            filename: file.name
        });

        const presignResponse = await fetch(`/api/upload/b2/presign/?${presignParams.toString()}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken
            }
        });

        if (!presignResponse.ok) {
            const errorData = await presignResponse.json().catch(() => ({}));
            throw new Error(errorData.error || `Failed to prepare upload (${presignResponse.status})`);
        }

        const presignData = await presignResponse.json();
        if (!presignData.success) {
            throw new Error(presignData.error || 'Failed to get upload URL');
        }

        // UI Step 3: Generating tags
        ProgressUI.updateStep(3);
        await new Promise(resolve => setTimeout(resolve, 300));

        // UI Step 4: Upload to B2
        ProgressUI.updateStep(4);

        const uploadXhr = new XMLHttpRequest();

        // Progress tracking for direct B2 upload
        uploadXhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                ProgressUI.setUploadProgress(percent);
            }
        });

        // Create promise to handle XHR async
        const uploadPromise = new Promise((resolve, reject) => {
            uploadXhr.addEventListener('load', () => {
                if (uploadXhr.status >= 200 && uploadXhr.status < 300) {
                    resolve();
                } else {
                    reject(new Error(`Upload failed with status ${uploadXhr.status}`));
                }
            });
            uploadXhr.addEventListener('error', () => reject(new Error('Network error during upload')));
            uploadXhr.addEventListener('timeout', () => reject(new Error('Upload timed out')));
        });

        // B2 requires PUT for presigned uploads
        uploadXhr.open('PUT', presignData.presigned_url);
        uploadXhr.setRequestHeader('Content-Type', file.type);
        uploadXhr.timeout = 300000; // 5 minutes
        uploadXhr.send(file);

        await uploadPromise;

        // UI Step 5: Finalizing
        ProgressUI.updateStep(5);

        const completeResponse = await fetch('/api/upload/b2/complete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                quick: !isVideo  // Quick mode for images only
            })
        });

        if (!completeResponse.ok) {
            const errorData = await completeResponse.json().catch(() => ({}));
            throw new Error(errorData.error || `Processing failed (${completeResponse.status})`);
        }

        const completeData = await completeResponse.json();
        if (!completeData.success) {
            throw new Error(completeData.error || 'Processing failed');
        }

        // STEP 4: Redirect to step 2 with B2 URLs
        // L8-DIRECT-FIX: For images, only pass original URL and variants_pending flag
        // Variants will be generated in background on Step 2 page load
        const params = new URLSearchParams({
            resource_type: resourceType,
            b2_original: completeData.urls.original || ''
        });

        // For images: pass variants_pending flag (variants generated on Step 2)
        if (!isVideo && completeData.variants_pending) {
            params.set('variants_pending', 'true');
        }

        // For videos: pass video-specific URLs (thumbnail generated synchronously)
        if (isVideo) {
            if (completeData.urls.original) {
                params.set('b2_video', completeData.urls.original);
            }
            if (completeData.urls.thumb) {
                params.set('b2_video_thumb', completeData.urls.thumb);
            }
            if (completeData.info) {
                params.set('video_duration', completeData.info.duration || '');
                params.set('video_width', completeData.info.width || '');
                params.set('video_height', completeData.info.height || '');
            }
        }

        if (completeData.filename) {
            params.set('b2_filename', completeData.filename);
        }

        // L8-PROGRESS-ANIMATE: Start animated finalizing state with rotating messages
        const redirectUrl = `/upload/details?${params.toString()}`;
        ProgressUI.startFinalizing();

        // Wait for at least one message rotation cycle (2 seconds) for better UX
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Clean up and redirect
        ProgressUI.completeAndRedirect(redirectUrl);

    } catch (error) {
        console.error('Upload error:', error);
        // L8-PROGRESS-ANIMATE: Clean up any running intervals on error
        if (ProgressUI.finalizingInterval) {
            clearInterval(ProgressUI.finalizingInterval);
            ProgressUI.finalizingInterval = null;
        }
        showUploadError(error.message || 'Upload failed. Please try again.');
    }
}
</script>
{% endblock %}

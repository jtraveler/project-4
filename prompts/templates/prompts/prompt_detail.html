{% extends 'base.html' %}
{% load static %}
{% load cloudinary_tags %}
{% load prompt_tags %}

{% block extra_head %}
<!-- DNS prefetch for external resources -->
<link rel="dns-prefetch" href="//res.cloudinary.com">
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">

<!-- Preload media based on type -->
{% if prompt.is_video %}
    <!-- Preload video poster/thumbnail -->
    {% with thumbnail_url=prompt.get_thumbnail_url %}
        {% if thumbnail_url %}
            <link rel="preload" as="image" href="{{ thumbnail_url }}" />
        {% endif %}
    {% endwith %}
{% else %}
    <!-- Preload the hero image for LCP optimization -->
    {% if prompt.featured_image and not "placeholder" in prompt.featured_image.url %}
        <link rel="preload" as="image"
          href="{{ prompt.featured_image.url|cloudinary_transform:'w_1200,c_limit,f_webp,q_90' }}" />
    {% endif %}
{% endif %}

<!-- Prompt Detail Page Styles (extracted to external file) -->
<link rel="stylesheet" href="{% static 'css/pages/prompt-detail.css' %}">
{% endblock %}

{% block content %}
<div class="prompt-detail-page">
<h1 class="visually-hidden">{{ prompt.title }} - AI Prompt Details</h1>

{# Draft banner handled in base.html notification container #}

<!-- ============================================================
     SIDE-BY-SIDE LAYOUT (PromptHero Style)
     Left Column: Image, Actions, Title, Description, Comments
     Right Rail: Author Card, Stats, Details, Prompt, Tags
     ============================================================ -->
<div class="container prompt-content-wrapper">
    <div class="row">
        <!-- ========================================
             LEFT COLUMN (col-lg-7)
             Image at TOP, then content below
             ======================================== -->
        <div class="col-lg-7 prompt-left-column">

            <!-- Featured Media (Image/Video) - NOW IN LEFT COLUMN -->
            <div class="prompt-media-container-shell">
                <div class="prompt-media-container">
                    {% if prompt.is_video and prompt.featured_video %}
                        <!-- Video Display -->
                        <video controls class="hero-video"
                            poster="{{ prompt.get_thumbnail_url }}"
                            preload="metadata"
                            autoplay
                            loop
                            muted>
                            <source src="{{ prompt.featured_video.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% elif prompt.featured_image %}
                        <!-- Image Display -->
                        {% if "placeholder" in prompt.featured_image.url %}
                            <img src="{% static 'images/placeholder-prompt.svg' %}"
                                 class="hero-image"
                                 alt="{{ prompt.title }} - No image available"
                                 loading="eager"
                                 style="background-color: #f0f0f0; object-fit: contain;">
                        {% else %}
                            <img src="{{ prompt.featured_image.url|cloudinary_transform:'w_1200,c_limit,f_webp,q_90' }}"
                                 class="hero-image"
                                 alt="{{ prompt.title }}"
                                 loading="eager">
                        {% endif %}
                    {% else %}
                        <!-- No media available -->
                        <div class="alert alert-warning mb-3" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Media Missing</strong>
                            <p class="mb-2">This prompt is missing its image or video.</p>
                            {% if user.is_authenticated and user == prompt.author %}
                                <a href="{% url 'prompts:prompt_edit' prompt.slug %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Edit Prompt to Add Media
                                </a>
                            {% endif %}
                        </div>
                        <img src="{% static 'images/placeholder-prompt.svg' %}"
                             class="hero-image"
                             alt="{{ prompt.title }} - No image available"
                             loading="eager"
                             style="background-color: #f0f0f0; object-fit: contain;">
                    {% endif %}
                </div>
            </div>

            <!-- Title -->
            <h2 class="prompt-title">
                {{ prompt.title }}
                {% if prompt.is_video %}
                <span class="media-type-indicator">
                    <i class="fas fa-video"></i>
                    Video
                </span>
                {% endif %}
            </h2>

            <!-- Description -->
            {% if prompt.excerpt %}
            <div class="prompt-description">
                <p>{{ prompt.excerpt }}</p>
            </div>
            {% endif %}

        </div>

        <!-- ========================================
             RIGHT RAIL (col-lg-5)
             Starts at SAME level as image
             ======================================== -->
        <div class="col-lg-5 prompt-right-rail">

            <!-- Author Card (PromptHero Style - Two Column Layout) -->
            <div class="rail-card author-details-combined">
                <div class="author-details-row">
                    <!-- First Row: Avatar + Follow Button (flex container) -->
                    <div class="author-first-row">
                        <!-- Left Column: Avatar + Info -->
                        <div class="author-card">
                            <div class="author-avatar">
                                {% if prompt.author.userprofile.avatar and prompt.author.userprofile.avatar.url %}
                                    <img src="{{ prompt.author.userprofile.avatar.url }}"
                                         alt="{{ prompt.author.username }}'s avatar"
                                         class="avatar-img"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                    <span class="avatar-letter" style="display: none;">{{ prompt.author.username|first|upper }}</span>
                                {% else %}
                                    <span class="avatar-letter">{{ prompt.author.username|first|upper }}</span>
                                {% endif %}
                            </div>
                            <div class="author-info">
                                <a href="{% url 'prompts:user_profile' prompt.author.username %}" class="author-name">
                                    @{{ prompt.author.username }}
                                </a>
                                <span class="post-time">{{ prompt.created_on|simple_timesince }}</span>
                            </div>
                        </div>
                        <!-- Right Column: Follow Button -->
                        <div class="author-card-right">
                            {% if user.is_authenticated and user != prompt.author %}
                            <button class="btn-outline-standard follow-btn {% if is_following_author %}following{% endif %}"
                                    data-username="{{ prompt.author.username }}"
                                    data-following="{{ is_following_author|yesno:'true,false' }}"
                                    aria-label="{% if is_following_author %}Unfollow{% else %}Follow{% endif %} {{ prompt.author.username }}">
                                <span class="btn-text">{% if is_following_author %}Following{% else %}Follow{% endif %}</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                            {% elif not user.is_authenticated %}
                            <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-outline-standard follow-btn" aria-label="Log in to follow">
                                Follow
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Views Row (block-level sibling, naturally on new line) -->
                    {% if can_see_views %}
                    <div class="views-row">
                        <span class="views-count" aria-label="Views" title="Views">
                            <i class="fas fa-eye" aria-hidden="true"></i>
                            {{ view_count }} views
                        </span>
                    </div>
                    {% endif %}
                </div>
                <!-- Action Icons Row -->
                <div class="author-card-actions">
                    <!-- Comment Button -->
                    <button class="btn-outline-standard action-icon-btn" onclick="scrollToComments()" aria-label="Scroll to comments" title="Comments">
                        <i class="far fa-comment" aria-hidden="true"></i>
                    </button>

                    <!-- Like Button -->
                    {% if user.is_authenticated %}
                        <button class="btn-outline-standard action-icon-btn {% if prompt_is_liked %}liked{% endif %}"
                                data-prompt-slug="{{ prompt.slug }}"
                                onclick="toggleLike(this)"
                                aria-label="{% if prompt_is_liked %}Unlike{% else %}Like{% endif %}"
                                title="Like">
                            <i class="{% if prompt_is_liked %}fas{% else %}far{% endif %} fa-heart" aria-hidden="true"></i>
                            <span class="action-count like-count">{{ number_of_likes }}</span>
                        </button>
                    {% else %}
                        <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-outline-standard action-icon-btn" aria-label="Log in to like" title="Like">
                            <i class="far fa-heart" aria-hidden="true"></i>
                            <span class="action-count like-count">{{ number_of_likes }}</span>
                        </a>
                    {% endif %}

                    <!-- Edit Button (only for author) -->
                    {% if user.is_authenticated and prompt.author == user %}
                    <a href="{% url 'prompts:prompt_edit' prompt.slug %}" class="btn-outline-standard action-icon-btn" aria-label="Edit" title="Edit">
                        <i class="far fa-edit" aria-hidden="true"></i>
                    </a>

                    <!-- Delete Button (only for author) -->
                    <button class="btn-outline-standard action-icon-btn"
                            onclick="confirmDelete('{% url 'prompts:prompt_delete' prompt.slug %}')"
                            aria-label="Delete" title="Delete">
                        <i class="far fa-trash-alt" aria-hidden="true"></i>
                    </button>
                    {% endif %}

                    <!-- Report Button (authenticated, not author) -->
                    {% if user.is_authenticated and prompt.author != user %}
                    <button class="btn-outline-standard action-icon-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#reportModal"
                            aria-label="Report" title="Report">
                        <i class="far fa-flag" aria-hidden="true"></i>
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- MODEL USED Section (Separate Card) -->
            <div class="rail-card model-used-card">
                <h4 class="rail-card-title">Model Used</h4>
                <div class="model-used-row">
                    <div class="model-used-info">
                        <span class="model-name">
                            <i class="fas fa-robot"></i>
                            {{ prompt.get_ai_generator_display|default:"Not specified" }}
                        </span>
                        <span class="model-type">
                            {% if prompt.is_video %}
                            <i class="fas fa-video"></i>
                            Video
                            {% else %}
                            <i class="fas fa-image"></i>
                            Image
                            {% endif %}
                        </span>
                    </div>
                    {% if prompt.get_generator_url %}
                    <a href="{{ prompt.get_generator_url }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="btn-outline-standard btn-affiliate"
                       aria-label="Try in {{ prompt.get_ai_generator_display }} (opens in new tab)">
                        <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                        Try in {{ prompt.get_ai_generator_display }}
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Prompt Text Card -->
            <div class="rail-card prompt-card">
                <div class="prompt-card-header">
                    <h4 class="rail-card-title">Prompt</h4>
                    {% if user.is_authenticated %}
                    <button class="btn-outline-standard copy-btn" onclick="copyPromptText()" id="copyButton">
                        <i class="far fa-copy"></i>
                        <span id="copyButtonText">Copy</span>
                    </button>
                    {% else %}
                    <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-outline-standard copy-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        Login to Copy
                    </a>
                    {% endif %}
                </div>
                <div class="prompt-text-content" id="promptContent">
                    {{ prompt.content|safe }}
                </div>
            </div>

            <!-- Tags Card -->
            {% if prompt.tags.all %}
            <div class="rail-card">
                <h4 class="rail-card-title">Tags</h4>
                <div class="tags-container">
                    {% for tag in prompt.tags.all %}
                        <span class="tag-badge" data-tag="{{ tag.name }}">{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- More from Author Section (Phase J.2) -->
            <!-- Only show if author has at least 1 other published prompt -->
            {% if more_from_author_count >= 1 %}
            <div class="rail-card more-from-author-card">
                <h4 class="rail-card-title">
                    More from
                    <a href="{% url 'prompts:user_profile' prompt.author.username %}"
                       class="author-link">@{{ prompt.author.username }}</a>
                </h4>
                <div class="more-from-author-thumbnails">
                    {% for author_prompt in more_from_author %}
                    {# Phase J.2 Fix 4: 4th thumbnail gets "+N more" overlay if author has 5+ prompts #}
                    {% if forloop.counter == 4 and author_remaining_count > 0 %}
                    <a href="{% url 'prompts:user_profile' prompt.author.username %}"
                       class="author-thumbnail-link author-thumbnail-more"
                       aria-label="See all prompts from {{ prompt.author.username }}">
                        <div class="author-thumbnail-wrapper">
                            {% if author_prompt.featured_image %}
                            <img src="{{ author_prompt.featured_image.url }}"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy">
                            {% else %}
                            <img src="{{ author_prompt.get_thumbnail_url }}"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy">
                            {% endif %}
                            <div class="author-thumbnail-count-overlay">
                                <span class="author-more-count">+{{ author_remaining_count }}</span>
                                <span class="author-more-text">See all prompts</span>
                            </div>
                        </div>
                    </a>
                    {% else %}
                    <a href="{% url 'prompts:prompt_detail' author_prompt.slug %}"
                       class="author-thumbnail-link"
                       aria-label="View {{ author_prompt.title }}">
                        <div class="author-thumbnail-wrapper">
                            {# Phase J.3: Video thumbnails get play icon and hover autoplay #}
                            {% if author_prompt.is_video %}
                            <div class="video-thumbnail-container">
                                <img src="{{ author_prompt.get_thumbnail_url }}"
                                     alt="{{ author_prompt.title }}"
                                     class="author-thumbnail"
                                     loading="lazy">
                                <video class="thumbnail-video" muted loop playsinline preload="none">
                                    <source src="{{ author_prompt.get_video_url }}" type="video/mp4">
                                </video>
                                <div class="play-icon-overlay" aria-hidden="true">
                                    <svg class="play-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="24" fill="rgba(0,0,0,0.6)"/>
                                        <path d="M20 16L32 24L20 32V16Z" fill="white"/>
                                    </svg>
                                </div>
                                <div class="author-thumbnail-overlay" aria-hidden="true"></div>
                            </div>
                            {% elif author_prompt.featured_image %}
                            <img src="{{ author_prompt.featured_image.url }}"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy">
                            <div class="author-thumbnail-overlay" aria-hidden="true"></div>
                            {% else %}
                            <img src="{{ author_prompt.get_thumbnail_url }}"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy">
                            <div class="author-thumbnail-overlay" aria-hidden="true"></div>
                            {% endif %}
                        </div>
                    </a>
                    {% endif %}
                    {% endfor %}
                    {# Phase J.2 Fix 3: Add grey placeholders for empty slots #}
                    {% if more_from_author_count == 1 %}
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    {% elif more_from_author_count == 2 %}
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    {% elif more_from_author_count == 3 %}
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        </div>

        <!-- ========================================
             COMMENTS SECTION (col-12)
             Full width, appears after right rail on mobile
             ======================================== -->
        <div class="col-12 comments-column">
            <div class="comments-section" id="comments">
                <h3 class="section-title">Comments ({{ comment_count }})</h3>

                <!-- Comment Form (Authenticated Users) -->
                {% if user.is_authenticated %}
                <div class="comment-form-wrapper mb-4">
                    {% load crispy_forms_tags %}
                    <form id="commentForm" method="post" class="comment-form">
                        {% csrf_token %}
                        {{ comment_form|crispy }}
                        <button id="submitButton" type="submit" class="btn btn-primary mt-3">Submit Comment</button>
                    </form>
                </div>
                {% else %}
                <div class="login-prompt mb-4">
                    <p><a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a> to leave a comment.</p>
                </div>
                {% endif %}

                <!-- Comments List -->
                <div class="comments-list">
                    {% for comment in comments %}
                        <div class="comment-card p-3 mb-3
                            {% if not comment.approved and comment.author == user %}
                                border border-warning faded
                            {% endif %}">
                            <p class="font-weight-bold comment-author">
                                By <a href="{% url 'prompts:user_profile' comment.author.username %}"
                                      class="text-decoration-none text-dark profile-link">
                                    {{ comment.author }}
                                </a>
                                <span class="font-weight-normal text-muted">
                                    on {{ comment.created_on }}
                                </span>
                            </p>
                            {% if not comment.approved and comment.author == user %}
                                <p class="approval">This comment is awaiting approval</p>
                            {% endif %}
                            <div id="comment{{ comment.id }}">
                                {{ comment.body | linebreaks }}
                            </div>
                            {% if user.is_authenticated and comment.author == user %}
                            <div class="mt-2 d-flex gap-2 mt-4">
                                <button class="btn btn-small btn-primary" onclick="toggleEditForm({{ comment.id }})">
                                    <i class="fas fa-edit"></i>&nbsp; Edit
                                </button>
                                <button type="button" class="btn btn-small btn-primary"
                                        onclick="confirmDelete('{% url 'prompts:comment_delete' prompt.slug comment.id %}')">
                                    <i class="fas fa-trash"></i>&nbsp; Delete
                                </button>

                                <!-- Hidden inline edit form -->
                                <div id="editForm{{ comment.id }}" style="display: none;" class="mt-3">
                                    <form method="post" action="{% url 'prompts:comment_edit' prompt.slug comment.id %}">
                                        {% csrf_token %}
                                        <div class="mb-2">
                                            <textarea name="body" class="form-control" rows="3" required>{{ comment.body }}</textarea>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-save"></i> Update
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEditForm({{ comment.id }})">
                                                <i class="fas fa-times"></i> Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="no-comments">
                            <p class="text-center text-muted">No comments yet. Be the first to share your thoughts!</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to move this prompt to trash?</p>
                <div class="alert alert-info mt-3" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> This prompt will be moved to your trash bin and kept for 5 days (free) or 30 days (premium) before permanent deletion. You can restore it anytime from your trash.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>&nbsp; Cancel
                </button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i>&nbsp; Delete
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Report Prompt Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-flag me-2"></i>Report Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm" method="post" action="{% url 'prompts:report_prompt' prompt.slug %}">
                    {% csrf_token %}

                    <!-- Reason Selection -->
                    <div class="mb-3">
                        <label for="id_reason" class="form-label fw-bold">
                            <i class="fas fa-exclamation-triangle me-1"></i> Reason for Reporting *
                        </label>
                        <select name="reason" id="id_reason" class="form-control form-select" required>
                            <option value="">-- Select a reason --</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="copyright">Copyright Violation</option>
                            <option value="harassment">Harassment or Bullying</option>
                            <option value="other">Other</option>
                        </select>
                        <small class="form-text text-muted">Select the reason that best describes the issue</small>
                    </div>

                    <!-- Additional Comment -->
                    <div class="mb-3">
                        <label for="id_comment" class="form-label fw-bold">
                            <i class="fas fa-comment me-1"></i> Additional Details (Optional)
                        </label>
                        <textarea name="comment" id="id_comment" class="form-control"
                                  rows="4" maxlength="1000"
                                  placeholder="Please provide additional context to help us review this report..."></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>Provide context to help us review (max 1000 characters)
                            </small>
                            <small id="comment-counter" class="text-muted fw-bold">0 / 1000</small>
                        </div>
                    </div>

                    <!-- Error Display Area -->
                    <div id="reportError" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="reportErrorMessage"></span>
                    </div>

                    <!-- Success Display Area -->
                    <div id="reportSuccess" class="alert alert-success d-none" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="reportSuccessMessage"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="submit" form="reportForm" class="btn btn-danger" id="submitReportBtn">
                    <i class="fas fa-flag me-1"></i> Submit Report
                </button>
            </div>
        </div>
    </div>
</div>
</div><!-- .prompt-detail-page -->

{% endblock content %}

{% block extras %}
<!-- Prompt Detail Page JavaScript (extracted to external file) -->
<script src="{% static 'js/prompt-detail.js' %}"></script>
{% endblock %}

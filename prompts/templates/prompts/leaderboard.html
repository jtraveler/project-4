{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Leaderboard - Top Creators | PromptFinder{% endblock %}

{% block meta_description %}
Discover the most popular content creators on PromptFinder. See who has the most views, likes, and activity in our AI prompt community.
{% endblock %}

{% block extra_head %}
<!-- Schema.org structured data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Leaderboard - Top Creators",
  "description": "Discover the most popular content creators on PromptFinder ranked by views and activity.",
  "url": "{{ request.build_absolute_uri }}",
  "publisher": {
    "@type": "Organization",
    "name": "PromptFinder",
    "url": "https://promptfinder.net"
  }
}
</script>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="leaderboard-page">
    <!-- Header -->
    <div class="leaderboard-header">
        <h1 class="leaderboard-title">Leaderboard</h1>
        <p class="leaderboard-subtitle">
            Members with the most
            {% if current_tab == 'viewed' %}views{% else %}activity{% endif %}
            {% if current_period == 'week' %}this week{% elif current_period == 'month' %}this month{% else %}of all time{% endif %}
        </p>
    </div>

    <!-- Tabs and Filter Row -->
    <div class="leaderboard-controls">
        <div class="leaderboard-tabs" role="tablist" aria-label="Leaderboard type">
            <a href="?tab=viewed&period={{ current_period }}"
               class="leaderboard-tab {% if current_tab == 'viewed' %}active{% endif %}"
               role="tab"
               aria-selected="{% if current_tab == 'viewed' %}true{% else %}false{% endif %}"
               aria-controls="leaderboard-list">
                Most Viewed
            </a>
            <a href="?tab=active&period={{ current_period }}"
               class="leaderboard-tab {% if current_tab == 'active' %}active{% endif %}"
               role="tab"
               aria-selected="{% if current_tab == 'active' %}true{% else %}false{% endif %}"
               aria-controls="leaderboard-list">
                Most Active
            </a>
        </div>

        <div class="period-dropdown" id="periodDropdown">
            <button class="period-dropdown-btn" id="periodDropdownBtn" aria-haspopup="true" aria-expanded="false" aria-label="Select time period">
                {% if current_period == 'week' %}This Week{% elif current_period == 'month' %}This Month{% else %}All Time{% endif %}
                <svg class="period-dropdown-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="period-dropdown-menu" id="periodDropdownMenu" role="menu">
                {% for value, label in period_choices %}
                <a href="?tab={{ current_tab }}&period={{ value }}"
                   class="period-dropdown-item {% if current_period == value %}active{% endif %}"
                   role="menuitem">
                    {% if current_period == value %}
                    <svg class="period-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {% else %}
                    <span style="width: 16px; display: inline-block;"></span>
                    {% endif %}
                    {{ label }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Leaderboard List -->
    <div class="leaderboard-list" id="leaderboard-list" role="tabpanel">
        {% for creator in creators %}
        <div class="leaderboard-row">
            <span class="leaderboard-rank">{{ forloop.counter }}</span>

            <div class="leaderboard-user">
                <a href="{% url 'prompts:user_profile' creator.username %}" class="user-avatar-link">
                    {% if creator.userprofile.avatar and creator.userprofile.avatar.url %}
                    <img src="{{ creator.userprofile.avatar.url }}"
                         alt="{{ creator.username }}'s avatar"
                         class="leaderboard-avatar"
                         loading="lazy"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="leaderboard-avatar-placeholder" style="display: none; background: var(--avatar-gradient-{{ creator.userprofile.get_avatar_color_index }}, var(--main-blue));">
                        {{ creator.username|first|upper }}
                    </div>
                    {% else %}
                    <div class="leaderboard-avatar-placeholder"
                         style="background: var(--avatar-gradient-{{ creator.userprofile.get_avatar_color_index }}, var(--main-blue));">
                        {{ creator.username|first|upper }}
                    </div>
                    {% endif %}
                </a>

                <div class="leaderboard-user-info">
                    {# Round 3 Fix 2: Wrapper for username + stats for mobile flexbox layout #}
                    <div class="user-name-and-stats">
                        <a href="{% url 'prompts:user_profile' creator.username %}" class="leaderboard-username">
                            {{ creator.username }}
                        </a>
                        <div class="leaderboard-stats">
                            {% if current_tab == 'viewed' %}
                            <i class="fas fa-eye" aria-hidden="true"></i>
                            <span>{{ creator.total_views|intcomma }} view{{ creator.total_views|pluralize }}</span>
                            {% else %}
                            <i class="fas fa-bolt" aria-hidden="true"></i>
                            <span>{{ creator.activity_score|intcomma }} points</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if user.is_authenticated and user != creator %}
                    <button class="leaderboard-follow-btn {% if creator.is_following %}following{% endif %}"
                            data-username="{{ creator.username }}"
                            data-following="{{ creator.is_following|yesno:'true,false' }}"
                            aria-label="{% if creator.is_following %}Unfollow{% else %}Follow{% endif %} {{ creator.username }}">
                        <span class="btn-text">{% if creator.is_following %}Following{% else %}Follow{% endif %}</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    {% endif %}
                </div>
            </div>

            {# Task 2: Mobile helper text above thumbnails #}
            <p class="leaderboard-thumbnails-hint">Click the thumbnails below to visit user's profile</p>

            {# Single link wrapping all thumbnails - goes to user profile #}
            <a href="{% url 'prompts:user_profile' creator.username %}"
               class="leaderboard-thumbnails-link"
               aria-label="View all {{ creator.prompt_count }} prompts by {{ creator.username }}">
                <div class="leaderboard-thumbnails">
                    {% for prompt in creator.thumbnails %}
                    {% if forloop.counter <= 3 %}
                    {# Round 8: Thumbnails 1-3 - always visible with hover overlay #}
                    <div class="leaderboard-thumbnail-wrapper">
                        <img src="{% if prompt.featured_image %}{{ prompt.featured_image.url }}{% else %}{{ prompt.get_thumbnail_url }}{% endif %}"
                             alt="{{ prompt.title }}"
                             class="leaderboard-thumbnail"
                             loading="lazy">
                        <div class="thumbnail-hover-overlay" aria-hidden="true"></div>
                    </div>
                    {% elif forloop.counter == 4 %}
                    {# Round 8: 4th thumbnail - overlay on narrow screens, normal on wide when 5th exists #}
                    <div class="leaderboard-thumbnail-wrapper thumbnail-4th {% if creator.remaining_count > 0 %}has-more{% endif %}">
                        <img src="{% if prompt.featured_image %}{{ prompt.featured_image.url }}{% else %}{{ prompt.get_thumbnail_url }}{% endif %}"
                             alt="{{ prompt.title }}"
                             class="leaderboard-thumbnail"
                             loading="lazy">
                        <div class="thumbnail-hover-overlay" aria-hidden="true"></div>
                        {% if creator.remaining_count > 0 %}
                        <div class="thumbnail-overlay thumbnail-overlay-4th">
                            <div class="thumbnail-overlay-content">
                                <span class="thumbnail-overlay-text">+{{ creator.remaining_count|intcomma }}</span>
                                <span class="thumbnail-overlay-subtext">See all prompts</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% elif forloop.counter == 5 and creator.remaining_count > 0 %}
                    {# Round 8: 5th thumbnail - only visible on wide desktop (>1700px) with overlay #}
                    <div class="leaderboard-thumbnail-wrapper thumbnail-overlay-container thumbnail-5th">
                        <img src="{% if prompt.featured_image %}{{ prompt.featured_image.url }}{% else %}{{ prompt.get_thumbnail_url }}{% endif %}"
                             alt="{{ prompt.title }}"
                             class="leaderboard-thumbnail"
                             loading="lazy">
                        <div class="thumbnail-overlay">
                            <div class="thumbnail-overlay-content">
                                <span class="thumbnail-overlay-text">+{{ creator.remaining_count|intcomma }}</span>
                                <span class="thumbnail-overlay-subtext">See all prompts</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </a>
        </div>
        {% empty %}
        <div class="leaderboard-empty">
            <i class="fas fa-users"></i>
            <p>No creators found for this time period.</p>
            <p class="text-muted">Try selecting a longer time period or check back later.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
(function() {
    'use strict';

    // Period dropdown functionality
    const periodDropdown = document.getElementById('periodDropdown');
    const periodDropdownBtn = document.getElementById('periodDropdownBtn');

    if (periodDropdown && periodDropdownBtn) {
        // Toggle dropdown on button click
        periodDropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            periodDropdown.classList.toggle('open');
            const isOpen = periodDropdown.classList.contains('open');
            periodDropdownBtn.setAttribute('aria-expanded', isOpen);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!periodDropdown.contains(e.target)) {
                periodDropdown.classList.remove('open');
                periodDropdownBtn.setAttribute('aria-expanded', 'false');
            }
        });

        // Close dropdown on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && periodDropdown.classList.contains('open')) {
                periodDropdown.classList.remove('open');
                periodDropdownBtn.setAttribute('aria-expanded', 'false');
                periodDropdownBtn.focus();
            }
        });
    }

    // Follow button handlers (event delegation)
    const leaderboardList = document.getElementById('leaderboard-list');
    if (leaderboardList) {
        leaderboardList.addEventListener('click', function(event) {
            const btn = event.target.closest('.leaderboard-follow-btn');
            if (!btn || btn.disabled) return;

            event.preventDefault();
            const username = btn.dataset.username;
            const isFollowing = btn.dataset.following === 'true';
            const spinner = btn.querySelector('.spinner-border');
            const btnText = btn.querySelector('.btn-text');

            // Disable button and show spinner
            btn.disabled = true;
            spinner.classList.remove('d-none');

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                              document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

            if (!csrfToken) {
                console.error('CSRF token not found');
                btn.disabled = false;
                spinner.classList.add('d-none');
                return;
            }

            const url = isFollowing
                ? `/users/${username}/unfollow/`
                : `/users/${username}/follow/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Toggle state
                    const newFollowing = !isFollowing;
                    btn.dataset.following = newFollowing.toString();
                    btnText.textContent = newFollowing ? 'Following' : 'Follow';
                    btn.classList.toggle('following', newFollowing);
                } else {
                    console.error('Follow action failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                btn.disabled = false;
                spinner.classList.add('d-none');
            });
        });

        // Hover effects for following buttons
        leaderboardList.addEventListener('mouseenter', function(event) {
            const btn = event.target.closest('.leaderboard-follow-btn.following');
            if (btn) {
                btn.querySelector('.btn-text').textContent = 'Unfollow';
                btn.classList.add('hover-unfollow');
            }
        }, true);

        leaderboardList.addEventListener('mouseleave', function(event) {
            const btn = event.target.closest('.leaderboard-follow-btn.following');
            if (btn) {
                btn.querySelector('.btn-text').textContent = 'Following';
                btn.classList.remove('hover-unfollow');
            }
        }, true);
    }
})();
</script>
{% endblock %}

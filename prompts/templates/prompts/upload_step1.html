{% extends "base.html" %}
{% load static %}

{% block content %}
<script>
    // Pass Django URLs to JavaScript
    document.body.dataset.uploadStep1Url = "{% url 'prompts:upload_step1' %}";
</script>

<!-- L8-ERRORS: Alert container positioned at TOP for visibility -->
<div id="top-alert-container" class="container" style="margin-top: 1rem; margin-bottom: 0;">
    <!-- Dynamic error alerts will be inserted here by JavaScript -->
</div>

<div class="container mt-5 mb-5">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="h3 mb-3" style="font-weight: 400; color: #1f2937;">
            Share your prompts and let the world discover them
        </h1>
        <p class="text-muted mb-5" style="font-size: 16px; color: #6b7280;">
            Share your first 10 prompts to introduce yourself to millions of Prompt Finders.
        </p>
    </div>

    <!-- Spacing -->
    <div class="mb-5"></div>

    <!-- CSRF token for AJAX requests -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <!-- Drag-drop upload area -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="drop-zone"
                 class="border border-2 rounded-3 p-5 text-center"
                 style="
                     min-height: 400px;
                     cursor: pointer;
                     transition: all 0.3s;
                     border-style: dashed !important;
                     border-color: #d1d5db !important;
                     background-color: #fafafa;
                     position: relative;
                 ">
                <!-- Upload counter in top-right -->
                <div style="position: absolute; top: 20px; right: 20px;">
                    <span style="color: var(--gray-400); font-size: 14px;">({{ uploads_this_week }}/{{ weekly_limit }})</span>
                </div>

                <div class="my-5">
                    <!-- Font Awesome icon -->
                    <div class="mb-4">
                        <i class="fas fa-images" style="font-size: 80px; color: #05a081;"></i>
                    </div>

                    <h3 class="mb-3" style="font-weight: 400; color: #1f2937; font-size: 24px;">
                        Drag and drop to upload, or
                    </h3>
                    <button type="button" class="btn btn-lg" id="browse-btn"
                            style="
                                background-color: #05a081;
                                color: white;
                                border: none;
                                padding: 12px 32px;
                                border-radius: 8px;
                                font-weight: 500;
                            ">
                        Browse
                    </button>
                    <input type="file" id="file-input" accept="image/*,video/*" style="display:none;">

                    <p class="text-muted mt-3 small" style="color: #6b7280;">
                        (You have <strong>{{ uploads_remaining }}</strong> upload{{ uploads_remaining|pluralize }} left for the day)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced 5-Step Progress Indicator -->
    <div id="upload-progress" class="mt-4" style="display:none;">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- Step Indicators -->
                <div class="progress-steps">
                    <div class="progress-step" data-step="1">
                        <div class="step-dot"></div>
                        <span class="step-label">Analyze</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-dot"></div>
                        <span class="step-label">Prepare</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-dot"></div>
                        <span class="step-label">Tags</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-dot"></div>
                        <span class="step-label">Upload</span>
                    </div>
                    <div class="progress-step" data-step="5">
                        <div class="step-dot"></div>
                        <span class="step-label">Finalize</span>
                    </div>
                </div>

                <!-- Status Message -->
                <div class="progress-status text-center mt-4" role="status" aria-live="polite">
                    <h4 id="progress-message" class="mb-2">Preparing your upload...</h4>
                    <p id="progress-detail" class="text-muted mb-0" aria-live="polite">Please wait</p>
                </div>

                <!-- Upload Progress Bar (shown during B2 upload) -->
                <div id="upload-bar-container" class="mt-3" style="display:none;">
                    <div class="progress" style="height: 8px; border-radius: 4px;">
                        <div class="progress-bar"
                             role="progressbar"
                             style="width: 0%; background-color: #05a081; transition: width 0.3s ease;"
                             id="progress-bar"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                    <p class="text-center mt-2 mb-0">
                        <span id="progress-percent">0%</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Step Styles -->
    <style>
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            padding: 0 10px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 30px;
            right: 30px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            flex: 1;
            max-width: 80px;
        }

        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e0e0e0;
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .step-dot::after {
            content: '';
            font-size: 12px;
            color: white;
        }

        .step-label {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            text-align: center;
            transition: color 0.3s ease;
        }

        /* Active step - pulsing animation */
        .progress-step.active .step-dot {
            background-color: #05a081;
            border-color: #05a081;
            animation: pulse 1.5s infinite;
        }

        .progress-step.active .step-label {
            color: #05a081;
            font-weight: 500;
        }

        /* Completed step - checkmark */
        .progress-step.completed .step-dot {
            background-color: #05a081;
            border-color: #05a081;
            animation: none;
        }

        .progress-step.completed .step-dot::after {
            content: '✓';
        }

        .progress-step.completed .step-label {
            color: #05a081;
        }

        /* Error state */
        .progress-step.error .step-dot {
            background-color: #dc3545;
            border-color: #dc3545;
            animation: none;
        }

        .progress-step.error .step-dot::after {
            content: '✕';
        }

        .progress-step.error .step-label {
            color: #dc3545;
        }

        /* Pulse animation for active step */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(5, 160, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(5, 160, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(5, 160, 129, 0);
            }
        }

        .progress-status.error #progress-message {
            color: #dc3545;
        }

        /* Mobile responsive */
        @media (max-width: 576px) {
            .step-label {
                font-size: 9px;
            }
            .step-dot {
                width: 20px;
                height: 20px;
            }
            .progress-steps::before {
                top: 10px;
            }
        }

        /* L8-PROGRESS-ANIMATE: Fade transition for rotating messages */
        #progress-detail {
            transition: opacity 0.3s ease-in-out;
        }

        #progress-detail.fading {
            opacity: 0;
        }
    </style>

    <!-- Spacing -->
    <div class="mb-5"></div>

    <!-- Guidelines in 3 columns -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-10">
            <div class="row">
                <!-- Column 1 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Original content you created or have rights to
                        </li>
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Excludes nudity, violence, or hate
                        </li>
                    </ul>
                </div>

                <!-- Column 2 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Mindful of the rights of others
                        </li>
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Free to use for the community
                        </li>
                    </ul>
                </div>

                <!-- Column 3 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            High quality images and videos
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Skip upload link -->
    <div class="text-center mt-4">
        <a href="/"
           style="color: #6b7280; text-decoration: none; font-size: 15px;">
            Skip upload
        </a>
    </div>
</div>

<script>
// Style Django error messages to match upload errors
document.addEventListener('DOMContentLoaded', function() {
    const djangoAlert = document.querySelector('.alert.alert-error, .alert.alert-danger');
    if (djangoAlert && !djangoAlert.querySelector('.fa-exclamation-circle')) {
        const message = djangoAlert.textContent.trim();
        djangoAlert.innerHTML = `
            <strong><i class="fas fa-exclamation-circle me-2"></i>Upload Error</strong>
            <p class="mb-0 mt-1">${message}</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
    }
});
</script>

<!-- Upload Step 1 JavaScript (extracted for maintainability) -->
<script src="{% static 'js/upload-step1.js' %}"></script>
{% endblock %}

{# prompts/templates/prompts/partials/_prompt_card.html #}
{# Shared template for prompt cards site-wide #}
{# Usage: {% include 'prompts/partials/_prompt_card.html' with prompt=prompt show_trash_actions=False %} #}
{% load cloudinary %}
{% load cloudinary_tags %}
{% load static %}

{% if show_trash_actions %}
    {# === TRASH BIN CARD === #}
    <div class="col-md-4 mb-4">
        <div class="card h-100 {% if prompt.is_expiring_soon %}border-danger{% endif %}">
            {# Thumbnail with video handling #}
            <div class="position-relative">
                {% if prompt.featured_video %}
                    <img src="{{ prompt.get_thumbnail_url }}"
                         alt="{{ prompt.title }}"
                         class="card-img-top"
                         style="height: 300px; object-fit: cover;">
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <i class="fas fa-play-circle fa-3x text-white" style="opacity: 0.8;"></i>
                    </div>
                {% elif prompt.featured_image %}
                    {% cloudinary prompt.featured_image.public_id format="jpg" width=400 height=300 crop="fill" class="card-img-top" style="height: 300px; object-fit: cover;" %}
                {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 300px;">
                        <i class="fas fa-image fa-3x text-white"></i>
                    </div>
                {% endif %}
            </div>

            <div class="card-body">
                <h5 class="card-title">{{ prompt.title|truncatewords:10 }}</h5>

                <p class="text-muted small mb-2">
                    <i class="far fa-clock"></i> Deleted {{ prompt.deleted_at|timesince }} ago
                </p>

                {% if prompt.is_expiring_soon %}
                    <div class="alert alert-danger py-1 px-2 small mb-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Expires in {{ prompt.days_until_permanent_deletion }} day(s)!</strong>
                    </div>
                {% else %}
                    <p class="text-muted small mb-2">
                        <i class="fas fa-hourglass-half"></i>
                        {{ prompt.days_until_permanent_deletion }} days remaining
                    </p>
                {% endif %}

                <div class="d-flex gap-2">
                    <form method="post" action="{% url 'prompts:prompt_restore' prompt.slug %}" class="flex-grow-1">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <i class="fas fa-undo"></i> Restore
                        </button>
                    </form>
                    <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{ prompt.id }}">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Delete Forever Modal #}
    <div class="modal fade" id="deleteModal{{ prompt.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ prompt.id }}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger" id="deleteModalLabel{{ prompt.id }}">
                        <i class="fas fa-exclamation-triangle"></i> Delete Forever?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Permanently delete <strong>"{{ prompt.title }}"</strong>?</p>
                    <div class="alert alert-danger mb-0">
                        <strong>Warning:</strong> This action cannot be undone. The image/video will be permanently removed from Cloudinary.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'prompts:prompt_permanent_delete' prompt.slug %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg> Delete Forever
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% else %}
    {# === HOMEPAGE MASONRY ITEM (Keep exact structure) === #}
    <div class="masonry-item"
         data-item
         {% if prompt.is_video %}data-video="true"{% endif %}
         data-order="{{ prompt.order }}"
         data-slug="{{ prompt.slug }}">
        <div class="prompt-card {% if prompt.is_video %}video-card{% endif %}">

            {# Admin Controls (only for staff AND when show_admin_controls=True) #}
            {% if user.is_staff and show_admin_controls %}
            <div class="drag-handle" title="Drag to reorder">
                <i class="fas fa-grip-horizontal"></i>
            </div>
            <div class="admin-overlay">
                <a href="{% url 'prompts:prompt_move_up' prompt.slug %}" class="btn btn-sm" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </a>
                <a href="{% url 'prompts:prompt_move_down' prompt.slug %}" class="btn btn-sm" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </a>
            </div>
            <div class="order-display" style="display: none;">
                {{ prompt.order }}
            </div>
            {% endif %}

            <div class="image-wrapper">
                {% if prompt.is_video %}
                    <!-- Video element (hidden initially) -->
                    <video class="gallery-video"
                           muted
                           loop
                           playsinline
                           preload="none"
                           width="440"
                           height="auto"
                           data-src="{{ prompt.get_video_url }}">
                        <source data-src="{{ prompt.get_video_url }}" type="video/mp4">
                    </video>

                    <!-- Video thumbnail -->
                    <img class="video-thumbnail"
                         src="{{ prompt.get_thumbnail_url }}"
                         alt="{{ prompt.title }}"
                         width="440"
                         height="auto"
                         {% if forloop.first %}loading="eager"{% else %}loading="lazy"{% endif %}
                         decoding="async">

                    <!-- Play icon overlay -->
                    <div class="video-play-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                {% else %}
                    <!-- Regular image -->
                    {% if prompt.featured_image %}
                        {% if "placeholder" in prompt.featured_image.url %}
                            <img src="{% static 'images/placeholder-prompt.svg' %}"
                                 alt="{{ prompt.title }} - No image available"
                                 width="440"
                                 height="300"
                                 loading="lazy"
                                 class="placeholder-image">
                        {% else %}
                            <img src="{{ prompt.featured_image.url|cloudinary_transform:'w_440,f_webp,q_90' }}"
                                 alt="{{ prompt.title }}"
                                 width="440"
                                 height="584"
                                 {% if forloop.first %}loading="eager"{% else %}loading="lazy"{% endif %}
                                 decoding="async">
                        {% endif %}
                    {% else %}
                        <!-- No media at all - show placeholder -->
                        <img src="{% static 'images/placeholder-prompt.svg' %}"
                             alt="{{ prompt.title }} - No image available"
                             width="440"
                             height="300"
                             loading="lazy"
                             class="placeholder-image">
                    {% endif %}
                {% endif %}

                {# Draft Status Indicator - Fixed to not block clicks #}
                {% if prompt.status == 0 %}
                <div class="draft-indicator position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                     style="background: rgba(0,0,0,0.7); z-index: 1; pointer-events: none;">
                    <span class="badge bg-warning text-dark fs-6" style="pointer-events: auto; z-index: 2;">DRAFT</span>
                </div>
                <style>
                    /* Ensure card links work through overlay */
                    .card .card-link { position: relative; z-index: 3; }
                    .card a { position: relative; z-index: 3; }
                </style>
                {% endif %}

                {# View Count Badge (Phase G Part B) - Top Left Corner #}
                {% if can_see_views or view_visibility == 'author' and user == prompt.author %}
                <div class="view-count-badge">
                    <i class="fas fa-eye"></i>
                    <span>{{ prompt.views_count|default:0 }}</span>
                </div>
                {% endif %}

                <!-- Overlay with user info, platform, and heart -->
                <div class="card-overlay">
                    <div class="overlay-top">
                        <span class="user-info">
                            <a href="{% url 'prompts:user_profile' prompt.author.username %}"
                               class="text-reset text-decoration-none profile-link">
                                @{{ prompt.author }}
                            </a>
                        </span>
                    </div>
                    <div class="overlay-bottom">
                        <span class="platform-info">
                            <i class="fas fa-user"></i>
                            <a href="{% url 'prompts:user_profile' prompt.author.username %}"
                               class="text-reset text-decoration-none profile-link">
                                {{ prompt.author }}
                            </a>
                        </span>
                        <span class="heart-counter">
                            {% if user.is_authenticated %}
                                <small class="like-section{% if user in prompt.likes.all %} liked{% endif %}"
                                       data-prompt-slug="{{ prompt.slug }}"
                                       style="cursor: pointer; user-select: none;">
                                    {% if user in prompt.likes.all %}
                                        <svg class="icon icon-sm heart-icon liked me-1" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-heart"/></svg>
                                    {% else %}
                                        <svg class="icon icon-sm heart-icon me-1" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-heart"/></svg>
                                    {% endif %}
                                    <span class="like-count">{{ prompt.number_of_likes }}</span>
                                    like<span class="like-plural">{% if prompt.number_of_likes != 1 %}s{% endif %}</span>
                                </small>
                            {% else %}
                                <a href="{% url 'account_login' %}?next={{ request.path }}"
                                   class="text-decoration-none"
                                   style="color: white;">
                                    <small>
                                        <svg class="icon icon-sm heart-icon me-1" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-heart"/></svg>
                                        <span>{{ prompt.number_of_likes }}</span>
                                        like{% if prompt.number_of_likes != 1 %}s{% endif %}
                                    </small>
                                </a>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Clickable link overlay -->
            <a href="{% url 'prompts:prompt_detail' prompt.slug %}" class="card-link" aria-label="View {{ prompt.title }} details"></a>

            <!-- Hidden tags for filtering -->
            <div class="hidden-tags" style="display: none;">
                {% for tag in prompt.tags.all %}
                    <span class="tag-clickable" data-tag="{{ tag.name }}">{{ tag.name }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
{% endif %}

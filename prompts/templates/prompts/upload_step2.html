{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<style>
/* Fade-in animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

.upload-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
}

/* New wrapper for image + form (Pexels-style layout) */
.preview-and-form {
    display: flex;
    gap: 50px;
    padding: 50px 80px;
    background-color: #f8f9fa;
    border-radius: 20px;
}

/* Responsive stacking */
@media (max-width: 992px) {
    .preview-and-form {
        flex-direction: column;
        padding: 30px 20px;
        gap: 30px;
    }
}

.image-preview-container {
    display: flex;
    justify-content: center;
    flex: 1;
    max-width: 60%;
}

.image-preview {
    max-height: 680px;
    object-fit: contain;
    border-radius: 12px;
}

@media (max-width: 992px) {
    .image-preview-container {
        max-width: 100%;
    }
}

.form-container {
    flex: 1;
    max-width: 40%;
    background-color: transparent;
    box-shadow: none;
    padding: 0;
}

@media (max-width: 992px) {
    .form-container {
        max-width: 100%;
    }
}

.form-label {
    color: #1f2937;
    font-weight: 500;
    font-size: 15px;
    margin-bottom: 8px;
}

.form-control, .form-select {
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px;
    font-size: 15px;
}

.form-control:focus, .form-select:focus {
    border-color: #05a081;
    box-shadow: 0 0 0 3px rgba(5, 160, 129, 0.1);
    outline: none;
}

.tag-pill {
    display: inline-block;
    padding: 8px 16px;
    margin: 4px;
    background-color: #e5e7eb;
    border-radius: 20px;
    font-size: 14px;
    color: #374151;
}

.tag-pill .remove-tag {
    margin-left: 8px;
    color: #9ca3af;
    cursor: pointer;
    font-weight: bold;
}

.tag-pill .remove-tag:hover {
    color: #ef4444;
}

#tag-autocomplete {
    position: absolute;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: 4px;
}

.autocomplete-item {
    padding: 12px;
    cursor: pointer;
    font-size: 14px;
    color: #374151;
}

.autocomplete-item:hover {
    background-color: #f3f4f6;
}

.submit-section {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 30px;
    gap: 20px;
}

.btn-submit {
    background-color: #05a081;
    color: white;
    border: none;
    padding: 12px 40px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-submit:hover {
    background-color: #048a6f;
}

.btn-delete {
    background-color: transparent;
    color: #ef4444;
    border: 1px solid #ef4444;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-delete:hover {
    background-color: #fef2f2;
}

.helper-text {
    font-size: 13px;
    color: #6b7280;
    margin-top: 6px;
}
</style>
{% endblock %}

{% block content %}
<div class="upload-container fade-in">
    <!-- Warning Banner (before header) -->
    {% if image_warning %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert" style="margin-bottom: 30px;">
        {{ image_warning|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="text-center mb-5">
        <a href="{% url 'prompts:upload_step1' %}" style="color: #6b7280; text-decoration: none; font-size: 14px;">
            <i class="fas fa-arrow-left me-2"></i> Back
        </a>
        <h1 class="mt-3" style="font-size: 28px; font-weight: 400; color: #1f2937;">
            Make your prompts easy to find and be seen
        </h1>
        <p class="text-muted" style="font-size: 16px; color: #6b7280;">
            Add keywords that describe your prompt
        </p>
    </div>

    <!-- Video Upload Info -->
    {% if resource_type == 'video' %}
    <div class="alert alert-info mb-4" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Video Upload:</strong> Please manually enter your prompt content and select relevant tags from the 209 available options.
    </div>
    {% endif %}

    <!-- Image Preview + Form Wrapper -->
    <div class="preview-and-form">
        <!-- Image Preview -->
        <div class="image-preview-container">
            {% if resource_type == 'video' %}
                <video src="{{ secure_url }}" class="image-preview" controls></video>
            {% else %}
                <img src="{{ secure_url }}" class="image-preview" alt="Uploaded preview">
            {% endif %}
        </div>

        <!-- Form -->
        <div class="form-container">
            <form method="post" action="{% url 'prompts:upload_submit' %}" id="upload-form">
            {% csrf_token %}
            <input type="hidden" name="cloudinary_id" value="{{ cloudinary_id }}">
            <input type="hidden" name="resource_type" value="{{ resource_type }}">
            <input type="hidden" name="tags" id="tags-hidden">

            <!-- Tags -->
            <div class="mb-4">
                <label class="form-label">
                    Tags <span style="color: #9ca3af;">(optional)</span>
                </label>
                <p class="helper-text mb-2">
                    {% if resource_type == 'video' %}Add relevant tags to describe your video{% else %}Suggested tags (you can edit or add your own){% endif %}
                </p>
                <div id="tags-container" class="mb-3">
                    {% for tag in ai_tags %}
                    <span class="tag-pill" data-tag="{{ tag }}">
                        {{ tag }}
                        <span class="remove-tag">&times;</span>
                    </span>
                    {% endfor %}
                </div>
                <div style="position: relative;">
                    <input
                        type="text"
                        class="form-control"
                        id="tag-input"
                        placeholder="{% if resource_type == 'video' %}Add tags to describe your video (max 7)...{% else %}Add tags (max 7)...{% endif %}"
                        autocomplete="off"
                    >
                    <div id="tag-autocomplete" style="display: none;"></div>
                </div>
                <p class="helper-text">Maximum 7 tags</p>
            </div>

            <!-- Prompt Content (User's actual prompt) -->
            <div class="mb-4">
                <label for="content" class="form-label">
                    Prompt Content <span style="color: #ef4444;">*</span>
                </label>
                <textarea
                    class="form-control"
                    id="content"
                    name="content"
                    rows="8"
                    required
                    placeholder="{% if resource_type == 'video' %}Enter the prompt you used to generate this video...{% else %}Enter the prompt you used to generate this image...{% endif %}"
                ></textarea>
                <p class="helper-text">Required - Enter the exact prompt you used</p>
            </div>

            <!-- AI Generator -->
            <div class="mb-4">
                <label for="ai_generator" class="form-label">
                    AI Generator <span style="color: #ef4444;">*</span>
                </label>
                <select class="form-select" id="ai_generator" name="ai_generator" required>
                    <option value="">Select AI generator...</option>
                    <option value="Midjourney">Midjourney</option>
                    <option value="DALL-E 3">DALL-E 3</option>
                    <option value="DALL-E 2">DALL-E 2</option>
                    <option value="Stable Diffusion">Stable Diffusion</option>
                    <option value="Leonardo AI">Leonardo AI</option>
                    <option value="Flux">Flux</option>
                    <option value="Adobe Firefly">Adobe Firefly</option>
                    <option value="Bing Image Creator">Bing Image Creator</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
                <button type="button" class="btn-delete" id="delete-upload">
                    <i class="fas fa-trash me-2"></i> Delete this upload
                </button>
                <span style="color: #9ca3af;">(1/1)</span>
                <button type="submit" class="btn-submit">
                    Submit your content
                </button>
            </div>
        </form>
        </div>
    </div>

    <!-- Modal 1: "Still working on this?" -->
    <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="warningModalLabel">
                        <i class="fas fa-clock"></i> Still working on this?
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <p class="lead">Your upload session will expire in</p>
                    <h1 class="display-4 text-danger"><strong id="countdown">60</strong></h1>
                    <p class="text-muted">seconds</p>
                    <p>Click below to continue editing or cancel this upload.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg" onclick="extendTime()">
                        <i class="fas fa-check-circle"></i> Yes, I need more time
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="cancelUpload()">
                        Cancel Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 2: "Upload Session Expired" -->
    <div class="modal fade" id="expiredModal" tabindex="-1" aria-labelledby="expiredModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="expiredModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> Upload Session Expired
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-hourglass-bottom text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="lead">Your upload session ended due to inactivity.</p>
                    <p class="text-muted">Don't worry - you can start a new upload anytime!</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" onclick="goHome()">
                        <i class="fas fa-home"></i> Got it, take me home
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const ALL_TAGS = {{ all_tags|safe }};
let hasUnsavedChanges = false;

// Track form changes
document.getElementById('upload-form').addEventListener('input', () => {
    hasUnsavedChanges = true;
});

// Prevent navigation with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Tag autocomplete
const tagInput = document.getElementById('tag-input');
const tagAutocomplete = document.getElementById('tag-autocomplete');
const tagsContainer = document.getElementById('tags-container');

tagInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();

    if (query.length < 2) {
        tagAutocomplete.style.display = 'none';
        return;
    }

    const matches = ALL_TAGS.filter(tag =>
        tag.toLowerCase().includes(query)
    ).slice(0, 10);

    if (matches.length > 0) {
        tagAutocomplete.innerHTML = matches.map(tag =>
            `<div class="autocomplete-item" data-tag="${tag}">${tag}</div>`
        ).join('');
        tagAutocomplete.style.display = 'block';
    } else {
        tagAutocomplete.style.display = 'none';
    }
});

// Add tag on autocomplete click
tagAutocomplete.addEventListener('click', (e) => {
    if (e.target.classList.contains('autocomplete-item')) {
        addTag(e.target.dataset.tag);
        tagInput.value = '';
        tagAutocomplete.style.display = 'none';
    }
});

// Add tag on Enter key
tagInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const value = tagInput.value.trim();
        if (value) {
            addTag(value);
            tagInput.value = '';
            tagAutocomplete.style.display = 'none';
        }
    }
});

// Add tag function
function addTag(tagName) {
    const currentTags = document.querySelectorAll('.tag-pill').length;

    if (currentTags >= 7) {
        alert('Maximum 7 tags allowed');
        return;
    }

    // Check duplicate
    const existing = Array.from(document.querySelectorAll('.tag-pill'))
        .find(pill => pill.dataset.tag === tagName);
    if (existing) return;

    // Create pill
    const pill = document.createElement('span');
    pill.className = 'tag-pill';
    pill.dataset.tag = tagName;
    pill.innerHTML = `${tagName} <span class="remove-tag">&times;</span>`;

    pill.querySelector('.remove-tag').addEventListener('click', () => pill.remove());
    tagsContainer.appendChild(pill);
}

// Remove existing tags
document.querySelectorAll('.remove-tag').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.target.closest('.tag-pill').remove();
    });
});

// On form submit, collect tags
document.getElementById('upload-form').addEventListener('submit', (e) => {
    const tags = Array.from(document.querySelectorAll('.tag-pill'))
        .map(pill => pill.dataset.tag);
    document.getElementById('tags-hidden').value = JSON.stringify(tags);
    hasUnsavedChanges = false;
});

// Delete upload button
document.getElementById('delete-upload').addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this upload?')) {
        hasUnsavedChanges = false;
        window.location.href = '/';
    }
});

// Hide autocomplete when clicking outside
document.addEventListener('click', (e) => {
    if (!tagInput.contains(e.target) && !tagAutocomplete.contains(e.target)) {
        tagAutocomplete.style.display = 'none';
    }
});

// ==========================================
// IDLE DETECTION SYSTEM (Netflix-style)
// ==========================================

const IDLE_TIME = 45 * 60 * 1000;  // 45 minutes
const WARNING_TIME = 60 * 1000;     // 60 seconds countdown

let idleTimer = null;
let countdownInterval = null;
let countdownSeconds = 60;

// Get CSRF token
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Start idle timer when page loads
function startIdleTimer() {
    // Clear any existing timer
    if (idleTimer) clearTimeout(idleTimer);

    // Set new timer for 45 minutes
    idleTimer = setTimeout(() => {
        showWarningModal();
    }, IDLE_TIME);

    console.log('Idle timer started: 45 minutes');
}

// Reset timer on user activity
function resetIdleTimer() {
    startIdleTimer();
}

// Show Modal 1: "Still working on this?"
function showWarningModal() {
    console.log('Idle time reached - showing warning modal');

    // Show the modal
    const warningModal = new bootstrap.Modal(document.getElementById('warningModal'), {
        backdrop: 'static',
        keyboard: false
    });
    warningModal.show();

    // Start 60-second countdown
    countdownSeconds = 60;
    updateCountdown();

    countdownInterval = setInterval(() => {
        countdownSeconds--;
        updateCountdown();

        if (countdownSeconds <= 0) {
            clearInterval(countdownInterval);
            handleTimeout();
        }
    }, 1000);
}

// Update countdown display
function updateCountdown() {
    document.getElementById('countdown').textContent = countdownSeconds;
}

// User clicked "Yes, I need more time"
function extendTime() {
    console.log('User clicked: Yes, need more time');

    // Clear countdown
    clearInterval(countdownInterval);

    // Hide modal
    bootstrap.Modal.getInstance(document.getElementById('warningModal')).hide();

    // Call backend to extend session
    fetch('/upload/extend/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Session extended:', data);
        // Restart idle timer for another 30 minutes
        startIdleTimer();
    })
    .catch(error => {
        console.error('Error extending session:', error);
    });
}

// User clicked "Cancel Upload"
function cancelUpload() {
    console.log('User clicked: Cancel Upload');

    // Clear countdown
    clearInterval(countdownInterval);

    // Call backend to delete file
    fetch('/upload/cancel/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Upload canceled:', data);
        // Redirect to homepage
        window.location.href = '/';
    })
    .catch(error => {
        console.error('Error canceling upload:', error);
        window.location.href = '/';
    });
}

// No response from user - timeout occurred
function handleTimeout() {
    console.log('No response - showing expired modal');

    // Hide warning modal
    bootstrap.Modal.getInstance(document.getElementById('warningModal')).hide();

    // Delete file from Cloudinary
    fetch('/upload/cancel/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Upload auto-canceled:', data);
        // Show expired modal
        showExpiredModal();
    })
    .catch(error => {
        console.error('Error auto-canceling:', error);
        showExpiredModal();
    });
}

// Show Modal 2: "Upload Session Expired"
function showExpiredModal() {
    const expiredModal = new bootstrap.Modal(document.getElementById('expiredModal'), {
        backdrop: 'static',
        keyboard: false
    });
    expiredModal.show();
}

// User clicked "Got it, take me home"
function goHome() {
    window.location.href = '/';
}

// Listen for user activity to reset timer
document.addEventListener('input', resetIdleTimer);
document.addEventListener('click', resetIdleTimer);
document.addEventListener('keypress', resetIdleTimer);
document.addEventListener('mousemove', resetIdleTimer);
document.addEventListener('scroll', resetIdleTimer);

// Start the timer when page loads
startIdleTimer();
</script>
{% endblock %}

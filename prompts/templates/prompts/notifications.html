{% extends "base.html" %}
{% load static %}

{% block title %}Notifications - PromptFinder{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/components/profile-tabs.css' %}">
<link rel="stylesheet" href="{% static 'css/pages/notifications.css' %}">
{% endblock %}

{% block content %}
<div class="notifications-page">
    <!-- Header — flex row with title and action buttons -->
    <div class="notifications-header">
        <h1 class="notifications-heading">Notifications</h1>
        <div class="notifications-header-actions">
            {% if total_unread > 0 %}
            <button type="button" class="notif-page-mark-all" id="markAllReadPageBtn">
                <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-square-check"/></svg>
                Mark all as read
            </button>
            {% endif %}
            <button type="button"
                    class="delete-all-btn"
                    aria-label="Delete all notifications">
                <svg class="icon" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"></use></svg>
                Delete All
            </button>
        </div>
    </div>

    <!-- Category tabs — reuses profile-tabs-wrapper pattern with overflow arrows -->
    <nav class="profile-tabs-wrapper" aria-label="Notification categories">
        <button class="overflow-arrow-left" aria-label="Scroll tabs left" tabindex="-1">
            <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </button>
        <div class="profile-tabs-container">
            {% for tab in category_tabs %}
            <a href="{% url 'prompts:notifications' %}?category={{ tab.value }}"
               class="profile-tab {% if active_category == tab.value %}profile-tab-active{% endif %}"
               data-category="{{ tab.value }}"
               {% if active_category == tab.value %}aria-current="page"{% endif %}>
                {{ tab.label }}
                <span class="profile-tab-count stat-badge">{{ tab.count }}</span>
            </a>
            {% endfor %}
        </div>
        <button class="overflow-arrow" aria-label="Scroll tabs right" tabindex="-1">
            <i class="fas fa-chevron-right" aria-hidden="true"></i>
        </button>
    </nav>

    <!-- Screen reader status announcements (WCAG 4.1.3) -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only" id="notif-status-msg"></div>

    <!-- Load New Notifications Banner -->
    <button type="button"
            class="load-new-banner"
            id="loadNewBanner">
        <span class="load-new-banner-text">Updates available — click to refresh</span>
    </button>

    <!-- Notification list -->
    <div class="notif-list" role="list" aria-label="Notifications">

        {% for notification in notifications %}
        <div class="notif-card {% if not notification.is_read %}notif-unread{% endif %}{% if not notification.message %} notif-card--no-quote{% endif %}"
             data-notification-id="{{ notification.id }}"
             data-category="{{ notification.category }}"
             role="listitem">

             <div class="notif-unread-dot-shell">
                {% if not notification.is_read %}
                    <span class="notif-unread-dot" aria-hidden="true"></span>
                    {% endif %}
            </div>

            <!-- Avatar -->
            <div class="notif-avatar-wrapper">
                {% if notification.sender %}
                    {% if notification.sender.userprofile.avatar and notification.sender.userprofile.avatar.url %}
                    <img src="{{ notification.sender.userprofile.avatar.url }}"
                         alt="{{ notification.sender.username }}'s avatar"
                         class="notif-avatar"
                         loading="lazy"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="notif-avatar-placeholder" style="display: none; background: var(--avatar-gradient-{{ notification.sender.userprofile.get_avatar_color_index }}, var(--main-blue));" role="img" aria-label="{{ notification.sender.username }}'s avatar">
                        {{ notification.sender.username|first|upper }}
                    </div>
                    {% else %}
                    <div class="notif-avatar-placeholder"
                         style="background: var(--avatar-gradient-{{ notification.sender.userprofile.get_avatar_color_index }}, var(--main-blue));"
                         role="img" aria-label="{{ notification.sender.username }}'s avatar">
                        {{ notification.sender.username|first|upper }}
                    </div>
                    {% endif %}
                {% else %}
                <div class="notif-avatar-placeholder" style="background: var(--gray-600, #525252);" role="img" aria-label="System notification">
                    <svg class="icon" aria-hidden="true" width="20" height="20"><use href="{% static 'icons/sprite.svg' %}#icon-bell"/></svg>
                </div>
                {% endif %}
            </div>

            <!-- Body: title + timestamp only -->
            <div class="notif-body">
                <div class="notif-body-title">{{ notification.title }}</div>
                <div class="notif-time">{{ notification.created_at|timesince }} ago</div>
            </div>

            <!-- Quoted comment (separate column, only for messages) -->
            {% if notification.message %}
            <div class="notif-quote">
                <span class="notif-quote-mark" aria-hidden="true">&ldquo;</span>
                <span class="notif-quote-text">{{ notification.message|truncatewords:20 }}</span>
                <span class="notif-quote-mark" aria-hidden="true">&rdquo;</span>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="notif-actions">

                {% if notification.link %}
                    {% if notification.notification_type == 'comment_on_prompt' or notification.notification_type == 'reply_to_comment' %}
                    <a href="{{ notification.link }}" class="notif-action-btn">Reply</a>
                    {% elif notification.notification_type == 'new_follower' %}
                    <a href="{{ notification.link }}" class="notif-action-btn">View Profile</a>
                    {% else %}
                    <a href="{{ notification.link }}" class="notif-action-btn">View</a>
                    {% endif %}
                {% endif %}
                {% if not notification.is_read %}
                <button type="button" class="notif-action-btn notif-mark-read-btn" aria-label="Mark &quot;{{ notification.title|truncatewords:6 }}&quot; as read">Mark as read</button>
                {% endif %}
                <button type="button"
                        class="notif-delete-btn"
                        data-notification-id="{{ notification.id }}"
                        aria-label="Delete this notification">
                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"></use></svg>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="notif-empty">
            <svg class="icon icon-xl" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-bell"/></svg>
            <p>No notifications yet</p>
        </div>
        {% endfor %}
    </div>

    {% if has_more %}
    <div class="load-more-container">
        <button type="button"
                class="load-more-btn"
                data-next-offset="{{ next_offset }}"
                aria-label="Load more notifications">
            Load More
        </button>
    </div>
    {% endif %}
</div>

<!-- Delete All Confirmation Dialog -->
<div class="delete-confirm-overlay" id="deleteConfirmOverlay" style="display: none;"
     role="alertdialog"
     aria-modal="true"
     aria-labelledby="delete-confirm-title"
     aria-describedby="delete-confirm-message">
    <div class="delete-confirm-dialog">
        <h2 id="delete-confirm-title">Delete All Notifications</h2>
        <p id="delete-confirm-message">This will permanently delete all your notifications. This action cannot be undone.</p>
        <div class="delete-confirm-actions">
            <button type="button" class="delete-confirm-cancel">Cancel</button>
            <button type="button" class="delete-confirm-submit">Delete All</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extras %}
<script src="{% static 'js/notifications.js' %}"></script>
<script src="{% static 'js/overflow-tabs.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initOverflowTabs('.notifications-page .profile-tabs-wrapper', {
        centerActiveTab: true,
        centerWhenFits: true
    });
});
</script>
{% endblock %}

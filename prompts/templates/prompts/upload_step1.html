{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5 mb-5">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="h3 mb-3" style="font-weight: 400; color: #1f2937;">
            Share your prompts and let the world discover them
        </h1>
        <p class="text-muted mb-5" style="font-size: 16px; color: #6b7280;">
            Share your first 10 prompts to introduce yourself to millions of Prompt Finders.
        </p>
    </div>

    <!-- Spacing -->
    <div class="mb-5"></div>

    <!-- CSRF token for AJAX requests -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <!-- Drag-drop upload area -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="drop-zone"
                 class="border border-2 rounded-3 p-5 text-center"
                 style="
                     min-height: 400px;
                     cursor: pointer;
                     transition: all 0.3s;
                     border-style: dashed !important;
                     border-color: #d1d5db !important;
                     background-color: #fafafa;
                     position: relative;
                 ">
                <!-- Upload counter in top-right -->
                <div style="position: absolute; top: 20px; right: 20px;">
                    <span style="color: var(--gray-400); font-size: 14px;">({{ uploads_this_week }}/{{ weekly_limit }})</span>
                </div>

                <div class="my-5">
                    <!-- Font Awesome icon -->
                    <div class="mb-4">
                        <i class="fas fa-images" style="font-size: 80px; color: #05a081;"></i>
                    </div>

                    <h3 class="mb-3" style="font-weight: 400; color: #1f2937; font-size: 24px;">
                        Drag and drop to upload, or
                    </h3>
                    <button type="button" class="btn btn-lg" id="browse-btn"
                            style="
                                background-color: #05a081;
                                color: white;
                                border: none;
                                padding: 12px 32px;
                                border-radius: 8px;
                                font-weight: 500;
                            ">
                        Browse
                    </button>
                    <input type="file" id="file-input" accept="image/*,video/*" style="display:none;">

                    <p class="text-muted mt-3 small" style="color: #6b7280;">
                        (You have <strong>{{ uploads_remaining }}</strong> upload{{ uploads_remaining|pluralize }} left for the day)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress indicator (hidden initially) -->
    <div id="upload-progress" class="mt-4" style="display:none;">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: 0%; background-color: #05a081;"
                         id="progress-bar">
                    </div>
                </div>
                <p class="text-center mt-2">
                    Uploading... <span id="progress-percent">0%</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Spacing -->
    <div class="mb-5"></div>

    <!-- Guidelines in 3 columns -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-10">
            <div class="row">
                <!-- Column 1 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Original content you created or have rights to
                        </li>
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Excludes nudity, violence, or hate
                        </li>
                    </ul>
                </div>

                <!-- Column 2 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Mindful of the rights of others
                        </li>
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            Free to use for the community
                        </li>
                    </ul>
                </div>

                <!-- Column 3 -->
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li class="mb-3" style="color: #6b7280; font-size: 15px;">
                            <i class="fas fa-check-circle me-2" style="color: #05a081;"></i>
                            High quality images and videos
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Skip upload link -->
    <div class="text-center mt-4">
        <a href="/"
           style="color: #6b7280; text-decoration: none; font-size: 15px;">
            Skip upload
        </a>
    </div>
</div>

<script>
// Drag-and-drop functionality
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const browseBtn = document.getElementById('browse-btn');
const uploadProgress = document.getElementById('upload-progress');
const progressBar = document.getElementById('progress-bar');
const progressPercent = document.getElementById('progress-percent');

// Click to browse
browseBtn.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('click', (e) => {
    if (e.target !== browseBtn) {
        fileInput.click();
    }
});

// Drag over effect
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#05a081';
    dropZone.style.backgroundColor = '#f0fdf4';
});

dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = '#d1d5db';
    dropZone.style.backgroundColor = '#fafafa';
});

// Handle drop
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#d1d5db';
    dropZone.style.backgroundColor = '#fafafa';

    const file = e.dataTransfer.files[0];
    if (file) {
        handleFileUpload(file);
    }
});

// Handle file input change
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        handleFileUpload(file);
    }
});

// File upload handler
function handleFileUpload(file) {
    // Validate file
    if (!validateFile(file)) return;

    // Show progress
    uploadProgress.style.display = 'block';
    dropZone.style.display = 'none';

    // Upload to B2
    uploadToB2(file);
}

// Validate file size and type
function validateFile(file) {
    const maxImageSize = 10 * 1024 * 1024;  // 10MB
    const maxVideoSize = 100 * 1024 * 1024;  // 100MB

    if (file.type.startsWith('image/')) {
        if (file.size > maxImageSize) {
            showUploadError('Image must be under 10MB. Your file is ' + (file.size / 1024 / 1024).toFixed(1) + 'MB');
            return false;
        }
    } else if (file.type.startsWith('video/')) {
        if (file.size > maxVideoSize) {
            showUploadError('Video must be under 100MB. Your file is ' + (file.size / 1024 / 1024).toFixed(1) + 'MB');
            return false;
        }
        // Note: Duration check happens after upload (can't check before)
    } else {
        showUploadError('Please upload an image (JPG, PNG, WebP) or video (MP4, MOV, WebM)');
        return false;
    }

    return true;
}

// Helper function to get CSRF token (tries multiple sources)
function getCSRFToken() {
    // Method 1: Try hidden input first (most reliable in Django)
    const hiddenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (hiddenInput) {
        return hiddenInput.value;
    }

    // Method 2: Try meta tag (if present)
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }

    // Method 3: Fall back to cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to escape HTML (XSS prevention)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Show error message to user with inline Bootstrap alert
function showUploadError(message) {
    // Hide progress bar if visible
    uploadProgress.style.display = 'none';

    // Show drop zone
    dropZone.style.display = 'block';

    // Find or create error element
    let errorEl = document.getElementById('upload-error-message');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = 'upload-error-message';
        errorEl.className = 'alert alert-danger mt-3';
        errorEl.setAttribute('role', 'alert');

        // Insert after the drop zone container
        const dropZoneContainer = dropZone.closest('.col-md-8');
        if (dropZoneContainer) {
            dropZoneContainer.appendChild(errorEl);
        }
    }

    // Set error content with close button
    errorEl.innerHTML = '<strong>Upload Error:</strong> ' + escapeHtml(message) +
        '<button type="button" class="btn-close float-end" aria-label="Close"></button>';
    errorEl.style.display = 'block';

    // Add close button handler
    const closeBtn = errorEl.querySelector('.btn-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            errorEl.style.display = 'none';
        });
    }

    // Reset progress bar
    progressBar.style.width = '0%';
    progressPercent.textContent = '0%';

    // Reset file input
    fileInput.value = '';
}

// Validate B2 API response schema
function validateB2Response(response) {
    // Check required top-level fields
    if (typeof response.success !== 'boolean') {
        return { valid: false, error: 'Invalid response format' };
    }

    if (!response.success) {
        // Error response - just needs error message
        return { valid: true };
    }

    // Success response - check required fields
    if (!response.urls || typeof response.urls !== 'object') {
        return { valid: false, error: 'Missing URLs in response' };
    }

    if (!response.urls.original) {
        return { valid: false, error: 'Missing original URL in response' };
    }

    if (!response.filename) {
        return { valid: false, error: 'Missing filename in response' };
    }

    return { valid: true };
}

// Upload to B2 via our API
function uploadToB2(file) {
    // Determine if this is a video or image
    const isVideo = file.type.startsWith('video/');
    const resourceType = isVideo ? 'video' : 'image';

    // Prepare form data
    const formData = new FormData();
    formData.append('file', file);

    // L8: Enable quick mode for images (deferred variant generation)
    // Videos don't support quick mode - they process fully on upload
    if (!isVideo) {
        formData.append('quick', 'true');
    }

    // Get CSRF token
    const csrftoken = getCSRFToken();
    if (!csrftoken) {
        showUploadError('Session expired. Please refresh the page and try again.');
        return;
    }

    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();

    // Progress handler
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
        }
    });

    // Success handler
    xhr.addEventListener('load', () => {
        if (xhr.status === 200 || xhr.status === 201) {
            try {
                const response = JSON.parse(xhr.responseText);

                // Validate response schema
                const validation = validateB2Response(response);
                if (!validation.valid) {
                    console.error('Invalid B2 response schema:', validation.error);
                    showUploadError(validation.error || 'Upload failed. Please try again.');
                    return;
                }

                if (response.success) {
                    // Build redirect URL with B2 data
                    const params = new URLSearchParams({
                        resource_type: resourceType,
                        b2_original: response.urls.original || '',
                        b2_thumb: response.urls.thumb || '',
                        b2_medium: response.urls.medium || '',
                        b2_large: response.urls.large || '',
                        b2_webp: response.urls.webp || ''
                    });

                    // For videos, also pass video-specific URLs
                    if (isVideo) {
                        // Video endpoint returns urls differently
                        if (response.urls.original) {
                            params.set('b2_video', response.urls.original);
                        }
                        if (response.urls.thumb) {
                            params.set('b2_video_thumb', response.urls.thumb);
                        }
                        // Pass video metadata if available
                        if (response.info) {
                            params.set('video_duration', response.info.duration || '');
                            params.set('video_width', response.info.width || '');
                            params.set('video_height', response.info.height || '');
                        }
                    }

                    // Also pass the filename for reference
                    if (response.filename) {
                        params.set('b2_filename', response.filename);
                    }

                    window.location.href = `/upload/details?${params.toString()}`;
                } else {
                    showUploadError(response.error || 'Upload failed. Please try again.');
                }
            } catch (e) {
                console.error('Error parsing response:', e);
                showUploadError('Upload failed. Please try again.');
            }
        } else {
            // Try to get error message from response
            try {
                const response = JSON.parse(xhr.responseText);
                showUploadError(response.error || 'Upload failed. Please try again.');
            } catch (e) {
                showUploadError('Upload failed. Please try again.');
            }
        }
    });

    // Error handler
    xhr.addEventListener('error', () => {
        showUploadError('Upload failed. Please check your connection and try again.');
    });

    // Timeout handler
    xhr.addEventListener('timeout', () => {
        showUploadError('Upload timed out. Please try again with a smaller file.');
    });

    // Set timeout (5 minutes for large videos)
    xhr.timeout = 300000;

    // Send request to B2 API
    xhr.open('POST', '/api/upload/b2/');
    xhr.setRequestHeader('X-CSRFToken', csrftoken);
    xhr.send(formData);
}
</script>
{% endblock %}

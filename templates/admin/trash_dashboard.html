{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Trash & Orphaned Files Dashboard{% endblock %}

{% block extrahead %}
<!-- Bootstrap 5 for collapsible cards and modals -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a> ‚Ä∫
    Trash & Orphaned Files Dashboard
</div>
{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">PromptFinder Administration</a></h1>
{% endblock %}



{% block content %}

<!-- üìö How to Use This Dashboard Section -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white" data-bs-toggle="collapse" data-bs-target="#howToUse" aria-expanded="false" aria-controls="howToUse" style="cursor: pointer;">
            <h5 class="mb-0">
                <i class="bi bi-book"></i> How to Use This Dashboard
                <i class="bi bi-chevron-down float-end"></i>
            </h5>
        </div>
        <div class="collapse" id="howToUse">
            <div class="card-body">
                <h6>What This Page Shows:</h6>
                <ul>
                    <li>All prompts that have been moved to trash (soft deleted)</li>
                    <li>Prompts remain in database but hidden from public view</li>
                    <li>Trash is emptied automatically after retention period (5 days free, 30 days premium)</li>
                    <li>Orphaned Cloudinary files without corresponding database entries</li>
                </ul>

                <h6>Available Actions:</h6>
                <ol>
                    <li><strong>View User Trash Bins:</strong> See all users' trash items with restore options</li>
                    <li><strong>View All Prompts:</strong> Access Django admin interface for all prompts</li>
                    <li><strong>View Media Issues:</strong> See prompts with missing or broken media files</li>
                    <li><strong>Run Management Commands:</strong> Execute maintenance tasks manually</li>
                </ol>

                <h6>Management Commands:</h6>
                <ul style="font-family: monospace; font-size: 13px;">
                    <li><code>python manage.py cleanup_deleted_prompts</code> - Clean expired trash items</li>
                    <li><code>python manage.py detect_orphaned_files</code> - Find orphaned Cloudinary files</li>
                    <li><code>python manage.py fix_cloudinary_urls</code> - Fix malformed Cloudinary URLs</li>
                    <li><code>python manage.py fix_ghost_prompts</code> - Check for orphaned prompts</li>
                </ul>

                <h6>Tips:</h6>
                <ul>
                    <li>Restored prompts return to their original status before deletion</li>
                    <li>Permanent deletion cannot be undone - use carefully</li>
                    <li>Orphaned file detection runs automatically via Heroku Scheduler</li>
                    <li>Run commands with <code>--dry-run</code> flag first to preview changes</li>
                </ul>
            </div>
        </div>
    </div>
<div class="trash-dashboard">

    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <!-- Deleted Prompts Card -->
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #666;">üóëÔ∏è Deleted Prompts</h3>
            <div style="font-size: 48px; font-weight: bold; color: #e74c3c; margin: 10px 0;">
                {{ deleted_count }}
            </div>
            <p style="margin: 0; color: #888; font-size: 14px;">Prompts in trash</p>
        </div>

        <!-- Orphaned Images Card -->
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #666;">üñºÔ∏è Orphaned Images</h3>
            <div style="font-size: 48px; font-weight: bold; color: #f39c12; margin: 10px 0;">
                {{ orphaned_images }}
            </div>
            <p style="margin: 0; color: #888; font-size: 14px;">Images without prompts</p>
        </div>

        <!-- Orphaned Videos Card -->
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #666;">üé¨ Orphaned Videos</h3>
            <div style="font-size: 48px; font-weight: bold; color: #f39c12; margin: 10px 0;">
                {{ orphaned_videos }}
            </div>
            <p style="margin: 0; color: #888; font-size: 14px;">Videos without prompts</p>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0;">üîß Maintenance Tools</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{% url 'prompts:trash_bin' %}" class="button" style="background: #417690; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
                View User Trash Bins
            </a>
            <a href="{% url 'admin:prompts_prompt_changelist' %}" class="button" style="background: #27ae60; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
                View All Prompts
            </a>
            <a href="{% url 'admin_media_issues_dashboard' %}" class="button" style="background: #e74c3c; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
                üìä View Media Issues Dashboard
            </a>
            <button onclick="alert('Run these commands in terminal:\n\n1. python manage.py fix_cloudinary_urls --dry-run\n2. python manage.py fix_cloudinary_urls\n3. python manage.py fix_ghost_prompts\n4. python manage.py detect_orphaned_files\n5. python manage.py diagnose_media\n6. python manage.py diagnose_media --fix');"
                    class="button" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                Show Maintenance Commands
            </button>
        </div>
        <p style="margin-top: 15px; color: #666; font-size: 13px;">
            <strong>Note:</strong> Orphaned file detection runs automatically via Heroku Scheduler.
            Run management commands manually for immediate fixes.
        </p>
    </div>

    <!-- Ghost Prompts Status -->
    {% if ghost_prompts %}
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0;">üëª Previously Reported "Ghost" Prompts Status</h3>
        <p style="color: #666; font-size: 14px;">These prompts were reported as "ghosts" but actually exist in the database:</p>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                    <th style="padding: 10px; text-align: left;">ID</th>
                    <th style="padding: 10px; text-align: left;">Title</th>
                    <th style="padding: 10px; text-align: left;">Author</th>
                    <th style="padding: 10px; text-align: left;">Status</th>
                    <th style="padding: 10px; text-align: left;">Has Media</th>
                    <th style="padding: 10px; text-align: left;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for prompt in ghost_prompts %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">{{ prompt.id }}</td>
                    <td style="padding: 10px;">{{ prompt.title|truncatechars:30 }}</td>
                    <td style="padding: 10px;">{{ prompt.author }}</td>
                    <td style="padding: 10px;">
                        {% if prompt.status == 'Draft' %}
                            <span class="badge bg-secondary">Draft</span>
                        {% else %}
                            <span class="badge bg-success">Active</span>
                        {% endif %}
                    </td>
                    <td style="padding: 10px;">
                        {% if prompt.has_media == 'Yes' %}
                            ‚úÖ Yes
                        {% else %}
                            ‚ùå No
                        {% endif %}
                    </td>
                    <td style="padding: 10px;">
                        <a href="{% url 'admin:prompts_prompt_change' prompt.id %}"
                           class="btn btn-sm btn-info">View in Admin</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Recent Deletions Table -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0;">üïí Recent Deletions</h3>

        {% if recent_deletions %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                    <th style="padding: 10px; text-align: left;">ID</th>
                    <th style="padding: 10px; text-align: left;">Title</th>
                    <th style="padding: 10px; text-align: left;">Author</th>
                    <th style="padding: 10px; text-align: left;">Deleted At</th>
                    <th style="padding: 10px; text-align: left;">Days Left</th>
                    <th style="padding: 10px; text-align: left;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for prompt in recent_deletions %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">{{ prompt.id }}</td>
                    <td style="padding: 10px;">{{ prompt.title|truncatewords:10 }}</td>
                    <td style="padding: 10px;">{{ prompt.author.username }}</td>
                    <td style="padding: 10px;">{{ prompt.deleted_at|date:"Y-m-d H:i" }}</td>
                    <td style="padding: 10px;">
                        {% if prompt.days_until_permanent_deletion <= 1 %}
                        <span style="color: #e74c3c; font-weight: bold;">{{ prompt.days_until_permanent_deletion }} days</span>
                        {% else %}
                        {{ prompt.days_until_permanent_deletion }} days
                        {% endif %}
                    </td>
                    <td style="padding: 10px;">
                        <a href="{% url 'admin:prompts_prompt_change' prompt.id %}"
                           style="color: #417690; text-decoration: none; margin-right: 10px;">View</a>
                        <a href="{% url 'prompts:prompt_restore' prompt.slug %}"
                           style="color: #27ae60; text-decoration: none;">Restore</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #888; font-style: italic;">No recent deletions</p>
        {% endif %}
    </div>

    
</div>
{% endblock %}

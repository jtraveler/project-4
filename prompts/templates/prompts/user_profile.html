{% extends "base.html" %}
{% load static %}
{% load cloudinary %}

{% block title %}{{ profile_user.username }}'s Profile - PromptFlow{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<style>
/* ============================================
   PROFILE HEADER - COMPLETE STYLING
   ============================================ */

/* Overall wrapper */
.profile-header-wrapper {
    background: #ffffff;
    width: 100%;
}

/* ============================================
   SECTION 1: AVATAR & IDENTITY
   ============================================ */

.profile-identity {
    text-align: center;
    padding: 48px 40px 0;
    background: #ffffff;
}

/* Avatar container */
.profile-avatar-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

/* Avatar (both image and placeholder) */
.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    /* REFINEMENT 10: Removed border and box-shadow for clean appearance */
}

/* Avatar placeholder (when no image) */
.profile-avatar-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 700;
    color: #ffffff;
}

/* Avatar color classes (8-color gradient system) */
.avatar-color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.avatar-color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.avatar-color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.avatar-color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.avatar-color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.avatar-color-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
.avatar-color-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
.avatar-color-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }

/* Username */
.profile-username {
    font-size: 32px;
    font-weight: 700;
    color: #1f2937;
    margin: 16px 0 12px;
    line-height: 1.2;
}

/* Bio */
.profile-bio {
    font-size: 16px;
    color: #6b7280;
    margin: 0 auto 16px;
    max-width: 600px;
    line-height: 1.6;
}

/* Edit Profile Button */
.btn-edit-profile {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #05a081;
    color: #ffffff;
    padding: 10px 24px;
    border-radius: 40px;  /* REFINEMENT 11: Pill shape (was 8px) */
    font-size: 15px;  /* REFINEMENT 11: Increased from 14px to 15px */
    font-weight: 600;
    text-decoration: none;
    margin: 16px auto 24px;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-edit-profile:hover {
    background: #048c73;
    color: #ffffff;
    text-decoration: none;
}

/* ============================================
   SECTION 2: STATS ROW
   ============================================ */

.profile-stats-section {
    background: #ffffff;
    padding: 24px 40px;
    margin-bottom: 60px;  /* REFINEMENT 3: Add breathing room below stats */
    /* REFINEMENT 2: Removed border-bottom */
}

.profile-stats-row {
    display: flex;
    justify-content: center;
    gap: 0;  /* REFINEMENT 12: Changed from 48px to 0 for divider approach */
    align-items: flex-start;
    border-top: none !important;  /* Ensure no border appears */
    margin-top: 1.5rem;
}

.profile-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

/* REFINEMENT 12: Add vertical dividers between stats */
.profile-stat:not(:last-child) {
    border-right: 1px solid #e5e7eb;
    padding-right: 24px;
    margin-right: 24px;
}

.profile-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.profile-stat-label {
    font-size: 14px;
    font-weight: 400;
    color: #6b7280;
    white-space: nowrap;
}

/* ============================================
   SECTIONS 3 & 4: TAB NAVIGATION + FILTERS (Combined)
   ============================================ */

/* REFINEMENT 6: Combined container for tabs and filters on same row */
.profile-navigation-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 40px 24px;
    background: #ffffff;
    /* REFINEMENT 2: Removed border-bottom */
}

/* CRITICAL FIX: Wrapper shell for tabs + arrows */
.profile-tabs-wrapper {
    position: relative;  /* Arrows position absolute to this */
    display: flex;
    align-items: center;
    width: 100%;  /* Take full width of left side */
    min-width: 0;  /* FIX: Allow flex item to shrink below content width */
    flex-shrink: 1;  /* FIX: Explicitly allow shrinking to prevent horizontal scroll */
}

.profile-tabs-container {
    display: flex;
    gap: 8px;
    align-items: center;
    min-width: 0;  /* REFINEMENT 1: Enable overflow behavior */
    /* REMOVED: position: relative; - arrows now position to wrapper */

    /* FIX 2: Enable horizontal scrolling on desktop */
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;  /* Smooth scroll on iOS */
    scrollbar-width: thin;  /* Thin scrollbar for visibility */
    -ms-overflow-style: none;  /* Hide scrollbar IE/Edge */

    flex: 1;  /* Take remaining space in wrapper */
    flex-wrap: nowrap;  /* Prevent tabs from wrapping */
}

/* FIX 2: Hide scrollbar for Chrome/Safari */
.profile-tabs-container::-webkit-scrollbar {
    display: none;
}

.profile-tab {
    padding: 12px 20px;
    font-size: 17px;  /* REFINEMENT 4: Increased from 15px to 17px */
    font-weight: 500;
    color: #6b7280;
    background: transparent;
    border: none;
    border-radius: 40px;  /* REFINEMENT 1: Pill shape (was 8px 8px 0 0) */
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;  /* Prevent text wrapping */
    flex-shrink: 0;  /* Prevent tabs from shrinking */
}

.profile-tab:hover:not(.profile-tab-active) {
    background: #f3f4f6;
    color: #1f2937;
}

.profile-tab-active {
    background: #000000;
    color: #ffffff;
    font-weight: 600;
}

.profile-tab-count {
    font-size: 17px;  /* REFINEMENT 4: Increased from 13px to 17px - same as tab text */
    opacity: 0.7;
    margin-left: 5px;
    display: inline-block;
    min-width: 40px;  /* Reserve space to prevent tab shifting */
    text-align: left;  /* Align numbers to left edge of reserved space */
    font-variant-numeric: tabular-nums;  /* Consistent digit width */
}

/* Fixed-width badge to prevent layout shift when count changes */
.stat-badge {
    display: inline-block;
    min-width: 40px;  /* Reserve space for 3 digits (0-999) */
    text-align: center;
    padding: 0 4px;
    font-weight: normal;
    transition: none;  /* Prevent animation that might cause shift */
    font-variant-numeric: tabular-nums;  /* Makes all numbers same width */
}

/* Wider badge for 3+ digits */
.stat-badge.wide {
    min-width: 50px;
}

/* Specific follower count styling - most robust fix */
#follower-count {
    display: inline-block;
    min-width: 35px;  /* Handle 0-999 comfortably */
    text-align: center;
    padding: 0 4px;
    font-variant-numeric: tabular-nums;  /* Consistent digit width */
}

/* FIX 3: Overflow arrow buttons - Accessible implementation */

/* Right arrow button */
.overflow-arrow {
    /* FIX 2: Enhanced gradient with better coverage over dark backgrounds */
    background: linear-gradient(
        to left,
        #ffffff 0%,
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.7) 50%,
        rgba(255, 255, 255, 0) 100%
    );

    /* Position on right edge, full height */
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    z-index: 1;  /* Above tabs */

    /* Layout */
    display: flex;
    align-items: center;
    justify-content: flex-end;
    min-width: 50px;

    /* Button reset */
    border: none;
    padding: 0;
    background-color: transparent;  /* Keep only gradient */
    cursor: pointer;

    /* Interaction */
    pointer-events: auto;  /* Button itself is clickable */
    transition: opacity 0.15s ease-out;
    opacity: 0;  /* Hidden by default */

    /* FIX: Removed box-shadow - not needed, was causing unwanted drop shadow */
}

/* Left arrow button */
.overflow-arrow-left {
    /* FIX 2: Enhanced gradient with better coverage over dark backgrounds */
    background: linear-gradient(
        to right,
        #ffffff 0%,
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.7) 50%,
        rgba(255, 255, 255, 0) 100%
    );

    /* Position on left edge, full height */
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1;  /* Above tabs */

    /* Layout */
    display: flex;
    align-items: center;
    justify-content: flex-start;  /* Align to left */
    min-width: 50px;

    /* Button reset */
    border: none;
    padding: 0;
    background-color: transparent;  /* Keep only gradient */
    cursor: pointer;

    /* Interaction */
    pointer-events: auto;  /* Button itself is clickable */
    transition: opacity 0.15s ease-out;
    opacity: 0;  /* Hidden by default */

    /* FIX: Removed box-shadow - not needed, was causing unwanted drop shadow */
}

/* Show right arrow when tabs overflow */
.profile-tabs-container.has-overflow .overflow-arrow {
    opacity: 1;
}

/* Show left arrow when scrolled right */
.profile-tabs-container.has-scroll-left .overflow-arrow-left {
    opacity: 1;
}

/* Right arrow icon styling */
.overflow-arrow i {
    color: #6b7280;  /* Gray */
    font-size: 20px;
    padding-right: 16px;
    transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
    pointer-events: none;  /* Let button handle clicks */
}

.overflow-arrow:hover i {
    color: #1f2937;  /* Darker on hover */
    transform: translateX(2px);  /* Subtle move right on hover */
}

/* FIX 1: Prevent button position shift on click */
.overflow-arrow:active {
    transform: none;  /* Button stays fixed - no position shift */
}

/* FIX 1: Apply press effect to icon instead of button */
.overflow-arrow:active i {
    transform: scale(0.95);  /* Icon scales for feedback without layout shift */
}

/* Left arrow icon styling */
.overflow-arrow-left i {
    color: #6b7280;  /* Gray */
    font-size: 20px;
    padding-left: 16px;  /* Padding on LEFT instead of right */
    transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
    pointer-events: none;  /* Let button handle clicks */
}

.overflow-arrow-left:hover i {
    color: #1f2937;  /* Darker on hover */
    transform: translateX(-2px);  /* Subtle move LEFT on hover */
}

/* FIX 1: Prevent button position shift on click */
.overflow-arrow-left:active {
    transform: none;  /* Button stays fixed - no position shift */
}

/* FIX 1: Apply press effect to icon instead of button */
.overflow-arrow-left:active i {
    transform: translateX(-2px) scale(0.95);  /* Combine hover position with scale */
}

/* Filter controls (now part of navigation row) */
.profile-filters-container {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* FIX 1: Media filter form styling */
#media-filter-form {
    display: inline-block;
    margin: 0;
}

.profile-filter-dropdown {
    /* REFINEMENT 7: Pexels-style button appearance */
    /* Layout */
    position: relative;
    z-index: 0;
    box-sizing: border-box;
    max-width: 100%;
    height: 48px;  /* Taller - was ~32px */
    line-height: 1;
    display: inline-flex;
    align-items: center;

    /* Spacing */
    padding-left: 20px;  /* Increased from 16px */
    padding-right: 44px;  /* Space for arrow */
    margin: 0;

    /* Typography */
    font-size: 17px;  /* Larger - was 15px */
    font-weight: 500;
    letter-spacing: -0.5px;  /* Tighter - modern typography */
    white-space: nowrap;
    text-decoration: none;
    vertical-align: top;
    color: #1f2937;

    /* Visual */
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;  /* More rounded - was 8px */
    outline: none;

    /* Dropdown Arrow */
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231f2937' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;  /* Fixed position */

    /* Transitions */
    transition: background-color 0.1s ease,
                border-color 0.25s ease,
                transform 0.1s ease;

    cursor: pointer;
}

.profile-filter-dropdown:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    /* FIX 2: Force arrow to stay in same position */
    background-position: right 16px center !important;
    padding-right: 44px !important;
}

.profile-filter-dropdown:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

.profile-filter-dropdown:active {
    transform: scale(0.98);  /* Slight press effect */
}

/* ============================================
   EMPTY STATE
   ============================================ */

.empty-profile {
    text-align: center;
    padding: 80px 20px;
}

.empty-profile i {
    font-size: 64px;
    color: #d1d5db;
    margin-bottom: 16px;
}

.empty-profile h3 {
    font-size: 24px;
    color: #6b7280;
    margin-bottom: 8px;
}

.empty-profile p {
    font-size: 16px;
    color: #9ca3af;
}

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */

/* REFINEMENT 7: Horizontal scroll for tabs below 990px */
@media (max-width: 990px) {
    .profile-navigation-row {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
    }

    .profile-tabs-wrapper {
        width: 100%;
    }

    .profile-tabs-container {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .profile-tabs-container::-webkit-scrollbar {
        display: none;
    }

    .profile-tab {
        flex-shrink: 0;
    }

    /* FIX 1 & 5: Full-width filters on mobile with stacked layout */
    #media-filter-form {
        width: 100%;
        display: block;
    }

    .profile-filters-container {
        width: 100%;
        flex-direction: column;  /* Stack vertically */
        gap: 12px;  /* Space between dropdowns */
    }

    .profile-filter-dropdown {
        width: 100%;  /* Each dropdown full-width */
    }
}

/* Tablet (768px and below) */
@media (max-width: 768px) {
    .profile-identity {
        padding: 32px 20px 0;
    }

    .profile-username {
        font-size: 24px;
    }

    .profile-avatar,
    .profile-avatar-placeholder {
        width: 100px;
        height: 100px;
        font-size: 40px;
    }

    .profile-stats-section {
        padding: 20px;
        margin-bottom: 40px;  /* Adjust spacing on tablet */
    }

    .profile-stat:not(:last-child) {
        padding-right: 16px;
        margin-right: 16px;
    }

    .profile-stat-value {
        font-size: 20px;
    }

    .profile-stat-label {
        font-size: 12px;
    }

    .profile-navigation-row {
        padding: 0 20px 20px;
    }

    .profile-filters-container {
        justify-content: center;
        flex-wrap: wrap;
    }
}

/* Mobile (480px and below) */
@media (max-width: 480px) {
    .profile-identity {
        padding: 24px 16px 0;
    }

    .profile-stats-section {
        margin-bottom: 30px;  /* Adjust spacing on mobile */
    }

    .profile-stat:not(:last-child) {
        padding-right: 12px;
        margin-right: 12px;
    }

    .profile-tab {
        font-size: 15px;
        padding: 10px 16px;
    }

    /* Full width dropdowns on mobile */
    .profile-filter-dropdown,
    select.form-select,
    .dropdown-toggle,
    .dropdown {
        width: 100% !important;
        display: block;
        max-width: none;
    }

    /* Stack toolbar/filter items vertically */
    .profile-filters-container,
    .toolbar,
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }

    .profile-filters-container > *,
    .toolbar > *,
    .d-flex.justify-content-between > * {
        width: 100%;
        margin-bottom: 10px;
    }

    /* Responsive tabs - ensure horizontal scroll */
    .profile-tabs-container {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
    }

    .profile-tab {
        padding: 6px 8px;
        font-size: 0.9rem;
    }

    /* Media filter form full width */
    #media-filter-form {
        width: 100%;
        display: block;
    }
}

/* ============================================
   FOLLOW BUTTON STYLES (Phase F Day 1)
   ============================================ */

.follow-button-container {
    display: inline-block;
}

.follow-button {
    min-width: 120px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.follow-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.btn-danger.follow-button:hover {
    background-color: #dc3545;
    border-color: #dc3545;
}

/* Follower/Following stats hover effect */
.profile-stat {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.profile-stat:hover {
    background-color: rgba(0, 0, 0, 0.02);
    border-radius: 8px;
}
</style>

<!-- Profile Header - Complete Rebuild -->
<div class="profile-header-wrapper">

    <!-- ============================================
         SECTION 1: AVATAR & IDENTITY (Centered)
         ============================================ -->
    <div class="profile-identity">
        <!-- Avatar Container -->
        <div class="profile-avatar-container">
            {% if profile.avatar.url %}
                {% cloudinary profile.avatar width=120 height=120 crop="fill" gravity="face" quality="auto" fetch_format="auto" class="profile-avatar" %}
            {% else %}
                <div class="profile-avatar profile-avatar-placeholder avatar-color-{{ profile.get_avatar_color_index }}">
                    {{ profile_user.username|slice:":1"|upper }}
                </div>
            {% endif %}
        </div>

        <!-- Username -->
        <h1 class="profile-username">{{ profile_user.username }}</h1>

        <!-- Member Since Date -->
        <p class="profile-meta text-muted" style="font-size: 15px; margin: 8px 0 16px; color: #6b7280;">
            <i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>
            Member since {{ profile.created_at|date:"F Y" }}
        </p>

        <!-- Bio (if exists) -->
        {% if profile.bio %}
            <p class="profile-bio">{{ profile.bio }}</p>
        {% endif %}

        <!-- Social Links (if any exist) -->
        {% if profile.twitter_url or profile.instagram_url or profile.website_url %}
            <div class="profile-social-links" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                {% if profile.twitter_url %}
                    <a href="{{ profile.twitter_url }}" target="_blank" rel="noopener noreferrer" class="social-link" style="color: #1DA1F2; font-size: 24px;" title="Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                {% endif %}
                
                {% if profile.instagram_url %}
                    <a href="{{ profile.instagram_url }}" target="_blank" rel="noopener noreferrer" class="social-link" style="color: #E4405F; font-size: 24px;" title="Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                {% endif %}
                
                {% if profile.website_url %}
                    <a href="{{ profile.website_url }}" target="_blank" rel="noopener noreferrer" class="social-link" style="color: #6b7280; font-size: 24px;" title="Website">
                        <i class="fas fa-globe"></i>
                    </a>
                {% endif %}
            </div>
        {% endif %}

        <!-- Edit Profile Button (Owner Only) -->
        {% if is_own_profile %}
            <a href="{% url 'prompts:edit_profile' %}" class="btn-edit-profile">
                <i class="fas fa-pen"></i>
                Edit profile
            </a>
        {% endif %}

        <!-- Follow Button (Non-Owner Only) -->
        {% if user.is_authenticated and not is_own_profile %}
        <div class="follow-button-container mt-3">
            <button id="follow-btn"
                    class="btn btn-primary follow-button"
                    data-username="{{ profile_user.username }}"
                    data-following="false">
                <span class="button-text">Follow</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
        </div>
        {% endif %}

        <!-- ============================================
             PLACEHOLDER METRICS SECTION (Below Follow Button)
             ============================================ -->
        <div class="placeholder-metrics-section" style="margin-top: 32px; padding: 24px 0;">
            <div class="profile-stats-row">
                <!-- Total Views -->
                <div class="profile-stat">
                    <div class="profile-stat-value">-</div>
                    <div class="profile-stat-label">Total Views</div>
                </div>

                <!-- All-time Rank -->
                <div class="profile-stat">
                    <div class="profile-stat-value">-</div>
                    <div class="profile-stat-label">All-time Rank</div>
                </div>

                <!-- 30-day Rank -->
                <div class="profile-stat">
                    <div class="profile-stat-value">-</div>
                    <div class="profile-stat-label">30-day Rank</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         SECTIONS 3 & 4 COMBINED: TABS + FILTERS ON SAME ROW
         ============================================ -->
    <div class="profile-navigation-row">
        <!-- Left side: Tabs with wrapper shell -->
        <div class="profile-tabs-wrapper">
            <!-- LEFT ARROW - Outside scrolling container, positioned to wrapper -->
            <button class="overflow-arrow-left" aria-label="Scroll tabs left" tabindex="-1">
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
            </button>

            <!-- SCROLLING TABS CONTAINER - Only tabs inside -->
            <div class="profile-tabs-container">
                <button class="profile-tab profile-tab-active">
                    Gallery
                    <span class="profile-tab-count stat-badge">{{ total_prompts|default:0 }}</span>
                </button>
                <button class="profile-tab">Collections</button>
                <button class="profile-tab">Statistics</button>
                <button class="profile-tab">
                    Followers
                    <span class="profile-tab-count stat-badge" id="follower-count">{{ profile_user.userprofile.follower_count|default:0 }}</span>
                </button>
                <button class="profile-tab">
                    Following
                    <span class="profile-tab-count stat-badge">{{ profile_user.userprofile.following_count|default:0 }}</span>
                </button>
                <button class="profile-tab">
                    Likes Received
                    <span class="profile-tab-count stat-badge">{{ total_likes|default:0 }}</span>
                </button>

                <!-- Trash tab (Owner Only) -->
                {% if is_own_profile %}
                <button class="profile-tab" onclick="alert('Trash feature coming in Phase F'); return false;">
                    <i class="fas fa-trash-alt" style="margin-right: 6px; font-size: 15px;"></i>
                    Trash
                    <span class="profile-tab-count stat-badge">0</span>
                </button>
                {% endif %}
            </div>

            <!-- RIGHT ARROW - Outside scrolling container, positioned to wrapper -->
            <button class="overflow-arrow" aria-label="Scroll tabs right" tabindex="-1">
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
            </button>
        </div>

        <!-- Right side: Filters -->
        <div class="profile-filters-container">
            <!-- Media Type Filter with form submit -->
            <form method="get" id="media-filter-form">
                <select name="media" id="media-type-filter" class="profile-filter-dropdown" onchange="this.form.submit()">
                    <option value="all" {% if media_filter == 'all' or not media_filter %}selected{% endif %}>
                        Photos and videos
                    </option>
                    <option value="photos" {% if media_filter == 'photos' %}selected{% endif %}>
                        Photos only
                    </option>
                    <option value="videos" {% if media_filter == 'videos' %}selected{% endif %}>
                        Videos only
                    </option>
                </select>
            </form>

            <!-- Sort Order (placeholder for future functionality) -->
            <select class="profile-filter-dropdown">
                <option value="recency">Recency</option>
                <option value="popular">Popular</option>
                <option value="curated">Curated</option>
            </select>
        </div>
    </div>

</div>

<!-- Masonry Grid (Reusable Partial) - FULL WIDTH -->
{% if prompts %}
    {% include 'prompts/partials/_masonry_grid.html' with items=prompts grid_id='profile-grid' show_load_more=True page_obj=page_obj show_admin_controls=False %}
{% else %}
    <!-- Empty State -->
    <div class="empty-profile">
        <i class="fas fa-image"></i>
        <h3>No {% if media_filter == 'photos' %}photos{% elif media_filter == 'videos' %}videos{% else %}prompts{% endif %} yet</h3>
        <p>
            {% if is_own_profile %}
                Start sharing your creations!
            {% else %}
                {{ profile_user.username }} hasn't shared any {% if media_filter == 'photos' %}photos{% elif media_filter == 'videos' %}videos{% else %}prompts{% endif %} yet.
            {% endif %}
        </p>
    </div>
{% endif %}

<script>
// FIX 3: Bidirectional overflow arrows with keyboard navigation
(function() {
    const tabsContainer = document.querySelector('.profile-tabs-container');
    const rightArrow = document.querySelector('.overflow-arrow');
    const leftArrow = document.querySelector('.overflow-arrow-left');

    if (!tabsContainer || !rightArrow || !leftArrow) {
        console.log('⚠️ Tabs container or arrows not found');
        return;
    }

    console.log('✅ Overflow arrow script loaded (LEFT + RIGHT)');

    // Debounce helper for scroll events
    let scrollTimeout;
    function debounce(func, delay) {
        return function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(func, delay);
        };
    }

    // Check if tabs overflow horizontally
    function checkOverflow() {
        return tabsContainer.scrollWidth > tabsContainer.clientWidth;
    }

    // Dynamically show/hide arrows based on overflow and scroll position
    function updateArrowVisibility() {
        const hasOverflow = checkOverflow();

        // No overflow: hide both arrows
        if (!hasOverflow) {
            leftArrow.style.opacity = '0';
            leftArrow.style.pointerEvents = 'none';
            rightArrow.style.opacity = '0';
            rightArrow.style.pointerEvents = 'none';
            console.log('📏 No overflow - both arrows hidden');
            return;
        }

        const scrollLeft = tabsContainer.scrollLeft;
        const maxScroll = tabsContainer.scrollWidth - tabsContainer.clientWidth;

        // LEFT ARROW: Show if scrolled right (5px threshold prevents flickering)
        if (scrollLeft <= 5) {
            leftArrow.style.opacity = '0';
            leftArrow.style.pointerEvents = 'none';
        } else {
            leftArrow.style.opacity = '1';
            leftArrow.style.pointerEvents = 'auto';
        }

        // RIGHT ARROW: Show if not at end (5px threshold)
        if (scrollLeft >= maxScroll - 5) {
            rightArrow.style.opacity = '0';
            rightArrow.style.pointerEvents = 'none';
        } else {
            rightArrow.style.opacity = '1';
            rightArrow.style.pointerEvents = 'auto';
        }

        console.log(`📏 Overflow detected - Left: ${leftArrow.style.opacity === '1' ? 'visible' : 'hidden'}, Right: ${rightArrow.style.opacity === '1' ? 'visible' : 'hidden'} (scroll: ${Math.round(scrollLeft)}/${Math.round(maxScroll)})`);
    }

    // Calculate scroll amount (200px or 1/4 container width, whichever is smaller)
    function getScrollAmount() {
        return Math.min(200, tabsContainer.scrollWidth / 4);
    }

    // RIGHT ARROW: Click to scroll right
    rightArrow.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('🖱️ Right arrow clicked - scrolling right');

        tabsContainer.scrollBy({
            left: getScrollAmount(),
            behavior: 'smooth'
        });

        // Update arrow visibility after smooth scroll completes (300ms)
        setTimeout(updateArrowVisibility, 300);
    });

    // LEFT ARROW: Click to scroll left
    leftArrow.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('🖱️ Left arrow clicked - scrolling left');

        tabsContainer.scrollBy({
            left: -getScrollAmount(),  // Negative for left scroll
            behavior: 'smooth'
        });

        // Update arrow visibility after smooth scroll completes (300ms)
        setTimeout(updateArrowVisibility, 300);
    });

    // KEYBOARD NAVIGATION: Arrow keys, Home, End
    tabsContainer.addEventListener('keydown', function(e) {
        const scrollAmount = getScrollAmount();

        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                console.log('⌨️ Arrow Left key - scrolling left');
                tabsContainer.scrollBy({
                    left: -scrollAmount,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;

            case 'ArrowRight':
                e.preventDefault();
                console.log('⌨️ Arrow Right key - scrolling right');
                tabsContainer.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;

            case 'Home':
                e.preventDefault();
                console.log('⌨️ Home key - scrolling to start');
                tabsContainer.scrollTo({
                    left: 0,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;

            case 'End':
                e.preventDefault();
                console.log('⌨️ End key - scrolling to end');
                tabsContainer.scrollTo({
                    left: tabsContainer.scrollWidth,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;
        }
    });

    // Ensure focused tab is visible
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('focus', function() {
            this.scrollIntoView({
                behavior: 'smooth',
                inline: 'nearest',
                block: 'nearest'
            });
        });
    });

    // Update arrow visibility on load, resize, and scroll (debounced)
    updateArrowVisibility();
    window.addEventListener('resize', debounce(updateArrowVisibility, 100));
    tabsContainer.addEventListener('scroll', debounce(updateArrowVisibility, 50));

    console.log('✅ Overflow arrows + keyboard navigation registered');
})();

// ============================================================================
// FOLLOW/UNFOLLOW FUNCTIONALITY (Phase F Day 1)
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    const followBtn = document.getElementById('follow-btn');

    // Safety check: Follow button only exists if logged in and viewing another user's profile
    if (!followBtn) {
        console.log('Follow button not found - likely viewing own profile or not logged in');
        return;
    }

    const username = followBtn.dataset.username;
    const spinner = followBtn.querySelector('.spinner-border');
    const buttonText = followBtn.querySelector('.button-text');

    // Validate required elements exist
    if (!username || !spinner || !buttonText) {
        console.error('Follow button missing required elements');
        return;
    }

    // Check initial follow status
    fetch(`/users/${username}/follow-status/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateButtonState(data.following);
                // Don't update follower count on page load - it's already displayed in template
                // updateFollowerCount(data.follower_count);
            }
        });

    // Follow/unfollow click handler
    followBtn.addEventListener('click', function() {
        // Prevent double-clicks
        if (followBtn.disabled) return;

        followBtn.disabled = true;
        spinner.classList.remove('d-none');

        const isFollowing = followBtn.dataset.following === 'true';
        const url = isFollowing ?
            `/users/${username}/unfollow/` :
            `/users/${username}/follow/`;

        // CRITICAL: Get and verify CSRF token before making request
        const csrfToken = getCookie('csrftoken');

        // Early abort if no CSRF token
        if (!csrfToken) {
            console.error('CSRF token not found - cannot proceed with follow action');
            showErrorMessage('Security token not found. Please refresh the page and try again.');
            followBtn.disabled = false;
            spinner.classList.add('d-none');
            return;
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,  // Use the verified token
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            // Check if response is OK before parsing JSON
            if (!response.ok) {
                // Handle specific HTTP status codes
                if (response.status === 400) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Bad request');
                    });
                } else if (response.status === 403) {
                    throw new Error('You do not have permission to perform this action');
                } else if (response.status === 404) {
                    throw new Error('User not found');
                } else if (response.status === 429) {
                    throw new Error('Too many requests. Please wait before trying again.');
                } else if (response.status === 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    throw new Error(`Request failed with status ${response.status}`);
                }
            }

            // Parse JSON only if response is OK
            return response.json();
        })
        .then(data => {
            if (data.error) {
                // Handle application-level errors
                console.error('Follow error:', data.error);
                showErrorMessage(data.error);
                return;
            }

            if (data.success) {
                // Update button state
                updateButtonState(data.following);

                // Update ONLY follower count (not following count)
                // Following count is for the logged-in user, not the profile being viewed
                if (data.follower_count !== undefined) {
                    updateFollowerCount(data.follower_count);
                }

                // REMOVED: updateFollowingCount() call
                // The following_count returned is for the logged-in user's profile,
                // NOT for the profile being viewed. Don't update here.
            }
        })
        .catch(error => {
            console.error('Follow action error:', error.message);
            showErrorMessage(error.message || 'An error occurred. Please try again.');
        })
        .finally(() => {
            followBtn.disabled = false;
            spinner.classList.add('d-none');
        });
    });

    function updateButtonState(isFollowing) {
        followBtn.dataset.following = isFollowing;
        if (isFollowing) {
            followBtn.classList.remove('btn-primary');
            followBtn.classList.add('btn-secondary');
            buttonText.textContent = 'Following';

            // Change to "Unfollow" on hover
            followBtn.addEventListener('mouseenter', handleMouseEnter);
            followBtn.addEventListener('mouseleave', handleMouseLeave);
        } else {
            followBtn.classList.remove('btn-secondary', 'btn-danger');
            followBtn.classList.add('btn-primary');
            buttonText.textContent = 'Follow';

            // Remove hover handlers
            followBtn.removeEventListener('mouseenter', handleMouseEnter);
            followBtn.removeEventListener('mouseleave', handleMouseLeave);
        }
    }

    function handleMouseEnter() {
        if (followBtn.dataset.following === 'true') {
            followBtn.classList.remove('btn-secondary');
            followBtn.classList.add('btn-danger');
            buttonText.textContent = 'Unfollow';
        }
    }

    function handleMouseLeave() {
        if (followBtn.dataset.following === 'true') {
            followBtn.classList.remove('btn-danger');
            followBtn.classList.add('btn-secondary');
            buttonText.textContent = 'Following';
        }
    }

    function updateFollowerCount(count) {
        const followerCountEl = document.getElementById('follower-count');
        if (followerCountEl) {
            followerCountEl.textContent = count;
        }
    }

    function updateFollowingCount(count) {
        const followingCountEl = document.getElementById('following-count');
        if (followingCountEl) {
            followingCountEl.textContent = count;
        }
    }

    function showErrorMessage(message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            <strong>Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Insert alert before follow button
        const container = followBtn.closest('.follow-button-container');
        if (container) {
            container.parentNode.insertBefore(alertDiv, container);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        } else {
            // Fallback to console if container not found
            console.error('Error displaying message:', message);
        }
    }

    function getCookie(name) {
        // Method 1: Try to get from cookie
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }

        // Method 2: If not in cookie, try to get from DOM (for csrftoken specifically)
        if (!cookieValue && name === 'csrftoken') {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                cookieValue = token.value;
            }
        }

        // Method 3: Try alternate cookie names
        if (!cookieValue && name === 'csrftoken') {
            const altNames = ['csrf_token', '_csrf', 'XSRF-TOKEN'];
            for (const altName of altNames) {
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, altName.length + 1) === (altName + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(altName.length + 1));
                            break;
                        }
                    }
                }
                if (cookieValue) break;
            }
        }

        // Only log error if CSRF token is critical and missing
        if (!cookieValue && name === 'csrftoken') {
            console.error('CSRF token not found in cookies or DOM');
        }

        return cookieValue;
    }
});
</script>

{% endblock %}

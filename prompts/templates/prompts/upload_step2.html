{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<style>
/* Fade-in animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

.upload-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
}

/* New wrapper for image + form (Pexels-style layout) */
.preview-and-form {
    display: flex;
    gap: 50px;
    padding: 50px 80px;
    background-color: #f8f9fa;
    border-radius: 20px;
}

/* Responsive stacking */
@media (max-width: 992px) {
    .preview-and-form {
        flex-direction: column;
        padding: 30px 20px;
        gap: 30px;
    }
}

.image-preview-container {
    display: flex;
    justify-content: center;
    flex: 1;
    max-width: 60%;
}

.image-preview {
    max-height: 680px;
    object-fit: contain;
    border-radius: 12px;
}

@media (max-width: 992px) {
    .image-preview-container {
        max-width: 100%;
    }
}

.form-container {
    flex: 1;
    max-width: 40%;
    background-color: transparent;
    box-shadow: none;
    padding: 0;
}

@media (max-width: 992px) {
    .form-container {
        max-width: 100%;
    }
}

.form-label {
    color: #1f2937;
    font-weight: 500;
    font-size: 15px;
    margin-bottom: 8px;
}

.form-control, .form-select {
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px;
    font-size: 15px;
}

.form-control:focus, .form-select:focus {
    border-color: #05a081;
    box-shadow: 0 0 0 3px rgba(5, 160, 129, 0.1);
    outline: none;
}

.tag-pill {
    display: inline-block;
    padding: 8px 16px;
    margin: 4px;
    background-color: #e5e7eb;
    border-radius: 20px;
    font-size: 14px;
    color: #374151;
}

.tag-pill .remove-tag {
    margin-left: 8px;
    color: #9ca3af;
    cursor: pointer;
    font-weight: bold;
}

.tag-pill .remove-tag:hover {
    color: #ef4444;
}

#tag-autocomplete {
    position: absolute;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: 4px;
}

.autocomplete-item {
    padding: 12px;
    cursor: pointer;
    font-size: 14px;
    color: #374151;
}

.autocomplete-item:hover {
    background-color: #f3f4f6;
}

.submit-section {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 30px;
    gap: 20px;
}

.btn-submit {
    background-color: #05a081;
    color: white;
    border: none;
    padding: 12px 40px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-submit:hover {
    background-color: #048a6f;
}

.btn-delete {
    background-color: transparent;
    color: #ef4444;
    border: 1px solid #ef4444;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-delete:hover {
    background-color: #fef2f2;
}

.helper-text {
    font-size: 13px;
    color: #6b7280;
    margin-top: 6px;
}
</style>
{% endblock %}

{% block content %}
<div class="upload-container fade-in">
    <!-- Error Alert (profanity detection) -->
    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 30px;">
        {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Warning Banner (before header) -->
    {% if image_warning %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert" style="margin-bottom: 30px;">
        {{ image_warning|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="text-center mb-5">
        <a href="{% url 'prompts:upload_step1' %}" style="color: #6b7280; text-decoration: none; font-size: 14px;">
            <i class="fas fa-arrow-left me-2"></i> Back
        </a>
        <h1 class="mt-3" style="font-size: 28px; font-weight: 400; color: #1f2937;">
            Make your prompts easy to find and be seen
        </h1>
        <p class="text-muted" style="font-size: 16px; color: #6b7280;">
            Add keywords that describe your prompt
        </p>
    </div>

    <!-- Image Preview + Form Wrapper -->
    <div class="preview-and-form">
        <!-- Image Preview -->
        <div class="image-preview-container">
            {% if resource_type == 'video' %}
                <video src="{{ secure_url }}" class="image-preview" controls></video>
            {% else %}
                <img src="{{ secure_url }}" class="image-preview" alt="Uploaded preview">
            {% endif %}
        </div>

        <!-- Form -->
        <div class="form-container">
            <form method="post" action="{% url 'prompts:upload_submit' %}" id="upload-form">
            {% csrf_token %}
            <input type="hidden" name="cloudinary_id" value="{{ cloudinary_id }}">
            <input type="hidden" name="resource_type" value="{{ resource_type }}">
            <input type="hidden" name="tags" id="tags-hidden">
            <input type="hidden" name="original_ai_tags" value="{% for tag in ai_tags %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}">

            <!-- Tags -->
            <div class="mb-4">
                <label class="form-label">
                    Tags <span style="color: #9ca3af;">(optional)</span>
                </label>
                <p class="helper-text mb-2">
                    {% if resource_type == 'video' %}Add relevant tags to describe your video{% else %}Suggested tags (you can edit or add your own){% endif %}
                </p>
                <div id="tags-container" class="mb-3" data-preserved-tags="{{ tags_input|default:'' }}">
                    {% for tag in ai_tags %}
                    <span class="tag-pill" data-tag="{{ tag }}">
                        {{ tag }}
                        <span class="remove-tag">&times;</span>
                    </span>
                    {% endfor %}
                </div>
                <div style="position: relative;">
                    <input
                        type="text"
                        class="form-control"
                        id="tag-input"
                        placeholder="{% if resource_type == 'video' %}Add tags to describe your video (max 7)...{% else %}Add tags (max 7)...{% endif %}"
                        autocomplete="off"
                    >
                    <div id="tag-autocomplete" style="display: none;"></div>
                </div>
                <p class="helper-text">Maximum 7 tags</p>
            </div>

            <!-- Prompt Content (User's actual prompt) -->
            <div class="mb-4">
                <label for="content" class="form-label">
                    Prompt Content <span style="color: #ef4444;">*</span>
                </label>
                <textarea
                    class="form-control"
                    id="content"
                    name="content"
                    rows="8"
                    required
                    placeholder="{% if resource_type == 'video' %}Enter the prompt you used to generate this video...{% else %}Enter the prompt you used to generate this image...{% endif %}"
                >{{ prompt_content|default:'' }}</textarea>
                <p class="helper-text">Required - Enter the exact prompt you used</p>
            </div>

            <!-- AI Generator -->
            <div class="mb-4">
                <label for="ai_generator" class="form-label">
                    AI Generator <span style="color: #ef4444;">*</span>
                </label>
                <select class="form-select" id="ai_generator" name="ai_generator" required>
                    <option value="">Select AI generator...</option>
                    <option value="Midjourney" {% if ai_generator == 'Midjourney' %}selected{% endif %}>Midjourney</option>
                    <option value="DALL-E 3" {% if ai_generator == 'DALL-E 3' %}selected{% endif %}>DALL-E 3</option>
                    <option value="DALL-E 2" {% if ai_generator == 'DALL-E 2' %}selected{% endif %}>DALL-E 2</option>
                    <option value="Stable Diffusion" {% if ai_generator == 'Stable Diffusion' %}selected{% endif %}>Stable Diffusion</option>
                    <option value="Leonardo AI" {% if ai_generator == 'Leonardo AI' %}selected{% endif %}>Leonardo AI</option>
                    <option value="Flux" {% if ai_generator == 'Flux' %}selected{% endif %}>Flux</option>
                    <option value="Adobe Firefly" {% if ai_generator == 'Adobe Firefly' %}selected{% endif %}>Adobe Firefly</option>
                    <option value="Bing Image Creator" {% if ai_generator == 'Bing Image Creator' %}selected{% endif %}>Bing Image Creator</option>
                    <option value="Other" {% if ai_generator == 'Other' %}selected{% endif %}>Other</option>
                </select>
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
                <button type="button" class="btn-delete" id="delete-upload">
                    <i class="fas fa-trash me-2"></i> Delete this upload
                </button>
                <span style="color: #9ca3af;">(1/1)</span>
                <button type="submit" class="btn-submit">
                    Submit your content
                </button>
            </div>
        </form>
        </div>
    </div>

    <!-- Modal 1: "Still working on this?" -->
    <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="warningModalLabel">
                        <i class="fas fa-clock"></i> Still working on this?
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <p class="lead">Your upload session will expire in</p>
                    <h1 class="display-4 text-danger"><strong id="countdown">30</strong></h1>
                    <p class="text-muted">seconds</p>
                    <p>Click below to continue editing or cancel this upload.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg" onclick="extendTime()">
                        <i class="fas fa-check-circle"></i> Yes, I need more time
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="cancelUpload()">
                        Cancel Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 2: "Upload Session Expired" -->
    <div class="modal fade" id="expiredModal" tabindex="-1" aria-labelledby="expiredModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="expiredModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> Upload Session Expired
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-hourglass-bottom text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="lead">Your upload session ended due to inactivity.</p>
                    <p class="text-muted">Don't worry - you can start a new upload anytime!</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" onclick="goHome()">
                        <i class="fas fa-home"></i> Got it, take me home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Leave Modal -->
    <div class="modal fade" id="confirmLeaveModal" tabindex="-1" aria-labelledby="confirmLeaveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="confirmLeaveModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> Leave this page?
                    </h5>
                </div>
                <div class="modal-body">
                    <p>You have an upload in progress. If you leave now:</p>
                    <ul>
                        <li>Your uploaded image/video will be deleted</li>
                        <li>Any information you entered will be lost</li>
                    </ul>
                    <p class="mb-0"><strong>Are you sure you want to leave?</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="stayOnPage()">
                        <i class="bi bi-arrow-left"></i> Stay and continue editing
                    </button>
                    <button type="button" class="btn btn-danger" onclick="leaveAndDelete()">
                        <i class="bi bi-trash"></i> Yes, leave and delete upload
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('=== NAVIGATION GUARD DIAGNOSTIC ===');
console.log('Document ready state:', document.readyState);
console.log('Bootstrap available:', typeof bootstrap);

// Tag autocomplete data
const ALL_TAGS = {{ all_tags|safe }};

// SINGLE DECLARATION BLOCK - No duplicates
let hasUnsavedChanges = true;
let isSubmitting = false;
let sessionExpired = false;
let idleTimer = null;
let countdownInterval = null;
let countdownSeconds = 30;
let navigationWarningActive = false;
let pausedCountdownSeconds = 0;

const IDLE_TIME = 1 * 60 * 1000;  // 1 minute for testing
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

console.log('Variables initialized:', {
    hasUnsavedChanges,
    isSubmitting,
    sessionExpired
});
console.log('=== END DIAGNOSTIC ===');

// Restore preserved tags on error
const preservedTags = document.getElementById('tags-container').dataset.preservedTags;
if (preservedTags && preservedTags.trim() !== '') {
    document.getElementById('tags-container').innerHTML = '';
    preservedTags.split(',').forEach(tag => {
        const trimmedTag = tag.trim();
        if (trimmedTag) {
            addTag(trimmedTag);
        }
    });
}

// Track form changes (kept for future use if needed)
document.getElementById('upload-form').addEventListener('input', () => {
    // Form tracking can be added here if needed
});

// Tag autocomplete
const tagInput = document.getElementById('tag-input');
const tagAutocomplete = document.getElementById('tag-autocomplete');
const tagsContainer = document.getElementById('tags-container');

tagInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();

    if (query.length < 2) {
        tagAutocomplete.style.display = 'none';
        return;
    }

    const matches = ALL_TAGS.filter(tag =>
        tag.toLowerCase().includes(query)
    ).slice(0, 10);

    if (matches.length > 0) {
        tagAutocomplete.innerHTML = matches.map(tag =>
            `<div class="autocomplete-item" data-tag="${tag}">${tag}</div>`
        ).join('');
        tagAutocomplete.style.display = 'block';
    } else {
        tagAutocomplete.style.display = 'none';
    }
});

// Add tag on autocomplete click
tagAutocomplete.addEventListener('click', (e) => {
    if (e.target.classList.contains('autocomplete-item')) {
        addTag(e.target.dataset.tag);
        tagInput.value = '';
        tagAutocomplete.style.display = 'none';
    }
});

// Add tag on Enter key
tagInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const value = tagInput.value.trim();
        if (value) {
            addTag(value);
            tagInput.value = '';
            tagAutocomplete.style.display = 'none';
        }
    }
});

// Add tag function
function addTag(tagName) {
    const currentTags = document.querySelectorAll('.tag-pill').length;

    if (currentTags >= 7) {
        alert('Maximum 7 tags allowed');
        return;
    }

    // Check duplicate
    const existing = Array.from(document.querySelectorAll('.tag-pill'))
        .find(pill => pill.dataset.tag === tagName);
    if (existing) return;

    // Create pill
    const pill = document.createElement('span');
    pill.className = 'tag-pill';
    pill.dataset.tag = tagName;
    pill.innerHTML = `${tagName} <span class="remove-tag">&times;</span>`;

    pill.querySelector('.remove-tag').addEventListener('click', () => pill.remove());
    tagsContainer.appendChild(pill);
}

// Remove existing tags
document.querySelectorAll('.remove-tag').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.target.closest('.tag-pill').remove();
    });
});

// On form submit, collect tags
document.getElementById('upload-form').addEventListener('submit', (e) => {
    const tags = Array.from(document.querySelectorAll('.tag-pill'))
        .map(pill => pill.dataset.tag);
    document.getElementById('tags-hidden').value = JSON.stringify(tags);
    hasUnsavedChanges = false;
});

// Delete upload button
document.getElementById('delete-upload').addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this upload?')) {
        hasUnsavedChanges = false;
        window.location.href = '/';
    }
});

// Hide autocomplete when clicking outside
document.addEventListener('click', (e) => {
    if (!tagInput.contains(e.target) && !tagAutocomplete.contains(e.target)) {
        tagAutocomplete.style.display = 'none';
    }
});

// ==========================================
// NAVIGATION GUARD
// ==========================================

// Browser warning for external navigation - Enhanced debugging
window.addEventListener('beforeunload', function(e) {
    console.log('BEFOREUNLOAD: Event triggered');
    console.log('BEFOREUNLOAD: hasUnsavedChanges =', hasUnsavedChanges);
    console.log('BEFOREUNLOAD: isSubmitting =', isSubmitting);
    console.log('BEFOREUNLOAD: sessionExpired =', sessionExpired);

    // Also check if variables exist
    console.log('BEFOREUNLOAD: Variables exist:', {
        hasUnsavedChanges: typeof hasUnsavedChanges,
        isSubmitting: typeof isSubmitting,
        sessionExpired: typeof sessionExpired
    });

    if (hasUnsavedChanges && !isSubmitting && !sessionExpired) {
        console.log('BEFOREUNLOAD: Should show warning');
        const message = 'You have unsaved changes. Are you sure you want to leave?';
        e.preventDefault();
        e.returnValue = message;
        return message;
    } else {
        console.log('BEFOREUNLOAD: Not showing warning - state check failed');
    }
});

// Form submission handler
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            console.log('Form submitting - disabling guards');
            isSubmitting = true;
            hasUnsavedChanges = false;
        });
    }
});

// Internal navigation handler
document.addEventListener('click', function(e) {
    if (hasUnsavedChanges && !isSubmitting && !sessionExpired) {
        const link = e.target.closest('a');

        if (link &&
            !link.hasAttribute('data-bs-toggle') &&
            !link.hasAttribute('data-bs-dismiss') &&
            link.href &&
            link.href !== '#' &&
            !link.href.startsWith('javascript:') &&
            link.href.includes(window.location.hostname)) {

            console.log('Internal navigation detected - pausing countdown');
            e.preventDefault();
            e.stopPropagation();

            // PAUSE the countdown timer if running
            if (countdownInterval) {
                clearInterval(countdownInterval);
                pausedCountdownSeconds = countdownSeconds;
                navigationWarningActive = true;
                console.log('Countdown paused at:', pausedCountdownSeconds, 'seconds');
            }

            const modalEl = document.getElementById('confirmLeaveModal');
            if (modalEl) {
                const confirmModal = new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: false
                });
                confirmModal.show();
                window.pendingNavigation = link.href;
            }
        }
    }
});

// Modal functions
function stayOnPage() {
    console.log('User chose to stay - resuming countdown');

    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmLeaveModal'));
    if (modal) {
        modal.hide();
    }

    // RESUME countdown if it was paused
    if (navigationWarningActive && pausedCountdownSeconds > 0) {
        navigationWarningActive = false;
        countdownSeconds = pausedCountdownSeconds;

        console.log('Resuming countdown from:', countdownSeconds, 'seconds');
        updateCountdown();

        // Restart the countdown interval
        countdownInterval = setInterval(() => {
            countdownSeconds--;
            updateCountdown();

            if (countdownSeconds <= 0) {
                clearInterval(countdownInterval);
                handleTimeout();
            }
        }, 1000);
    }

    window.pendingNavigation = null;
}

function leaveAndDelete() {
    console.log('Instant leave - bypassing all delays');

    // Disable guards immediately
    hasUnsavedChanges = false;
    isSubmitting = true;

    // Immediate redirect to pending navigation
    window.location.replace(window.pendingNavigation || '/');
}

// ==========================================
// IDLE DETECTION SYSTEM
// ==========================================

console.log('Idle detection initializing...');

function startIdleTimer() {
    if (idleTimer) clearTimeout(idleTimer);

    idleTimer = setTimeout(() => {
        console.log('⏰ Idle time reached - showing warning modal');
        showWarningModal();
    }, IDLE_TIME);

    console.log(`✅ Idle timer started: ${IDLE_TIME / 60000} minute(s)`);
}

function resetIdleTimer() {
    startIdleTimer();
}

function showWarningModal() {
    console.log('Showing idle warning modal');

    // Don't show if navigation warning is active
    if (navigationWarningActive) {
        console.log('Navigation warning active - skipping idle modal');
        return;
    }

    const modalEl = document.getElementById('warningModal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static',
            keyboard: false
        });
        modal.show();

        countdownSeconds = 30;
        updateCountdown();

        countdownInterval = setInterval(() => {
            countdownSeconds--;
            updateCountdown();
            if (countdownSeconds <= 0) {
                clearInterval(countdownInterval);
                handleTimeout();
            }
        }, 1000);
    }
}

function updateCountdown() {
    const countdownEl = document.getElementById('countdown');
    if (countdownEl) {
        countdownEl.textContent = countdownSeconds;
    }
}

function extendTime() {
    console.log('Extending time');
    clearInterval(countdownInterval);

    const modal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
    if (modal) modal.hide();

    fetch('/upload/extend/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(() => {
        console.log('Time extended');
        startIdleTimer();
    })
    .catch(console.error);
}

function cancelUpload() {
    console.log('Instant cancel - bypassing all delays');

    // Disable guards immediately
    hasUnsavedChanges = false;
    isSubmitting = true;
    sessionExpired = true;

    // Stop all timers
    if (countdownInterval) clearInterval(countdownInterval);
    if (idleTimer) clearTimeout(idleTimer);

    // Immediate redirect - no modal animations, no API calls
    window.location.replace('/');
}

function handleTimeout() {
    console.log('Session timed out');

    // CRITICAL: Disable all navigation guards when session expires
    hasUnsavedChanges = false;
    isSubmitting = true;
    sessionExpired = true;

    clearInterval(countdownInterval);
    clearTimeout(idleTimer);

    const modal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
    if (modal) modal.hide();

    fetch('/upload/cancel/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(() => showExpiredModal())
    .catch(() => showExpiredModal());
}

function showExpiredModal() {
    const modalEl = document.getElementById('expiredModal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
}

function goHome() {
    hasUnsavedChanges = false;
    isSubmitting = true;
    sessionExpired = true;

    const modal = bootstrap.Modal.getInstance(document.getElementById('expiredModal'));
    if (modal) modal.hide();

    setTimeout(() => window.location.href = '/', 100);
}

// Test function for browser warning
window.testBrowserWarning = function() {
    console.log('Testing browser warning...');
    console.log('hasUnsavedChanges:', hasUnsavedChanges);
    hasUnsavedChanges = true;
    isSubmitting = false;
    sessionExpired = false;
    console.log('Browser warning should now work. Try closing tab.');
};

// Activity listeners
document.addEventListener('input', startIdleTimer);
document.addEventListener('click', startIdleTimer);
document.addEventListener('keypress', startIdleTimer);

// Initialize
startIdleTimer();
console.log('Navigation guard loaded successfully');
console.log('To test browser warning, run: testBrowserWarning()');
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}
{% load cloudinary %}
{% load cloudinary_tags %}

{% block title %}{{ profile_user.username }}'s Profile - PromptFinder{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<style>
/* ============================================
   PROFILE HEADER - COMPLETE STYLING
   ============================================ */

/* Overall wrapper */
.profile-header-wrapper {
    background: transparent;
    width: 100%;
}

/* ============================================
   SECTION 1: AVATAR & IDENTITY
   ============================================ */

.profile-identity {
    text-align: center;
    padding: 48px 40px 0;
    background: transparent;
}

/* Avatar container */
.profile-avatar-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

/* Avatar (both image and placeholder) */
.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    /* REFINEMENT 10: Removed border and box-shadow for clean appearance */
}

/* Avatar placeholder (when no image) */
.profile-avatar-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 700;
    color: #ffffff;
}

/* Avatar color classes (8-color gradient system) */
.avatar-color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.avatar-color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.avatar-color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.avatar-color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.avatar-color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.avatar-color-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
.avatar-color-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
.avatar-color-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }

/* Username */
.profile-username {
    font-size: 32px;
    font-weight: 700;
    color: #1f2937;
    margin: 16px 0 12px;
    line-height: 1.2;
}

/* Bio */
.profile-bio {
    font-size: 16px;
    color: #6b7280;
    margin: 0 auto 16px;
    max-width: 600px;
    line-height: 1.6;
}

/* Edit Profile Button */
.btn-edit-profile {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #05a081;
    color: #ffffff;
    padding: 10px 24px;
    border-radius: 40px;  /* REFINEMENT 11: Pill shape (was 8px) */
    font-size: 15px;  /* REFINEMENT 11: Increased from 14px to 15px */
    font-weight: 600;
    text-decoration: none;
    margin: 16px auto 24px;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-edit-profile:hover {
    background: #048c73;
    color: #ffffff;
    text-decoration: none;
}

/* ============================================
   SECTION 2: STATS ROW
   ============================================ */

.profile-stats-section {
    background: transparent;
    padding: 24px 40px;
    margin-bottom: 60px;  /* REFINEMENT 3: Add breathing room below stats */
    /* REFINEMENT 2: Removed border-bottom */
}

.profile-stats-row {
    display: flex;
    justify-content: center;
    gap: 0;  /* REFINEMENT 12: Changed from 48px to 0 for divider approach */
    align-items: flex-start;
    border-top: none !important;  /* Ensure no border appears */
    margin-top: 1.5rem;
}

.profile-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

/* REFINEMENT 12: Add vertical dividers between stats */
.profile-stat:not(:last-child) {
    border-right: 1px solid #e5e7eb;
    padding-right: 24px;
    margin-right: 24px;
}

.profile-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.profile-stat-label {
    font-size: 14px;
    font-weight: 400;
    color: #6b7280;
    white-space: nowrap;
}

/* ============================================
   SECTIONS 3 & 4: TAB NAVIGATION + FILTERS (Combined)
   ============================================ */

/* REFINEMENT 6: Combined container for tabs and filters on same row */
.profile-navigation-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 0 24px;
    gap: 20px;
    background: transparent;
    /* REFINEMENT 2: Removed border-bottom */
}

/* CRITICAL FIX: Wrapper shell for tabs + arrows */
.profile-tabs-wrapper {
    position: relative;  /* Arrows position absolute to this */
    display: flex;
    align-items: center;
    min-width: 0;  /* FIX: Allow flex item to shrink below content width */
    flex: 1;  /* Take available space */
}

.profile-tabs-container {
    display: flex;
    gap: 8px;
    align-items: center;
    min-width: 0;  /* REFINEMENT 1: Enable overflow behavior */
    /* REMOVED: position: relative; - arrows now position to wrapper */

    /* FIX 2: Enable horizontal scrolling on desktop */
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;  /* Smooth scroll on iOS */
    scrollbar-width: thin;  /* Thin scrollbar for visibility */
    -ms-overflow-style: none;  /* Hide scrollbar IE/Edge */

    flex: 1;  /* Take remaining space in wrapper */
    flex-wrap: nowrap;  /* Prevent tabs from wrapping */
    padding-bottom: 10px;
}

/* FIX 2: Hide scrollbar for Chrome/Safari */
.profile-tabs-container::-webkit-scrollbar {
    display: none;
}

.profile-tab {
    padding: 12px 20px;
    font-size: 17px;  /* REFINEMENT 4: Increased from 15px to 17px */
    font-weight: 500;
    color: #6b7280;
    background: transparent;
    border: none;
    border-radius: 40px;  /* REFINEMENT 1: Pill shape (was 8px 8px 0 0) */
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;  /* Prevent text wrapping */
    flex-shrink: 0;  /* Prevent tabs from shrinking */
}

.profile-tab:hover:not(.profile-tab-active) {
    background: #f3f4f6;
    color: #1f2937;
}

.profile-tab-active {
    background: #000000;
    color: #ffffff;
    font-weight: 600;
}

.profile-tab-active:hover {
    color: #ffffff;
    text-decoration: none;
}

.profile-tab-count {
    font-size: 17px;  /* REFINEMENT 4: Increased from 13px to 17px - same as tab text */
    opacity: 0.7;
    margin-left: 5px;
    display: inline-block;
    min-width: 40px;  /* Reserve space to prevent tab shifting */
    text-align: left;  /* Align numbers to left edge of reserved space */
    font-variant-numeric: tabular-nums;  /* Consistent digit width */
}

/* Fixed-width badge to prevent layout shift when count changes */
.stat-badge {
    display: inline-block;
    min-width: 40px;  /* Reserve space for 3 digits (0-999) */
    text-align: center;
    padding-right: 4px;
    font-weight: normal;
    transition: none;  /* Prevent animation that might cause shift */
    font-variant-numeric: tabular-nums;  /* Makes all numbers same width */
}

/* Wider badge for 3+ digits */
.stat-badge.wide {
    min-width: 50px;
}

/* Specific follower count styling - most robust fix */
#follower-count {
    display: inline-block;
    min-width: 35px;  /* Handle 0-999 comfortably */
    text-align: center;
    padding: 0 4px;
    font-variant-numeric: tabular-nums;  /* Consistent digit width */
}

/* FIX 3: Overflow arrow buttons - Accessible implementation */

/* Right arrow button */
.overflow-arrow {
    /* FIX 2: Enhanced gradient with better coverage over dark backgrounds */
    background: linear-gradient(
        to left,
        #f7f7f7 0%,
        rgba(247, 247, 247, 0.95) 20%,
        rgba(247, 247, 247, 0.7) 50%,
        rgba(247, 247, 247, 0) 100%
    );

    /* Position on right edge, full height */
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    z-index: 1;  /* Above tabs */

    /* Layout */
    display: flex;
    align-items: center;
    justify-content: flex-end;
    min-width: 50px;

    /* Button reset */
    border: none;
    padding: 0;
    background-color: transparent;  /* Keep only gradient */
    cursor: pointer;

    /* Interaction */
    pointer-events: auto;  /* Button itself is clickable */
    transition: opacity 0.15s ease-out;
    opacity: 0;  /* Hidden by default */

    /* FIX: Removed box-shadow - not needed, was causing unwanted drop shadow */
}

/* Left arrow button */
.overflow-arrow-left {
    /* FIX 2: Enhanced gradient with better coverage over dark backgrounds */
    background: linear-gradient(
        to right,
        #f7f7f7 0%,
        rgba(247, 247, 247, 0.95) 20%,
        rgba(247, 247, 247, 0.7) 50%,
        rgba(247, 247, 247, 0) 100%
    );

    /* Position on left edge, full height */
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1;  /* Above tabs */

    /* Layout */
    display: flex;
    align-items: center;
    justify-content: flex-start;  /* Align to left */
    min-width: 50px;

    /* Button reset */
    border: none;
    padding: 0;
    background-color: transparent;  /* Keep only gradient */
    cursor: pointer;

    /* Interaction */
    pointer-events: auto;  /* Button itself is clickable */
    transition: opacity 0.15s ease-out;
    opacity: 0;  /* Hidden by default */

    /* FIX: Removed box-shadow - not needed, was causing unwanted drop shadow */
}

/* Show right arrow when tabs overflow */
.profile-tabs-container.has-overflow .overflow-arrow {
    opacity: 1;
}

/* Show left arrow when scrolled right */
.profile-tabs-container.has-scroll-left .overflow-arrow-left {
    opacity: 1;
}

/* Right arrow icon styling */
.overflow-arrow i {
    color: #6b7280;  /* Gray */
    font-size: 20px;
    padding-right: 16px;
    transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
    pointer-events: none;  /* Let button handle clicks */
}

.overflow-arrow:hover i {
    color: #1f2937;  /* Darker on hover */
    transform: translateX(2px);  /* Subtle move right on hover */
}

/* FIX 1: Prevent button position shift on click */
.overflow-arrow:active {
    transform: none;  /* Button stays fixed - no position shift */
}

/* FIX 1: Apply press effect to icon instead of button */
.overflow-arrow:active i {
    transform: scale(0.95);  /* Icon scales for feedback without layout shift */
}

/* Left arrow icon styling */
.overflow-arrow-left i {
    color: #6b7280;  /* Gray */
    font-size: 20px;
    padding-left: 16px;  /* Padding on LEFT instead of right */
    transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
    pointer-events: none;  /* Let button handle clicks */
}

.overflow-arrow-left:hover i {
    color: #1f2937;  /* Darker on hover */
    transform: translateX(-2px);  /* Subtle move LEFT on hover */
}

/* FIX 1: Prevent button position shift on click */
.overflow-arrow-left:active {
    transform: none;  /* Button stays fixed - no position shift */
}

/* FIX 1: Apply press effect to icon instead of button */
.overflow-arrow-left:active i {
    transform: translateX(-2px) scale(0.95);  /* Combine hover position with scale */
}

/* Filter controls (now part of navigation row) */
.profile-filters-container {
    display: flex;
    flex-direction: row;
    gap: 12px;
    align-items: center;
}

/* FIX 1: Media filter form styling */
#media-filter-form {
    display: inline-block;
    margin: 0;
}

.profile-filter-dropdown {
    /* REFINEMENT 7: Pexels-style button appearance */
    /* Layout */
    position: relative;
    z-index: 0;
    box-sizing: border-box;
    max-width: 100%;
    height: 48px;  /* Taller - was ~32px */
    line-height: 1;
    display: inline-flex;
    align-items: center;

    /* Spacing */
    padding-left: 20px;  /* Increased from 16px */
    padding-right: 44px;  /* Space for arrow */
    margin: 0;

    /* Typography */
    font-size: 17px;  /* Larger - was 15px */
    font-weight: 500;
    letter-spacing: -0.5px;  /* Tighter - modern typography */
    white-space: nowrap;
    text-decoration: none;
    vertical-align: top;
    color: #1f2937;

    /* Visual */
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;  /* More rounded - was 8px */
    outline: none;

    /* Dropdown Arrow */
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231f2937' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;  /* Fixed position */

    /* Transitions */
    transition: background-color 0.1s ease,
                border-color 0.25s ease,
                transform 0.1s ease;

    cursor: pointer;
}

.profile-filter-dropdown:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    /* FIX 2: Force arrow to stay in same position */
    background-position: right 16px center !important;
    padding-right: 44px !important;
}

.profile-filter-dropdown:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

.profile-filter-dropdown:active {
    transform: scale(0.98);  /* Slight press effect */
}

/* ============================================
   EMPTY STATE
   ============================================ */

.empty-profile {
    text-align: center;
    padding: 80px 20px;
}

.empty-profile i {
    font-size: 64px;
    color: #d1d5db;
    margin-bottom: 16px;
}

.empty-profile h3 {
    font-size: 24px;
    color: #6b7280;
    margin-bottom: 8px;
}

.empty-profile p {
    font-size: 16px;
    color: var(--gray-400);
}

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */

/* REFINEMENT 7: Horizontal scroll for tabs below 990px */
@media (max-width: 990px) {
    .profile-navigation-row {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
    }

    .profile-tabs-wrapper {
        width: 100%;
    }

    .profile-tabs-container {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .profile-tabs-container::-webkit-scrollbar {
        display: none;
    }

    .profile-tab {
        flex-shrink: 0;
    }

    /* FIX 1 & 5: Full-width filters on mobile with stacked layout */
    #media-filter-form {
        width: 100%;
        display: block;
    }

    .profile-filters-container {
        width: 100%;
        flex-direction: column;  /* Stack vertically */
        gap: 12px;  /* Space between dropdowns */
    }

    .profile-filter-dropdown {
        width: 100%;  /* Each dropdown full-width */
    }
}

/* Tablet (768px and below) */
@media (max-width: 768px) {
    .profile-identity {
        padding: 32px 20px 0;
    }

    .profile-username {
        font-size: 24px;
    }

    .profile-avatar,
    .profile-avatar-placeholder {
        width: 100px;
        height: 100px;
        font-size: 40px;
    }

    .profile-stats-section {
        padding: 20px;
        margin-bottom: 40px;  /* Adjust spacing on tablet */
    }

    .profile-stat:not(:last-child) {
        padding-right: 16px;
        margin-right: 16px;
    }

    .profile-stat-value {
        font-size: 20px;
    }

    .profile-stat-label {
        font-size: 12px;
    }

    .profile-navigation-row {
        padding: 0 20px 20px;
    }

    .profile-filters-container {
        justify-content: center;
        flex-wrap: wrap;
    }
}

/* Mobile (480px and below) */
@media (max-width: 480px) {
    .profile-identity {
        padding: 24px 16px 0;
    }

    .profile-stats-section {
        margin-bottom: 30px;  /* Adjust spacing on mobile */
    }

    .profile-stat:not(:last-child) {
        padding-right: 12px;
        margin-right: 12px;
    }

    .profile-tab {
        font-size: 15px;
        padding: 10px 16px;
    }

    /* Full width dropdowns on mobile */
    .profile-filter-dropdown,
    select.form-select,
    .dropdown-toggle,
    .dropdown {
        width: 100% !important;
        display: block;
        max-width: none;
    }

    /* Stack toolbar/filter items vertically */
    .profile-filters-container,
    .toolbar,
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }

    .profile-filters-container > *,
    .toolbar > *,
    .d-flex.justify-content-between > * {
        width: 100%;
        margin-bottom: 10px;
    }

    /* Responsive tabs - ensure horizontal scroll */
    .profile-tabs-container {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
    }

    .profile-tab {
        padding: 6px 8px;
        font-size: 0.9rem;
    }

    /* Media filter form full width */
    #media-filter-form {
        width: 100%;
        display: block;
    }
}

/* ============================================
   FOLLOW BUTTON STYLES (Phase F Day 1)
   ============================================ */

.follow-button-container {
    display: inline-block;
}

.follow-button {
    /* Fixed dimensions to prevent layout shift */
    min-width: 120px;
    width: 120px;           /* Fixed width prevents shift when text changes */
    height: 38px;           /* Fixed height */
    padding: 8px 16px;      /* Consistent padding */
    font-size: 14px;        /* Fixed font size */
    font-weight: 600;
    line-height: 1.5;       /* Consistent line height */
    border: 1px solid transparent; /* Always have border space */
    box-sizing: border-box; /* Include border in dimensions */
    display: inline-flex;   /* Use flexbox for centering */
    align-items: center;    /* Vertical center */
    justify-content: center; /* Horizontal center */
    text-align: center;
    transition: background-color 0.2s, color 0.2s, border-color 0.2s; /* Only animate colors */
}

/* Ensure both button states have identical dimensions */
.follow-button.btn-primary,
.follow-button.btn-secondary,
.follow-button.btn-danger {
    min-width: 120px;
    width: 120px;
    height: 38px;
    padding: 8px 16px;
    font-size: 14px;
    line-height: 1.5;
    box-sizing: border-box;
}

.follow-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Hover states - only change colors, never dimensions */
.follow-button:hover {
    transform: none; /* Prevent any scale transforms that cause shift */
}

.btn-danger.follow-button:hover {
    background-color: #dc3545;
    border-color: #dc3545;
}

/* Follower/Following stats hover effect */
.profile-stat {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.profile-stat:hover {
    background-color: rgba(0, 0, 0, 0.02);
    border-radius: 8px;
}

/* ============================================
   CUSTOM DROPDOWN STYLING (Pexels-style)
   ============================================ */

.profile-sort-dropdown {
    position: relative;
    display: inline-block;
    min-width: fit-content;
}

.profile-sort-dropdown-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 15px;
    font-weight: 500;
    color: #1a1a1a;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.profile-sort-dropdown-btn:hover {
    border-color: #666;
}

.profile-sort-dropdown-btn:focus {
    outline: none;
    border-color: #262626;
    box-shadow: 0 0 0 2px rgba(38, 38, 38, 0.1);
}

.profile-sort-dropdown-chevron {
    transition: transform 0.2s ease;
}

.profile-sort-dropdown.open .profile-sort-dropdown-chevron {
    transform: rotate(180deg);
}

.profile-sort-dropdown-menu {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    min-width: 160px;
    padding: 8px 0;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 1000;
}

.profile-sort-dropdown.open .profile-sort-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.profile-sort-dropdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 14px;
    color: #1a1a1a;
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.profile-sort-dropdown-item:hover {
    background-color: #f5f5f5;
    color: #1a1a1a;
    text-decoration: none;
}

.profile-sort-dropdown-item.active {
    font-weight: 600;
}

.profile-sort-check-icon {
    flex-shrink: 0;
}

@media (max-width: 768px) {
    .profile-sort-dropdown-btn {
        padding: 8px 12px;
        font-size: 14px;
    }

    .profile-sort-dropdown-menu {
        min-width: 140px;
    }
}
</style>

<!-- Profile Header - Complete Rebuild -->
<div class="profile-header-wrapper">

    <!-- ============================================
         SECTION 1: AVATAR & IDENTITY (Centered)
         ============================================ -->
    <div class="profile-identity">
        <!-- Avatar Container -->
        <div class="profile-avatar-container">
            {% if profile.avatar.url %}
                <img src="{{ profile.avatar.url }}"
                     alt="{{ profile_user.username }}'s avatar"
                     class="profile-avatar"
                     width="120"
                     height="120"
                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="profile-avatar profile-avatar-placeholder avatar-color-{{ profile.get_avatar_color_index }}" style="display: none;">
                    {{ profile_user.username|slice:":1"|upper }}
                </div>
            {% else %}
                <div class="profile-avatar profile-avatar-placeholder avatar-color-{{ profile.get_avatar_color_index }}">
                    {{ profile_user.username|slice:":1"|upper }}
                </div>
            {% endif %}
        </div>

        <!-- Username -->
        <h1 class="profile-username">{{ profile_user.username }}</h1>

        <!-- Member Since Date -->
        <p class="profile-meta text-muted" style="font-size: 15px; margin: 8px 0 16px; color: #6b7280;">
            <svg class="icon icon-sm" aria-hidden="true" style="margin-right: 6px; vertical-align: -0.125em;"><use href="{% static 'icons/sprite.svg' %}#icon-calendar"/></svg>
            Member since {{ profile.created_at|date:"F Y" }}
        </p>

        <!-- Bio (if exists) -->
        {% if profile.bio %}
            <p class="profile-bio">{{ profile.bio }}</p>
        {% endif %}

        <!-- Social Links (if any exist) -->
        {% if profile.twitter_url or profile.instagram_url or profile.website_url %}
            <div class="profile-social-links" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                {% if profile.twitter_url %}
                    <a href="{{ profile.twitter_url }}" target="_blank" rel="noopener noreferrer" class="social-link" style="color: #1DA1F2; font-size: 24px;" title="Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                {% endif %}
                
                {% if profile.instagram_url %}
                    <a href="{{ profile.instagram_url }}" target="_blank" rel="noopener noreferrer" class="social-link" style="color: #E4405F; font-size: 24px;" title="Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                {% endif %}
                
                {% if profile.website_url %}
                    <a href="{{ profile.website_url }}" target="_blank" rel="noopener noreferrer" class="social-link" style="color: #6b7280; font-size: 24px;" title="Website">
                        <i class="fas fa-globe"></i>
                    </a>
                {% endif %}
            </div>
        {% endif %}

        <!-- Edit Profile Button (Owner Only) -->
        {% if is_own_profile %}
            <a href="{% url 'prompts:edit_profile' %}" class="btn-edit-profile">
                <i class="fas fa-pen"></i>
                Edit profile
            </a>
        {% endif %}

        <!-- Follow Button (Non-Owner Only) -->
        {% if user.is_authenticated and not is_own_profile %}
        <div class="follow-button-container mt-3">
            <button id="follow-btn"
                    class="btn btn-primary follow-button"
                    data-username="{{ profile_user.username }}"
                    data-following="false">
                <span class="button-text">Follow</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
        </div>
        {% endif %}

        <!-- ============================================
             PROFILE METRICS SECTION (Below Follow Button)
             Phase G Enhancement: Display actual stats
             ============================================ -->
        <div class="placeholder-metrics-section" style="margin-top: 32px; padding: 24px 0;">
            <div class="profile-stats-row">
                <!-- Total Views: Sum of all unique views across user's prompts -->
                <div class="profile-stat">
                    <div class="profile-stat-value">{{ total_views|default:0 }}</div>
                    <div class="profile-stat-label">Total Views</div>
                </div>

                <!-- All-time Rank: Position on Most Viewed leaderboard (all time) -->
                <div class="profile-stat">
                    <div class="profile-stat-value">{% if all_time_rank %}#{{ all_time_rank }}{% else %}-{% endif %}</div>
                    <div class="profile-stat-label">All-time Rank</div>
                </div>

                <!-- 30-day Rank: Position on Most Active leaderboard (past 30 days) -->
                <div class="profile-stat">
                    <div class="profile-stat-value">{% if thirty_day_rank %}#{{ thirty_day_rank }}{% else %}-{% endif %}</div>
                    <div class="profile-stat-label">30-day Rank</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         SECTIONS 3 & 4 COMBINED: TABS + FILTERS ON SAME ROW
         ============================================ -->
    <div class="profile-navigation-row">
        <!-- Left side: Tabs with wrapper shell -->
        <div class="profile-tabs-wrapper">
            <!-- LEFT ARROW - Outside scrolling container, positioned to wrapper -->
            <button class="overflow-arrow-left" aria-label="Scroll tabs left" tabindex="-1">
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
            </button>

            <!-- SCROLLING TABS CONTAINER - Only tabs inside -->
            <div class="profile-tabs-container">
                <a href="{% url 'prompts:user_profile' username=profile_user.username %}"
                   class="profile-tab {% if active_tab == 'gallery' %}profile-tab-active{% endif %}"
                   style="text-decoration: none;">
                    Gallery
                    <span class="profile-tab-count stat-badge">{{ total_prompts|default:0 }}</span>
                </a>
                <a href="{% url 'prompts:user_collections' username=profile_user.username %}"
                   class="profile-tab"
                   style="text-decoration: none;">
                    Collections
                    <span class="profile-tab-count stat-badge">{{ total_collections|default:0 }}</span>
                </a>
                {% if show_statistics_tab %}<button class="profile-tab">Statistics</button>{% endif %}
                <button class="profile-tab">
                    Followers
                    <span class="profile-tab-count stat-badge" id="follower-count">{{ profile_user.userprofile.follower_count|default:0 }}</span>
                </button>
                <button class="profile-tab">
                    Following
                    <span class="profile-tab-count stat-badge">{{ profile_user.userprofile.following_count|default:0 }}</span>
                </button>
                <button class="profile-tab">
                    Likes Received
                    <span class="profile-tab-count stat-badge">{{ total_likes|default:0 }}</span>
                </button>

                <!-- Trash tab (Owner Only) -->
                {% if is_own_profile %}
                <a href="{% url 'prompts:user_profile_trash' username=profile_user.username %}"
                   class="profile-tab {% if active_tab == 'trash' %}profile-tab-active{% endif %}"
                   style="text-decoration: none;">
                    <svg class="icon icon-sm" aria-hidden="true" style="margin-right: 6px;"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>
                    Trash
                    <span class="profile-tab-count stat-badge">{{ trash_count|default:0 }}</span>
                </a>
                {% endif %}
            </div>

            <!-- RIGHT ARROW - Outside scrolling container, positioned to wrapper -->
            <button class="overflow-arrow" aria-label="Scroll tabs right" tabindex="-1">
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
            </button>
        </div>

        <!-- Right side: Filters -->
        <div class="profile-filters-container">
            <!-- Media Type Filter Dropdown -->
            <div class="profile-sort-dropdown" id="mediaDropdown">
                <button class="profile-sort-dropdown-btn" id="mediaDropdownBtn" aria-haspopup="true" aria-expanded="false">
                    {% if media_filter == 'photos' %}
                        Photos only
                    {% elif media_filter == 'videos' %}
                        Videos only
                    {% else %}
                        Photos and videos
                    {% endif %}
                    <svg class="profile-sort-dropdown-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none">
                        <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="profile-sort-dropdown-menu" id="mediaDropdownMenu" role="menu">
                    <a href="{% url 'prompts:user_profile' username=profile_user.username %}?media=all{% if sort_order %}&sort={{ sort_order }}{% endif %}"
                       class="profile-sort-dropdown-item {% if media_filter == 'all' or not media_filter %}active{% endif %}"
                       role="menuitem">
                        {% if media_filter == 'all' or not media_filter %}
                        <svg class="profile-sort-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% else %}
                        <span style="width: 16px;"></span>
                        {% endif %}
                        Photos and videos
                    </a>
                    <a href="{% url 'prompts:user_profile' username=profile_user.username %}?media=photos{% if sort_order %}&sort={{ sort_order }}{% endif %}"
                       class="profile-sort-dropdown-item {% if media_filter == 'photos' %}active{% endif %}"
                       role="menuitem">
                        {% if media_filter == 'photos' %}
                        <svg class="profile-sort-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% else %}
                        <span style="width: 16px;"></span>
                        {% endif %}
                        Photos only
                    </a>
                    <a href="{% url 'prompts:user_profile' username=profile_user.username %}?media=videos{% if sort_order %}&sort={{ sort_order }}{% endif %}"
                       class="profile-sort-dropdown-item {% if media_filter == 'videos' %}active{% endif %}"
                       role="menuitem">
                        {% if media_filter == 'videos' %}
                        <svg class="profile-sort-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% else %}
                        <span style="width: 16px;"></span>
                        {% endif %}
                        Videos only
                    </a>
                </div>
            </div>

            <!-- Sort Order Dropdown -->
            <div class="profile-sort-dropdown" id="sortDropdown">
                <button class="profile-sort-dropdown-btn" id="sortDropdownBtn" aria-haspopup="true" aria-expanded="false">
                    {% if sort_order == 'views' %}
                        Most Views
                    {% else %}
                        Recency
                    {% endif %}
                    <svg class="profile-sort-dropdown-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none">
                        <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="profile-sort-dropdown-menu" id="sortDropdownMenu" role="menu">
                    <a href="{% url 'prompts:user_profile' username=profile_user.username %}?sort=recency{% if media_filter %}&media={{ media_filter }}{% endif %}"
                       class="profile-sort-dropdown-item {% if sort_order == 'recency' or not sort_order %}active{% endif %}"
                       role="menuitem">
                        {% if sort_order == 'recency' or not sort_order %}
                        <svg class="profile-sort-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% else %}
                        <span style="width: 16px;"></span>
                        {% endif %}
                        Recency
                    </a>
                    <a href="{% url 'prompts:user_profile' username=profile_user.username %}?sort=views{% if media_filter %}&media={{ media_filter }}{% endif %}"
                       class="profile-sort-dropdown-item {% if sort_order == 'views' %}active{% endif %}"
                       role="menuitem">
                        {% if sort_order == 'views' %}
                        <svg class="profile-sort-check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% else %}
                        <span style="width: 16px;"></span>
                        {% endif %}
                        Most Views
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

{% if active_tab == 'trash' %}
<!-- ============================================
     TRASH TAB CONTENT
     ============================================ -->
{% if is_own_profile %}
<div class="container mt-4">
    <!-- Trash Info Banner -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle" aria-hidden="true"></i>
        <strong>Free:</strong> Items are kept for 5 days before permanent deletion. Last 10 items shown.
    </div>

    {% if trash_items %}
        <!-- Empty Trash Button -->
        <div class="mb-4">
            <button type="button" class="trash-btn-empty" onclick="openEmptyTrashModal()">
                <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg> Empty Trash ({{ trash_count }})
            </button>
        </div>

        <!-- Trash Items Grid (Masonry) -->
        <div class="masonry-container" style="max-width: 1600px; margin: 0 auto; padding: 40px 0; width: 100%;">
            <div class="masonry-wrapper">
                <div class="masonry-grid" id="trash-masonry-grid">
                    <!-- Columns will be created by JavaScript -->
                </div>
            </div>

            <!-- Store items in hidden container for JavaScript -->
            <div id="trash-items-container" style="display: none;">
                {% for prompt in trash_items %}
                <div class="masonry-item" data-item data-order="{{ forloop.counter }}" data-slug="{{ prompt.slug }}">
                    <div class="card prompt-card {% if prompt.is_expiring_soon %}border-danger{% endif %}">
                        {# Thumbnail (B2 first, Cloudinary fallback) #}
                        <div class="position-relative">
                            {% if prompt.is_video %}
                                <video class="w-100"
                                       style="display: block; border-radius: 12px 12px 0 0;"
                                       autoplay loop muted playsinline preload="metadata"
                                       poster="{{ prompt.display_video_thumb_url|default:prompt.get_thumbnail_url }}">
                                    <source src="{{ prompt.display_video_url|default:prompt.get_video_url }}" type="video/mp4">
                                </video>
                            {% elif prompt.display_medium_url %}
                                {# B2 preferred, Cloudinary fallback #}
                                <img src="{{ prompt.display_medium_url }}"
                                     class="w-100"
                                     style="display: block; border-radius: 12px 12px 0 0;"
                                     alt="{{ prompt.title }}"
                                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                {# Fallback for broken/missing images #}
                                <div class="w-100 bg-secondary align-items-center justify-content-center" style="display: none; height: 300px; border-radius: 12px 12px 0 0;">
                                    <i class="fas fa-image fa-3x text-white" aria-hidden="true"></i>
                                </div>
                            {% elif prompt.featured_image %}
                                {# Direct Cloudinary fallback if no B2 URL #}
                                <img src="{{ prompt.featured_image|cloudinary_transform:'w_440,f_webp,q_90' }}"
                                     class="w-100"
                                     style="display: block; border-radius: 12px 12px 0 0;"
                                     alt="{{ prompt.title }}"
                                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                {# Fallback for broken/missing Cloudinary images #}
                                <div class="w-100 bg-secondary align-items-center justify-content-center" style="display: none; height: 300px; border-radius: 12px 12px 0 0;">
                                    <i class="fas fa-image fa-3x text-white" aria-hidden="true"></i>
                                </div>
                            {% else %}
                                <div class="w-100 bg-secondary d-flex align-items-center justify-content-center" style="height: 300px; border-radius: 12px 12px 0 0;">
                                    <i class="fas fa-image fa-3x text-white" aria-hidden="true"></i>
                                </div>
                            {% endif %}
                        </div>

                        {# Card Meta #}
                        <div class="trash-card-meta">
                            <h5 class="trash-card-title">{{ prompt.title|truncatewords:10 }}</h5>
                            <p class="trash-card-info">
                                <i class="far fa-clock" aria-hidden="true"></i> Deleted {{ prompt.deleted_at|timesince }} ago
                            </p>

                            {% if prompt.is_expiring_soon %}
                                <div class="alert alert-danger py-1 px-2 small mb-2">
                                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                    Expires in {{ prompt.days_until_permanent_deletion }} day(s)!
                                </div>
                            {% else %}
                                <p class="trash-card-info">
                                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-calendar"/></svg> {{ prompt.days_until_permanent_deletion }} days remaining
                                </p>
                            {% endif %}
                        </div>

                        {# Action Buttons #}
                        <div class="trash-card-actions">
                            {# Primary: Restore & Publish (Dark Gray) - Hidden for NSFW/flagged content #}
                            {% if not prompt.requires_manual_review %}
                            <form method="post" action="{% url 'prompts:prompt_restore' prompt.slug %}">
                                {% csrf_token %}
                                <input type="hidden" name="restore_as" value="published">
                                <button type="submit" class="trash-btn-action" title="Restore and make public immediately">
                                    <i class="fas fa-globe" aria-hidden="true"></i> Restore & Publish
                                </button>
                            </form>
                            {% endif %}

                            {# Secondary: Restore as Draft (Dark Gray) #}
                            <form method="post" action="{% url 'prompts:prompt_restore' prompt.slug %}">
                                {% csrf_token %}
                                <input type="hidden" name="restore_as" value="draft">
                                <button type="submit" class="trash-btn-action" title="Restore as draft for editing">
                                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-edit"/></svg> Restore as Draft
                                </button>
                            </form>

                            {# Delete Forever Button (Red - Destructive) #}
                            <button type="button" class="trash-btn-delete"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal{{ prompt.id }}">
                                <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg> Delete Forever
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {# Delete Modals - Outside hidden container so Bootstrap can find them #}
        {% for prompt in trash_items %}
        <div class="modal fade" id="deleteModal{{ prompt.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ prompt.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header border-danger">
                        <h5 class="modal-title text-danger" id="deleteModalLabel{{ prompt.id }}">
                            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Delete Forever?
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Permanently delete <strong>"{{ prompt.title }}"</strong>?</p>
                        <div class="alert alert-danger mb-0">
                            <strong>Warning:</strong> Cannot be undone.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="trash-modal-btn-cancel" data-bs-dismiss="modal">Cancel</button>
                        <form method="post" action="{% url 'prompts:prompt_permanent_delete' prompt.slug %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="trash-modal-btn-confirm">
                                <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg> Delete Forever
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {# Empty Trash Confirmation Modal #}
        <div class="trash-modal-backdrop" id="emptyTrashModal" role="dialog" aria-modal="true" aria-labelledby="emptyTrashTitle">
            <div class="trash-modal">
                <h2 class="trash-modal-title" id="emptyTrashTitle">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    Empty Entire Trash?
                </h2>

                <p class="trash-modal-body">
                    Are you sure you want to permanently delete <strong>{{ trash_count }} item(s)</strong>?
                </p>

                <div class="trash-modal-warning">
                    <strong>Warning:</strong> This action cannot be undone. All items and their associated images/videos will be permanently removed.
                </div>

                <form method="post" action="{% url 'prompts:empty_trash' %}">
                    {% csrf_token %}
                    <div class="trash-modal-actions">
                        <button type="submit" class="trash-modal-btn-confirm">
                            <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>
                            Yes, Empty Trash
                        </button>
                        <button type="button" class="trash-modal-btn-cancel" onclick="closeEmptyTrashModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

    {% else %}
        <!-- Empty Trash State -->
        <div class="empty-profile">
            <svg class="icon" aria-hidden="true" style="width: 4rem; height: 4rem;"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>
            <h3>Trash is Empty</h3>
            <p>Items you delete will appear here for 5 days before being permanently removed.</p>
        </div>
    {% endif %}
</div>
{% endif %}

{% else %}
<!-- ============================================
     GALLERY TAB CONTENT (Default)
     ============================================ -->
<!-- Masonry Grid (Reusable Partial) - FULL WIDTH -->
{% if prompts %}
    {% include 'prompts/partials/_masonry_grid.html' with items=prompts grid_id='profile-grid' show_load_more=True page_obj=page_obj show_admin_controls=False %}
{% else %}
    <!-- Empty State -->
    <div class="empty-profile">
        <i class="fas fa-image"></i>
        <h3>No {% if media_filter == 'photos' %}photos{% elif media_filter == 'videos' %}videos{% else %}prompts{% endif %} yet</h3>
        <p>
            {% if is_own_profile %}
                Start sharing your creations!
            {% else %}
                {{ profile_user.username }} hasn't shared any {% if media_filter == 'photos' %}photos{% elif media_filter == 'videos' %}videos{% else %}prompts{% endif %} yet.
            {% endif %}
        </p>
    </div>
{% endif %}
{% endif %}

<script>
// FIX 3: Bidirectional overflow arrows with keyboard navigation
(function() {
    const tabsContainer = document.querySelector('.profile-tabs-container');
    const rightArrow = document.querySelector('.overflow-arrow');
    const leftArrow = document.querySelector('.overflow-arrow-left');

    if (!tabsContainer || !rightArrow || !leftArrow) {
        console.log('⚠️ Tabs container or arrows not found');
        return;
    }

    console.log('✅ Overflow arrow script loaded (LEFT + RIGHT)');

    // Debounce helper for scroll events
    let scrollTimeout;
    function debounce(func, delay) {
        return function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(func, delay);
        };
    }

    // Check if tabs overflow horizontally
    function checkOverflow() {
        return tabsContainer.scrollWidth > tabsContainer.clientWidth;
    }

    // Dynamically show/hide arrows based on overflow and scroll position
    function updateArrowVisibility() {
        const hasOverflow = checkOverflow();

        // No overflow: hide both arrows
        if (!hasOverflow) {
            leftArrow.style.opacity = '0';
            leftArrow.style.pointerEvents = 'none';
            rightArrow.style.opacity = '0';
            rightArrow.style.pointerEvents = 'none';
            console.log('📏 No overflow - both arrows hidden');
            return;
        }

        const scrollLeft = tabsContainer.scrollLeft;
        const maxScroll = tabsContainer.scrollWidth - tabsContainer.clientWidth;

        // LEFT ARROW: Show if scrolled right (5px threshold prevents flickering)
        if (scrollLeft <= 5) {
            leftArrow.style.opacity = '0';
            leftArrow.style.pointerEvents = 'none';
        } else {
            leftArrow.style.opacity = '1';
            leftArrow.style.pointerEvents = 'auto';
        }

        // RIGHT ARROW: Show if not at end (5px threshold)
        if (scrollLeft >= maxScroll - 5) {
            rightArrow.style.opacity = '0';
            rightArrow.style.pointerEvents = 'none';
        } else {
            rightArrow.style.opacity = '1';
            rightArrow.style.pointerEvents = 'auto';
        }

        console.log(`📏 Overflow detected - Left: ${leftArrow.style.opacity === '1' ? 'visible' : 'hidden'}, Right: ${rightArrow.style.opacity === '1' ? 'visible' : 'hidden'} (scroll: ${Math.round(scrollLeft)}/${Math.round(maxScroll)})`);
    }

    // Calculate scroll amount (200px or 1/4 container width, whichever is smaller)
    function getScrollAmount() {
        return Math.min(200, tabsContainer.scrollWidth / 4);
    }

    // RIGHT ARROW: Click to scroll right
    rightArrow.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('🖱️ Right arrow clicked - scrolling right');

        tabsContainer.scrollBy({
            left: getScrollAmount(),
            behavior: 'smooth'
        });

        // Update arrow visibility after smooth scroll completes (300ms)
        setTimeout(updateArrowVisibility, 300);
    });

    // LEFT ARROW: Click to scroll left
    leftArrow.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('🖱️ Left arrow clicked - scrolling left');

        tabsContainer.scrollBy({
            left: -getScrollAmount(),  // Negative for left scroll
            behavior: 'smooth'
        });

        // Update arrow visibility after smooth scroll completes (300ms)
        setTimeout(updateArrowVisibility, 300);
    });

    // KEYBOARD NAVIGATION: Arrow keys, Home, End
    tabsContainer.addEventListener('keydown', function(e) {
        const scrollAmount = getScrollAmount();

        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                console.log('⌨️ Arrow Left key - scrolling left');
                tabsContainer.scrollBy({
                    left: -scrollAmount,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;

            case 'ArrowRight':
                e.preventDefault();
                console.log('⌨️ Arrow Right key - scrolling right');
                tabsContainer.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;

            case 'Home':
                e.preventDefault();
                console.log('⌨️ Home key - scrolling to start');
                tabsContainer.scrollTo({
                    left: 0,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;

            case 'End':
                e.preventDefault();
                console.log('⌨️ End key - scrolling to end');
                tabsContainer.scrollTo({
                    left: tabsContainer.scrollWidth,
                    behavior: 'smooth'
                });
                setTimeout(updateArrowVisibility, 300);
                break;
        }
    });

    // Ensure focused tab is visible
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('focus', function() {
            this.scrollIntoView({
                behavior: 'smooth',
                inline: 'nearest',
                block: 'nearest'
            });
        });
    });

    // Update arrow visibility on load, resize, and scroll (debounced)
    updateArrowVisibility();
    window.addEventListener('resize', debounce(updateArrowVisibility, 100));
    tabsContainer.addEventListener('scroll', debounce(updateArrowVisibility, 50));

    console.log('✅ Overflow arrows + keyboard navigation registered');
})();

// ============================================================================
// LIKE BUTTON FUNCTIONALITY - Now centralized in static/js/like-button.js
// Loaded in base.html - auto-attaches to all .like-section elements
// ============================================================================

// ============================================================================
// FOLLOW/UNFOLLOW FUNCTIONALITY (Phase F Day 1)
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    const followBtn = document.getElementById('follow-btn');

    // Safety check: Follow button only exists if logged in and viewing another user's profile
    if (!followBtn) {
        console.log('Follow button not found - likely viewing own profile or not logged in');
        return;
    }

    const username = followBtn.dataset.username;
    const spinner = followBtn.querySelector('.spinner-border');
    const buttonText = followBtn.querySelector('.button-text');

    // Validate required elements exist
    if (!username || !spinner || !buttonText) {
        console.error('Follow button missing required elements');
        return;
    }

    // Check initial follow status
    fetch(`/users/${username}/follow-status/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateButtonState(data.following);
                // Don't update follower count on page load - it's already displayed in template
                // updateFollowerCount(data.follower_count);
            }
        });

    // Follow/unfollow click handler
    followBtn.addEventListener('click', function() {
        // Prevent double-clicks
        if (followBtn.disabled) return;

        followBtn.disabled = true;
        spinner.classList.remove('d-none');

        const isFollowing = followBtn.dataset.following === 'true';
        const url = isFollowing ?
            `/users/${username}/unfollow/` :
            `/users/${username}/follow/`;

        // CRITICAL: Get and verify CSRF token before making request
        const csrfToken = getCookie('csrftoken');

        // Early abort if no CSRF token
        if (!csrfToken) {
            console.error('CSRF token not found - cannot proceed with follow action');
            showErrorMessage('Security token not found. Please refresh the page and try again.');
            followBtn.disabled = false;
            spinner.classList.add('d-none');
            return;
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,  // Use the verified token
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            // Check if response is OK before parsing JSON
            if (!response.ok) {
                // Handle specific HTTP status codes
                if (response.status === 400) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Bad request');
                    });
                } else if (response.status === 403) {
                    throw new Error('You do not have permission to perform this action');
                } else if (response.status === 404) {
                    throw new Error('User not found');
                } else if (response.status === 429) {
                    throw new Error('Too many requests. Please wait before trying again.');
                } else if (response.status === 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    throw new Error(`Request failed with status ${response.status}`);
                }
            }

            // Parse JSON only if response is OK
            return response.json();
        })
        .then(data => {
            if (data.error) {
                // Handle application-level errors
                console.error('Follow error:', data.error);
                showErrorMessage(data.error);
                return;
            }

            if (data.success) {
                // Update button state
                updateButtonState(data.following);

                // Update ONLY follower count (not following count)
                // Following count is for the logged-in user, not the profile being viewed
                if (data.follower_count !== undefined) {
                    updateFollowerCount(data.follower_count);
                }

                // REMOVED: updateFollowingCount() call
                // The following_count returned is for the logged-in user's profile,
                // NOT for the profile being viewed. Don't update here.
            }
        })
        .catch(error => {
            console.error('Follow action error:', error.message);
            showErrorMessage(error.message || 'An error occurred. Please try again.');
        })
        .finally(() => {
            followBtn.disabled = false;
            spinner.classList.add('d-none');
        });
    });

    function updateButtonState(isFollowing) {
        followBtn.dataset.following = isFollowing;
        if (isFollowing) {
            followBtn.classList.remove('btn-primary');
            followBtn.classList.add('btn-secondary');
            buttonText.textContent = 'Following';

            // Change to "Unfollow" on hover
            followBtn.addEventListener('mouseenter', handleMouseEnter);
            followBtn.addEventListener('mouseleave', handleMouseLeave);
        } else {
            followBtn.classList.remove('btn-secondary', 'btn-danger');
            followBtn.classList.add('btn-primary');
            buttonText.textContent = 'Follow';

            // Remove hover handlers
            followBtn.removeEventListener('mouseenter', handleMouseEnter);
            followBtn.removeEventListener('mouseleave', handleMouseLeave);
        }
    }

    function handleMouseEnter() {
        if (followBtn.dataset.following === 'true') {
            followBtn.classList.remove('btn-secondary');
            followBtn.classList.add('btn-danger');
            buttonText.textContent = 'Unfollow';
        }
    }

    function handleMouseLeave() {
        if (followBtn.dataset.following === 'true') {
            followBtn.classList.remove('btn-danger');
            followBtn.classList.add('btn-secondary');
            buttonText.textContent = 'Following';
        }
    }

    function updateFollowerCount(count) {
        const followerCountEl = document.getElementById('follower-count');
        if (followerCountEl) {
            followerCountEl.textContent = count;
        }
    }

    function updateFollowingCount(count) {
        const followingCountEl = document.getElementById('following-count');
        if (followingCountEl) {
            followingCountEl.textContent = count;
        }
    }

    function showErrorMessage(message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            <strong>Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Insert alert before follow button
        const container = followBtn.closest('.follow-button-container');
        if (container) {
            container.parentNode.insertBefore(alertDiv, container);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        } else {
            // Fallback to console if container not found
            console.error('Error displaying message:', message);
        }
    }

    function getCookie(name) {
        // Method 1: Try to get from cookie
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }

        // Method 2: If not in cookie, try to get from DOM (for csrftoken specifically)
        if (!cookieValue && name === 'csrftoken') {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                cookieValue = token.value;
            }
        }

        // Method 3: Try alternate cookie names
        if (!cookieValue && name === 'csrftoken') {
            const altNames = ['csrf_token', '_csrf', 'XSRF-TOKEN'];
            for (const altName of altNames) {
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, altName.length + 1) === (altName + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(altName.length + 1));
                            break;
                        }
                    }
                }
                if (cookieValue) break;
            }
        }

        // Only log error if CSRF token is critical and missing
        if (!cookieValue && name === 'csrftoken') {
            console.error('CSRF token not found in cookies or DOM');
        }

        return cookieValue;
    }
});

// ============================================================================
// TRASH TAB FUNCTIONALITY (Masonry Grid + Modal)
// ============================================================================

// Trash Masonry Grid Logic
document.addEventListener('DOMContentLoaded', function() {
    const trashGrid = document.getElementById('trash-masonry-grid');
    const trashContainer = document.getElementById('trash-items-container');

    if (!trashGrid || !trashContainer) {
        return; // Not on trash tab
    }

    let columns = [];
    let columnCount = 4;

    function getColumnCount() {
        const width = window.innerWidth;
        if (width < 500) return 1;
        if (width < 800) return 2;
        if (width < 1100) return 3;
        return 4;
    }

    function createColumns() {
        trashGrid.innerHTML = '';
        columns = [];
        columnCount = getColumnCount();

        for (let i = 0; i < columnCount; i++) {
            const column = document.createElement('div');
            column.className = 'masonry-column';
            trashGrid.appendChild(column);
            columns.push(column);
        }

        trashGrid.setAttribute('data-columns', columnCount);
    }

    function distributeItems() {
        const items = Array.from(trashContainer.querySelectorAll('[data-item]'));

        items.forEach((item, index) => {
            const targetColumn = index % columnCount;
            if (columns[targetColumn]) {
                columns[targetColumn].appendChild(item);
                item.style.animationDelay = `${index * 0.05}s`;
            }
        });
    }

    // Initialize
    createColumns();
    distributeItems();

    // Handle resize
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            const newColumnCount = getColumnCount();
            if (newColumnCount !== columnCount) {
                const allItems = [];
                columns.forEach(col => {
                    allItems.push(...Array.from(col.querySelectorAll('.masonry-item')));
                });

                allItems.forEach(item => trashContainer.appendChild(item));

                createColumns();
                distributeItems();
            }
        }, 250);
    });
});

// Empty Trash Modal Functions
function openEmptyTrashModal() {
    const modal = document.getElementById('emptyTrashModal');
    if (!modal) return;

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';

    const cancelBtn = modal.querySelector('.trash-modal-btn-cancel');
    if (cancelBtn) cancelBtn.focus();

    document.addEventListener('keydown', handleEmptyTrashEscapeKey);
}

function closeEmptyTrashModal() {
    const modal = document.getElementById('emptyTrashModal');
    if (!modal) return;

    modal.classList.remove('show');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', handleEmptyTrashEscapeKey);

    const emptyBtn = document.querySelector('.trash-btn-empty');
    if (emptyBtn) emptyBtn.focus();
}

function handleEmptyTrashEscapeKey(event) {
    if (event.key === 'Escape') {
        closeEmptyTrashModal();
    }
}

// Close modal when clicking backdrop
document.addEventListener('DOMContentLoaded', function() {
    const emptyTrashModal = document.getElementById('emptyTrashModal');
    if (emptyTrashModal) {
        emptyTrashModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeEmptyTrashModal();
            }
        });
    }
});

// ============================================================================
// CUSTOM DROPDOWN FUNCTIONALITY (Profile Page)
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    const dropdowns = document.querySelectorAll('.profile-sort-dropdown');

    dropdowns.forEach(function(dropdown) {
        const btn = dropdown.querySelector('.profile-sort-dropdown-btn');

        if (!btn) return;

        // Toggle dropdown on button click
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Close all other dropdowns
            dropdowns.forEach(function(other) {
                if (other !== dropdown) {
                    other.classList.remove('open');
                    const otherBtn = other.querySelector('.profile-sort-dropdown-btn');
                    if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');
                }
            });

            // Toggle current dropdown
            dropdown.classList.toggle('open');
            btn.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.profile-sort-dropdown')) {
            dropdowns.forEach(function(dropdown) {
                dropdown.classList.remove('open');
                const btn = dropdown.querySelector('.profile-sort-dropdown-btn');
                if (btn) btn.setAttribute('aria-expanded', 'false');
            });
        }
    });

    // Close dropdowns on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            dropdowns.forEach(function(dropdown) {
                dropdown.classList.remove('open');
                const btn = dropdown.querySelector('.profile-sort-dropdown-btn');
                if (btn) btn.setAttribute('aria-expanded', 'false');
            });
        }
    });
});
</script>

{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<style>
/* Fade-in animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

.upload-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
}

/* New wrapper for image + form (Pexels-style layout) */
.preview-and-form {
    display: flex;
    gap: 50px;
    padding: 50px 80px;
    background-color: #f8f9fa;
    border-radius: 20px;
}

/* Responsive stacking */
@media (max-width: 992px) {
    .preview-and-form {
        flex-direction: column;
        padding: 30px 20px;
        gap: 30px;
    }
}

.image-preview-container {
    display: flex;
    justify-content: center;
    flex: 1;
    max-width: 60%;
}

.image-preview {
    max-height: 680px;
    object-fit: contain;
    border-radius: 12px;
}

@media (max-width: 992px) {
    .image-preview-container {
        max-width: 100%;
    }
}

.form-container {
    flex: 1;
    max-width: 40%;
    background-color: transparent;
    box-shadow: none;
    padding: 0;
}

@media (max-width: 992px) {
    .form-container {
        max-width: 100%;
    }
}

.form-label {
    color: #1f2937;
    font-weight: 500;
    font-size: 15px;
    margin-bottom: 8px;
}

.form-control, .form-select {
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px;
    font-size: 15px;
}

.form-control:focus, .form-select:focus {
    border-color: #05a081;
    box-shadow: 0 0 0 3px rgba(5, 160, 129, 0.1);
    outline: none;
}

.tag-pill {
    display: inline-block;
    padding: 8px 16px;
    margin: 4px;
    background-color: #e5e7eb;
    border-radius: 20px;
    font-size: 14px;
    color: #374151;
}

.tag-pill .remove-tag {
    margin-left: 8px;
    color: var(--gray-400);
    cursor: pointer;
    font-weight: bold;
}

.tag-pill .remove-tag:hover {
    color: #ef4444;
}

#tag-autocomplete {
    position: absolute;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: 4px;
}

.autocomplete-item {
    padding: 12px;
    cursor: pointer;
    font-size: 14px;
    color: #374151;
}

.autocomplete-item:hover {
    background-color: #f3f4f6;
}

.submit-section {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 30px;
    gap: 20px;
}

.btn-submit {
    background-color: #05a081;
    color: white;
    border: none;
    padding: 12px 40px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-submit:hover {
    background-color: #048a6f;
}

.btn-submit:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
    opacity: 0.7;
}

.btn-delete {
    background-color: transparent;
    color: #ef4444;
    border: 1px solid #ef4444;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-delete:hover {
    background-color: #fef2f2;
}

.helper-text {
    font-size: 13px;
    color: #6b7280;
    margin-top: 6px;
}

/* L8-STEP2-PERF: AI Suggestions Loading States */
.ai-loading-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background-color: #f3f4f6;
    border-radius: 8px;
    margin-bottom: 12px;
}

.ai-loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e5e7eb;
    border-top-color: #05a081;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.ai-loading-text {
    font-size: 14px;
    color: #6b7280;
}

.ai-error-container {
    padding: 12px 16px;
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    margin-bottom: 12px;
    color: #dc2626;
    font-size: 14px;
}

.ai-error-container button {
    background: none;
    border: none;
    color: #dc2626;
    text-decoration: underline;
    cursor: pointer;
    font-size: 14px;
    padding: 0;
    margin-left: 8px;
}

.ai-error-container button:hover {
    color: #b91c1c;
}

/* N2: Approved indicator fade animation */
@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    75% { opacity: 1; }
    100% { opacity: 0; }
}

.fade-notification {
    animation: fadeInOut 4s ease-in-out forwards;
}

/* N2: Toast notification for flagged content */
.toast-notification {
    position: fixed;
    bottom: 24px;
    right: 24px;
    max-width: 560px;
    padding: 16px 20px;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1050;
    display: none;
    animation: toastSlideIn 0.3s ease-out;
}

.toast-notification.show {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

@keyframes toastSlideIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

/* Mobile: full width at bottom */
@media (max-width: 576px) {
    .toast-notification {
        left: 12px;
        right: 12px;
        bottom: 12px;
        max-width: none;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- PHASE N2: Flagged Content Banner (Top of Page) -->
<div class="container mt-3">
    <div id="nsfw-flagged-banner" class="alert alert-warning d-none" role="alert"
         style="background-color: #fff3cd; border: 1px solid #ffeaa7;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Content flagged for admin review</strong> - you may still submit
    </div>
</div>


<div class="upload-container fade-in">
    <!-- Error Alert (profanity detection) -->
    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 30px;">
        {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Warning Banner (before header) -->
    {% if image_warning %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert" style="margin-bottom: 30px;">
        {{ image_warning|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="text-center mb-5">
        <a href="{% url 'prompts:upload_step1' %}" style="color: #6b7280; text-decoration: none; font-size: 14px;">
            <i class="fas fa-arrow-left me-2"></i> Back
        </a>
        <h1 class="mt-3" style="font-size: 28px; font-weight: 400; color: #1f2937;">
            Make your prompts easy to find and be seen
        </h1>
        <p class="text-muted" style="font-size: 16px; color: #6b7280;">
            Add keywords that describe your prompt
        </p>
    </div>

    <!-- Image Preview + Form Wrapper -->
    <div class="preview-and-form">
        <!-- Image Preview -->
        <div class="image-preview-container">
            {% if resource_type == 'video' %}
                <video src="{{ secure_url }}" class="image-preview" controls></video>
            {% else %}
                <img src="{{ secure_url }}" class="image-preview" alt="Uploaded preview">
            {% endif %}
        </div>

        <!-- Form -->
        <div class="form-container">
            <form method="post" action="{% url 'prompts:upload_submit' %}" id="upload-form">
            {% csrf_token %}
            <input type="hidden" name="cloudinary_id" value="{{ cloudinary_id }}">
            <input type="hidden" name="resource_type" value="{{ resource_type }}">
            <input type="hidden" name="tags" id="tags-hidden">
            <input type="hidden" name="original_ai_tags" value="{% for tag in ai_tags %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}">

            <!-- Hidden fields for B2 variant URLs (populated by variants AJAX) -->
            <input type="hidden" name="variant_thumb_url" id="variant_thumb_url" value="">
            <input type="hidden" name="variant_medium_url" id="variant_medium_url" value="">
            <input type="hidden" name="variant_large_url" id="variant_large_url" value="">
            <input type="hidden" name="variant_webp_url" id="variant_webp_url" value="">

            <!-- L10b: AI failure flag for SEO review -->
            <input type="hidden" name="ai_failed" id="ai_failed_flag" value="false">

            <!-- Tags -->
            <div class="mb-4">
                <label class="form-label">
                    Tags <span style="color: var(--gray-400);">(optional)</span>
                </label>
                <p class="helper-text mb-2">
                    {% if resource_type == 'video' %}Add relevant tags to describe your video{% else %}Suggested tags (you can edit or add your own){% endif %}
                </p>

                <!-- L8-STEP2-PERF: AI Suggestions Loading State -->
                <div id="ai-suggestions-loading" class="ai-loading-container">
                    <div class="ai-loading-spinner"></div>
                    <span class="ai-loading-text">Analyzing your {% if resource_type == 'video' %}video{% else %}image{% endif %} for suggested tags...</span>
                </div>

                <!-- L8-STEP2-PERF: AI Suggestions Error State (hidden by default) -->
                <div id="ai-suggestions-error" class="ai-error-container" style="display: none;">
                    <span id="ai-error-message"></span>
                    <button type="button" onclick="fetchAISuggestions()">Retry</button>
                </div>

                <!-- L8-STEP2-PERF: NSFW Warning Container (hidden by default) -->
                <div id="ai-image-warning" class="alert alert-warning" style="display: none; margin-bottom: 12px;"></div>

                <div id="tags-container" class="mb-3" data-preserved-tags="{{ tags_input|default:'' }}" style="display: none;">
                    {# Tags will be populated by AJAX - no longer server-rendered #}
                </div>
                <div style="position: relative;">
                    <input
                        type="text"
                        class="form-control"
                        id="tag-input"
                        placeholder="{% if resource_type == 'video' %}Add tags to describe your video (max 7)...{% else %}Add tags (max 7)...{% endif %}"
                        autocomplete="off"
                    >
                    <div id="tag-autocomplete" style="display: none;"></div>
                </div>
                <p class="helper-text">Maximum 7 tags</p>
            </div>

            <!-- Prompt Content (User's actual prompt) -->
            <div class="mb-4">
                <label for="content" class="form-label">
                    Prompt Content <span style="color: #ef4444;">*</span>
                </label>
                <textarea
                    class="form-control"
                    id="content"
                    name="content"
                    rows="8"
                    required
                    placeholder="{% if resource_type == 'video' %}Enter the prompt you used to generate this video...{% else %}Enter the prompt you used to generate this image...{% endif %}"
                >{{ prompt_content|default:'' }}</textarea>
                <p class="helper-text">Required - Enter the exact prompt you used</p>
            </div>

            <!-- AI Generator -->
            <div class="mb-4">
                <label for="ai_generator" class="form-label">
                    AI Generator <span style="color: #ef4444;">*</span>
                </label>
                <select class="form-select" id="ai_generator" name="ai_generator" required>
                    <option value="">Select AI generator...</option>
                    <option value="Midjourney" {% if ai_generator == 'Midjourney' %}selected{% endif %}>Midjourney</option>
                    <option value="DALL-E 3" {% if ai_generator == 'DALL-E 3' %}selected{% endif %}>DALL-E 3</option>
                    <option value="DALL-E 2" {% if ai_generator == 'DALL-E 2' %}selected{% endif %}>DALL-E 2</option>
                    <option value="Stable Diffusion" {% if ai_generator == 'Stable Diffusion' %}selected{% endif %}>Stable Diffusion</option>
                    <option value="Leonardo AI" {% if ai_generator == 'Leonardo AI' %}selected{% endif %}>Leonardo AI</option>
                    <option value="Flux" {% if ai_generator == 'Flux' %}selected{% endif %}>Flux</option>
                    <option value="Adobe Firefly" {% if ai_generator == 'Adobe Firefly' %}selected{% endif %}>Adobe Firefly</option>
                    <option value="Bing Image Creator" {% if ai_generator == 'Bing Image Creator' %}selected{% endif %}>Bing Image Creator</option>
                    <option value="Other" {% if ai_generator == 'Other' %}selected{% endif %}>Other</option>
                </select>
            </div>

            {# Save as Draft Toggle #}
            <div class="mb-4">
                <label class="form-label fw-bold">Visibility</label>
                <div class="form-check form-switch form-switch-lg">
                    <input class="form-check-input" type="checkbox" role="switch"
                           id="save_as_draft" name="save_as_draft" value="1">
                    <label class="form-check-label" for="save_as_draft">
                        <i class="fas fa-eye-slash me-1" aria-hidden="true"></i>
                        Save as draft
                        <span class="toggle-status draft" id="draft-status-text">(private, only you can see)</span>
                    </label>
                </div>
                <div class="toggle-helper-text">
                    <span id="visibility-helper">
                        Leave unchecked to publish immediately after moderation review.
                    </span>
                </div>
            </div>

            <!-- PHASE N2: NSFW Moderation Status Indicator -->
            <div id="nsfw-status-container" class="mb-3">
                <div id="nsfw-checking" class="d-flex align-items-center gap-2 p-3 rounded" 
                    style="background-color: #f3f4f6; border: 1px solid #e5e7eb;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Checking...</span>
                    </div>
                    <span style="color: #6b7280; font-size: 14px;">Checking content safety...</span>
                </div>
                
                <div id="nsfw-approved" class="align-items-center gap-2 p-3 rounded d-none" 
                    style="background-color: #ecfdf5; border: 1px solid #a7f3d0;">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    <span style="color: #047857; font-size: 14px;">Content approved - ready to submit</span>
                </div>
                
                <div id="nsfw-flagged" class="align-items-center gap-2 p-3 rounded d-none" 
                    style="background-color: #fef3c7; border: 1px solid #fcd34d;">
                    <i class="fas fa-exclamation-triangle" style="color: #d97706;"></i>
                    <span style="color: #92400e; font-size: 14px;">Content flagged for admin review - you may still submit</span>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
                <button type="button" class="btn-delete" id="delete-upload">
                    <svg class="icon icon-sm me-2" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg> Delete this upload
                </button>
                <span style="color: var(--gray-400);">(1/1)</span>
                <button type="submit" class="btn-submit" id="submit-btn" disabled>
                    <span id="submit-spinner" class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                    <span id="submit-text">Submit your content</span>
                </button>
            </div>
        </form>
        </div>
    </div>

    <!-- PHASE N2: Flagged Toast Notification (Fixed Position) -->
    <div id="nsfw-flagged-toast" class="toast-notification" role="alert" aria-live="polite">
        <i class="fas fa-exclamation-triangle" style="color: #d97706; flex-shrink: 0; margin-top: 2px;"></i>
        <div>
            <strong style="color: #92400e;">Content flagged for admin review</strong>
            <p style="color: #92400e; margin: 4px 0 0 0; font-size: 14px;">
                You may still submit - our team will review before publishing.
            </p>
        </div>
    </div>

    <!-- Modal 1: "Still working on this?" -->
    <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="warningModalLabel">
                        <i class="fas fa-clock"></i> Still working on this?
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <p class="lead">Your upload session will expire in</p>
                    <h1 class="display-4 text-danger"><strong id="countdown">30</strong></h1>
                    <p class="text-muted">seconds</p>
                    <p>Click below to continue editing or cancel this upload.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg" onclick="extendTime()">
                        <i class="fas fa-check-circle"></i> Yes, I need more time
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="cancelUpload()">
                        Cancel Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 2: "Upload Session Expired" -->
    <div class="modal fade" id="expiredModal" tabindex="-1" aria-labelledby="expiredModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="expiredModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> Upload Session Expired
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-hourglass-bottom text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="lead">Your upload session ended due to inactivity.</p>
                    <p class="text-muted">Don't worry - you can start a new upload anytime!</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" onclick="goHome()">
                        <i class="fas fa-home"></i> Got it, take me home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Leave Modal -->
    <div class="modal fade" id="confirmLeaveModal" tabindex="-1" aria-labelledby="confirmLeaveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="confirmLeaveModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> Leave this page?
                    </h5>
                </div>
                <div class="modal-body">
                    <p>You have an upload in progress. If you leave now:</p>
                    <ul>
                        <li>Your uploaded image/video will be deleted</li>
                        <li>Any information you entered will be lost</li>
                    </ul>
                    <p class="mb-0"><strong>Are you sure you want to leave?</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="stayOnPage()">
                        <i class="bi bi-arrow-left"></i> Stay and continue editing
                    </button>
                    <button type="button" class="btn btn-danger" onclick="leaveAndDelete()">
                        <i class="bi bi-trash"></i> Yes, leave and delete upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PHASE N2: Content Rejected Modal -->
    <div class="modal fade" id="contentRejectedModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-times-circle me-2"></i>Content Not Allowed
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-ban text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="mb-3">This content cannot be uploaded</h4>
                    <p class="text-muted mb-3" id="rejection-reason">
                        Your upload contains content that violates our community guidelines.
                    </p>
                    <p class="small text-muted">
                        Please review our <a href="/about/" target="_blank">content guidelines</a> 
                        and try uploading different content.
                    </p>
                </div>
                <div class="modal-footer justify-content-center">
                    <a href="{% url 'prompts:upload_step1' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Start New Upload
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('=== NAVIGATION GUARD DIAGNOSTIC ===');
console.log('Document ready state:', document.readyState);
console.log('Bootstrap available:', typeof bootstrap);

// Tag autocomplete data
const ALL_TAGS = {{ all_tags|safe }};

// SINGLE DECLARATION BLOCK - No duplicates
let hasUnsavedChanges = true;
let isSubmitting = false;
let sessionExpired = false;
let idleTimer = null;
let countdownInterval = null;
let countdownSeconds = 30;
let navigationWarningActive = false;
let pausedCountdownSeconds = 0;

// L8-FIX: Variant tracking for submit optimization
let variantsComplete = {% if not pending_variants %}true{% else %}false{% endif %};
let variantCheckInProgress = false;

const IDLE_TIME = 1 * 60 * 1000;  // 1 minute for testing
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

console.log('Variables initialized:', {
    hasUnsavedChanges,
    isSubmitting,
    sessionExpired
});
console.log('=== END DIAGNOSTIC ===');

// CC_SPEC_NSFW_STEP1_BLOCKING: Check for content warning from Step 1 moderation
// If content was flagged (not rejected), show yellow warning banner on Step 2
(function() {
    const warningData = sessionStorage.getItem('upload_content_warning');
    if (warningData) {
        try {
            const warning = JSON.parse(warningData);

            // L10b-FIX4: WHITELIST APPROACH - Only show banner for actual NSFW content warnings
            // Processing errors, API errors, timeouts should NOT show any banner to users
            // These are backend issues - users should be completely oblivious to them
            const nsfwKeywords = [
                'nsfw', 'explicit', 'adult', 'violence', 'gore',
                'nudity', 'sexual', 'suggestive', 'mature', 'sensitive'
            ];

            // Check if this is an actual content warning (not a processing error)
            const explanation = (warning.explanation || '').toLowerCase();
            const categories = (warning.categories || []).map(c => c.toLowerCase());

            // Only show if explanation or categories contain NSFW-related terms
            const isActualContentWarning =
                nsfwKeywords.some(keyword => explanation.includes(keyword)) ||
                nsfwKeywords.some(keyword => categories.some(cat => cat.includes(keyword)));

            if (isActualContentWarning) {
                // Filter out technical categories from display (defense in depth)
                const technicalCategories = ['api_error', 'timeout', 'processing_error'];
                const userCategories = categories.filter(
                    cat => !technicalCategories.includes(cat)
                );

                // Build warning message
                let message = 'Content Notice: ' + (warning.explanation || 'This content may require manual review.');
                if (userCategories.length > 0) {
                    message += ' (Flagged for: ' + userCategories.join(', ') + ')';
                }

                // Display warning using existing showWarningAlert function
                setTimeout(() => {
                    if (typeof showWarningAlert === 'function') {
                        showWarningAlert(message);
                    } else {
                        console.warn('[NSFW] showWarningAlert not available, creating inline warning');
                        const alertEl = document.createElement('div');
                        alertEl.className = 'alert alert-warning alert-dismissible fade show';
                        alertEl.setAttribute('role', 'alert');
                        alertEl.style.marginBottom = '30px';
                        alertEl.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
                        const container = document.querySelector('.upload-container');
                        if (container) container.insertBefore(alertEl, container.firstChild);
                    }
                }, 100);
                console.log('[NSFW] Displayed content warning from Step 1:', warning);
            } else {
                // Processing error or non-NSFW issue - log but don't show banner
                console.log('[NSFW] Suppressed non-content warning (processing error):', warning);
            }
        } catch (e) {
            console.error('[NSFW] Failed to parse warning data:', e);
        }
        // Clear the sessionStorage item after processing
        sessionStorage.removeItem('upload_content_warning');
    }
})();

// Background variant generation (L8: Upload Performance Optimization)
// When quick_mode is used, original + thumb are uploaded first for fast redirect.
// Remaining variants (medium, large, webp) are generated in background while user fills form.
{% if pending_variants %}
(function() {
    console.log('[Variants] Starting background variant generation...');

    fetch('{% url "prompts:b2_generate_variants" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        // L8-DIRECT-FIX: Check HTTP status before parsing JSON
        if (!response.ok) {
            console.warn('[Variants] HTTP error:', response.status, response.statusText);
            variantsComplete = true;  // Allow submit on error
            // Dispatch event for any listeners
            document.dispatchEvent(new CustomEvent('variantsComplete', { detail: { success: false, error: 'HTTP ' + response.status } }));
            return null;  // Skip JSON parsing
        }
        return response.json();
    })
    .then(data => {
        if (!data) return;  // Already handled in status check
        if (data.success) {
            console.log('[Variants] Background generation complete:', data.urls);
            variantsComplete = true;

            // Populate hidden form fields with variant URLs for reliable POST submission
            if (data.urls) {
                if (data.urls.thumb) document.getElementById('variant_thumb_url').value = data.urls.thumb;
                if (data.urls.medium) document.getElementById('variant_medium_url').value = data.urls.medium;
                if (data.urls.large) document.getElementById('variant_large_url').value = data.urls.large;
                if (data.urls.webp) document.getElementById('variant_webp_url').value = data.urls.webp;
                console.log('[Variants] Hidden form fields populated with variant URLs');
            }

            document.dispatchEvent(new CustomEvent('variantsComplete', { detail: { success: true, urls: data.urls } }));
        } else {
            console.warn('[Variants] Generation failed:', data.error);
            variantsComplete = true;  // Allow submit even on failure
            document.dispatchEvent(new CustomEvent('variantsComplete', { detail: { success: false, error: data.error } }));
        }
    })
    .catch(error => {
        console.error('[Variants] Network error:', error);
        variantsComplete = true;  // Allow submit even on error
        document.dispatchEvent(new CustomEvent('variantsComplete', { detail: { success: false, error: error.message } }));
    });
})();
{% endif %}

// =============================================================================
// L8-STEP2-PERF: Fetch AI Suggestions via AJAX
// =============================================================================
// Previously these AI calls blocked page load (~8 seconds).
// Now they run in background while user can start filling form.

let aiSuggestionsComplete = false;

function fetchAISuggestions() {
    console.log('[AI Suggestions] Starting deferred AI analysis...');

    const loadingEl = document.getElementById('ai-suggestions-loading');
    const errorEl = document.getElementById('ai-suggestions-error');
    const tagsContainer = document.getElementById('tags-container');
    const warningEl = document.getElementById('ai-image-warning');

    // Show loading, hide error and tags
    loadingEl.style.display = 'flex';
    errorEl.style.display = 'none';
    tagsContainer.style.display = 'none';
    warningEl.style.display = 'none';

    fetch('{% url "prompts:ai_suggestions" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Server error: ' + response.status);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('[AI Suggestions] Response:', data);

        // Hide loading
        loadingEl.style.display = 'none';

        if (data.success) {
            aiSuggestionsComplete = true;

            // L10b: Check if AI failed and set hidden flag
            if (data.ai_failed) {
                const aiFailedFlag = document.getElementById('ai_failed_flag');
                if (aiFailedFlag) {
                    aiFailedFlag.value = 'true';
                    console.log('[AI Suggestions] AI failed flag set to true');
                }
            }

            // Show NSFW warning if present
            if (data.warning) {
                warningEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.warning;
                warningEl.style.display = 'block';
                console.log('[AI Suggestions] NSFW warning displayed');
            }

            // Populate tags
            const tags = data.suggestions.tags || [];
            if (tags.length > 0) {
                tagsContainer.innerHTML = '';
                tags.forEach(tag => {
                    addTag(tag);
                });
                tagsContainer.style.display = 'block';
                console.log('[AI Suggestions] Added', tags.length, 'tags:', tags);
            } else {
                // No tags suggested, just show empty container
                tagsContainer.style.display = 'block';
                console.log('[AI Suggestions] No tags suggested');
            }

            // L10b-FIX2: No user-facing message - user should be oblivious to AI failures
            // Hidden ai_failed_flag is already set above for SEO review

            // Update hidden original_ai_tags field for form submission
            const originalTagsField = document.querySelector('input[name="original_ai_tags"]');
            if (originalTagsField) {
                originalTagsField.value = tags.join(', ');
            }

            // Dispatch event for any listeners
            document.dispatchEvent(new CustomEvent('aiSuggestionsComplete', {
                detail: { success: true, suggestions: data.suggestions, warning: data.warning }
            }));
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('[AI Suggestions] Error:', error);

        // Hide loading (don't show red error box - user should be oblivious)
        loadingEl.style.display = 'none';
        // errorEl stays hidden - we don't show scary red errors for AI failures

        // Set ai_failed flag for SEO review (L10b)
        const aiFailedFlag = document.getElementById('ai_failed_flag');
        if (aiFailedFlag) {
            aiFailedFlag.value = 'true';
        }

        // Show tags container so user can add manually
        tagsContainer.style.display = 'block';

        // L10b-FIX2: No user-facing message - user should be oblivious to AI failures
        // Hidden ai_failed_flag is already set above for SEO review

        aiSuggestionsComplete = true;  // Don't block submit on error

        document.dispatchEvent(new CustomEvent('aiSuggestionsComplete', {
            detail: { success: false, error: error.message }
        }));
    });
}

// Start fetching AI suggestions when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only fetch if we're not restoring from an error (preserved tags exist)
    const preservedTagsData = document.getElementById('tags-container').dataset.preservedTags;
    if (preservedTagsData && preservedTagsData.trim() !== '') {
        console.log('[AI Suggestions] Skipping - restoring preserved tags from error');
        // Hide loading, show tags container
        document.getElementById('ai-suggestions-loading').style.display = 'none';
        document.getElementById('tags-container').style.display = 'block';
        aiSuggestionsComplete = true;
    } else {
        // Fetch AI suggestions
        fetchAISuggestions();
    }
});
// =============================================================================

// Restore preserved tags on error
const preservedTags = document.getElementById('tags-container').dataset.preservedTags;
if (preservedTags && preservedTags.trim() !== '') {
    document.getElementById('tags-container').innerHTML = '';
    preservedTags.split(',').forEach(tag => {
        const trimmedTag = tag.trim();
        if (trimmedTag) {
            addTag(trimmedTag);
        }
    });
}

// Track form changes (kept for future use if needed)
document.getElementById('upload-form').addEventListener('input', () => {
    // Form tracking can be added here if needed
});

// Tag autocomplete
const tagInput = document.getElementById('tag-input');
const tagAutocomplete = document.getElementById('tag-autocomplete');
const tagsContainer = document.getElementById('tags-container');

tagInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();

    if (query.length < 2) {
        tagAutocomplete.style.display = 'none';
        return;
    }

    const matches = ALL_TAGS.filter(tag =>
        tag.toLowerCase().includes(query)
    ).slice(0, 10);

    if (matches.length > 0) {
        tagAutocomplete.innerHTML = matches.map(tag =>
            `<div class="autocomplete-item" data-tag="${tag}">${tag}</div>`
        ).join('');
        tagAutocomplete.style.display = 'block';
    } else {
        tagAutocomplete.style.display = 'none';
    }
});

// Add tag on autocomplete click
tagAutocomplete.addEventListener('click', (e) => {
    if (e.target.classList.contains('autocomplete-item')) {
        addTag(e.target.dataset.tag);
        tagInput.value = '';
        tagAutocomplete.style.display = 'none';
    }
});

// Add tag on Enter key
tagInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const value = tagInput.value.trim();
        if (value) {
            addTag(value);
            tagInput.value = '';
            tagAutocomplete.style.display = 'none';
        }
    }
});

// L8-ERRORS: Show warning alert at top of page
function showWarningAlert(message) {
    // Remove any existing warning
    const existingWarning = document.getElementById('step2-warning-alert');
    if (existingWarning) existingWarning.remove();

    // Create new warning alert
    const alertEl = document.createElement('div');
    alertEl.id = 'step2-warning-alert';
    alertEl.className = 'alert alert-warning alert-dismissible fade show';
    alertEl.setAttribute('role', 'alert');
    alertEl.setAttribute('aria-live', 'polite');
    alertEl.style.marginBottom = '30px';
    alertEl.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    // Insert at top of upload container
    const container = document.querySelector('.upload-container');
    if (container) {
        container.insertBefore(alertEl, container.firstChild);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Add tag function
function addTag(tagName) {
    const currentTags = document.querySelectorAll('.tag-pill').length;

    if (currentTags >= 7) {
        showWarningAlert('Maximum 7 tags allowed. Remove a tag to add a new one.');
        return;
    }

    // Check duplicate
    const existing = Array.from(document.querySelectorAll('.tag-pill'))
        .find(pill => pill.dataset.tag === tagName);
    if (existing) return;

    // Create pill
    const pill = document.createElement('span');
    pill.className = 'tag-pill';
    pill.dataset.tag = tagName;
    pill.innerHTML = `${tagName} <span class="remove-tag">&times;</span>`;

    pill.querySelector('.remove-tag').addEventListener('click', () => pill.remove());
    tagsContainer.appendChild(pill);
}

// Remove existing tags
document.querySelectorAll('.remove-tag').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.target.closest('.tag-pill').remove();
    });
});

// L8-FIX: Enhanced form submit with spinner and variant polling
document.getElementById('upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();  // Prevent default to handle async

    // Collect tags first
    const tags = Array.from(document.querySelectorAll('.tag-pill'))
        .map(pill => pill.dataset.tag);
    document.getElementById('tags-hidden').value = JSON.stringify(tags);
    hasUnsavedChanges = false;
    isSubmitting = true;

    // Show spinner
    const submitBtn = document.getElementById('submit-btn');
    const spinner = document.getElementById('submit-spinner');
    const submitText = document.getElementById('submit-text');

    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    // L8-FIX: Context-aware spinner text
    const isVideo = '{{ resource_type }}' === 'video';
    submitText.textContent = isVideo ? 'Processing...' :
                             variantsComplete ? 'Submitting...' : 'Optimizing images...';

    // L8-DIRECT-FIX: Event-driven wait for variants (replaces busy-wait polling)
    // If variants not complete, wait for the variantsComplete event with timeout
    if (!variantsComplete && !variantCheckInProgress) {
        variantCheckInProgress = true;
        const maxWait = 5000;  // 5 seconds max

        // Create a promise that resolves when variants complete OR timeout
        await new Promise((resolve) => {
            // If already complete, resolve immediately
            if (variantsComplete) {
                variantCheckInProgress = false;
                resolve();
                return;
            }

            // Set up timeout
            const timeoutId = setTimeout(() => {
                console.log('[Submit] Proceeding without variants (timeout)');
                document.removeEventListener('variantsComplete', onComplete);
                variantCheckInProgress = false;
                resolve();
            }, maxWait);

            // Listen for the variantsComplete event from background fetch
            function onComplete(event) {
                clearTimeout(timeoutId);
                console.log('[Submit] Variants complete via event:', event.detail);
                variantCheckInProgress = false;
                resolve();
            }

            document.addEventListener('variantsComplete', onComplete, { once: true });

            // Also check current state in case event fired before listener attached
            if (variantsComplete) {
                clearTimeout(timeoutId);
                document.removeEventListener('variantsComplete', onComplete);
                variantCheckInProgress = false;
                resolve();
            }
        });
    }

    // Update text and submit
    submitText.textContent = 'Submitting...';
    e.target.submit();  // Actually submit the form
});

// Delete upload button
document.getElementById('delete-upload').addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this upload?')) {
        hasUnsavedChanges = false;
        window.location.href = '/';
    }
});

// Hide autocomplete when clicking outside
document.addEventListener('click', (e) => {
    if (!tagInput.contains(e.target) && !tagAutocomplete.contains(e.target)) {
        tagAutocomplete.style.display = 'none';
    }
});

// ==========================================
// NAVIGATION GUARD
// ==========================================

// Browser warning for external navigation - Enhanced debugging
window.addEventListener('beforeunload', function(e) {
    console.log('BEFOREUNLOAD: Event triggered');
    console.log('BEFOREUNLOAD: hasUnsavedChanges =', hasUnsavedChanges);
    console.log('BEFOREUNLOAD: isSubmitting =', isSubmitting);
    console.log('BEFOREUNLOAD: sessionExpired =', sessionExpired);

    // Also check if variables exist
    console.log('BEFOREUNLOAD: Variables exist:', {
        hasUnsavedChanges: typeof hasUnsavedChanges,
        isSubmitting: typeof isSubmitting,
        sessionExpired: typeof sessionExpired
    });

    if (hasUnsavedChanges && !isSubmitting && !sessionExpired) {
        console.log('BEFOREUNLOAD: Should show warning');
        const message = 'You have unsaved changes. Are you sure you want to leave?';
        e.preventDefault();
        e.returnValue = message;
        return message;
    } else {
        console.log('BEFOREUNLOAD: Not showing warning - state check failed');
    }
});

// Form submission handler
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            console.log('Form submitting - disabling guards');
            isSubmitting = true;
            hasUnsavedChanges = false;
        });
    }
});

// Internal navigation handler
document.addEventListener('click', function(e) {
    if (hasUnsavedChanges && !isSubmitting && !sessionExpired) {
        const link = e.target.closest('a');

        if (link &&
            !link.hasAttribute('data-bs-toggle') &&
            !link.hasAttribute('data-bs-dismiss') &&
            link.href &&
            link.href !== '#' &&
            !link.href.startsWith('javascript:') &&
            link.href.includes(window.location.hostname)) {

            console.log('Internal navigation detected - pausing countdown');
            e.preventDefault();
            e.stopPropagation();

            // PAUSE the countdown timer if running
            if (countdownInterval) {
                clearInterval(countdownInterval);
                pausedCountdownSeconds = countdownSeconds;
                navigationWarningActive = true;
                console.log('Countdown paused at:', pausedCountdownSeconds, 'seconds');
            }

            const modalEl = document.getElementById('confirmLeaveModal');
            if (modalEl) {
                const confirmModal = new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: false
                });
                confirmModal.show();
                window.pendingNavigation = link.href;
            }
        }
    }
});

// Modal functions
function stayOnPage() {
    console.log('User chose to stay - resuming countdown');

    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmLeaveModal'));
    if (modal) {
        modal.hide();
    }

    // RESUME countdown if it was paused
    if (navigationWarningActive && pausedCountdownSeconds > 0) {
        navigationWarningActive = false;
        countdownSeconds = pausedCountdownSeconds;

        console.log('Resuming countdown from:', countdownSeconds, 'seconds');
        updateCountdown();

        // Restart the countdown interval
        countdownInterval = setInterval(() => {
            countdownSeconds--;
            updateCountdown();

            if (countdownSeconds <= 0) {
                clearInterval(countdownInterval);
                handleTimeout();
            }
        }, 1000);
    }

    window.pendingNavigation = null;
}

function leaveAndDelete() {
    console.log('Instant leave - bypassing all delays');

    // Disable guards immediately
    hasUnsavedChanges = false;
    isSubmitting = true;

    // Immediate redirect to pending navigation
    window.location.replace(window.pendingNavigation || '/');
}

// ==========================================
// IDLE DETECTION SYSTEM
// ==========================================

console.log('Idle detection initializing...');

function startIdleTimer() {
    if (idleTimer) clearTimeout(idleTimer);

    idleTimer = setTimeout(() => {
        console.log('⏰ Idle time reached - showing warning modal');
        showWarningModal();
    }, IDLE_TIME);

    console.log(`✅ Idle timer started: ${IDLE_TIME / 60000} minute(s)`);
}

function resetIdleTimer() {
    startIdleTimer();
}

function showWarningModal() {
    console.log('Showing idle warning modal');

    // Don't show if navigation warning is active
    if (navigationWarningActive) {
        console.log('Navigation warning active - skipping idle modal');
        return;
    }

    const modalEl = document.getElementById('warningModal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static',
            keyboard: false
        });
        modal.show();

        countdownSeconds = 30;
        updateCountdown();

        countdownInterval = setInterval(() => {
            countdownSeconds--;
            updateCountdown();
            if (countdownSeconds <= 0) {
                clearInterval(countdownInterval);
                handleTimeout();
            }
        }, 1000);
    }
}

function updateCountdown() {
    const countdownEl = document.getElementById('countdown');
    if (countdownEl) {
        countdownEl.textContent = countdownSeconds;
    }
}

function extendTime() {
    console.log('Extending time');
    clearInterval(countdownInterval);

    const modal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
    if (modal) modal.hide();

    fetch('/upload/extend/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(() => {
        console.log('Time extended');
        startIdleTimer();
    })
    .catch(console.error);
}

function cancelUpload() {
    console.log('Instant cancel - bypassing all delays');

    // Disable guards immediately
    hasUnsavedChanges = false;
    isSubmitting = true;
    sessionExpired = true;

    // Stop all timers
    if (countdownInterval) clearInterval(countdownInterval);
    if (idleTimer) clearTimeout(idleTimer);

    // Immediate redirect - no modal animations, no API calls
    window.location.replace('/');
}

function handleTimeout() {
    console.log('Session timed out');

    // CRITICAL: Disable all navigation guards when session expires
    hasUnsavedChanges = false;
    isSubmitting = true;
    sessionExpired = true;

    clearInterval(countdownInterval);
    clearTimeout(idleTimer);

    const modal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
    if (modal) modal.hide();

    fetch('/upload/cancel/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(() => showExpiredModal())
    .catch(() => showExpiredModal());
}

function showExpiredModal() {
    const modalEl = document.getElementById('expiredModal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
}

function goHome() {
    hasUnsavedChanges = false;
    isSubmitting = true;
    sessionExpired = true;

    const modal = bootstrap.Modal.getInstance(document.getElementById('expiredModal'));
    if (modal) modal.hide();

    setTimeout(() => window.location.href = '/', 100);
}

// Test function for browser warning
window.testBrowserWarning = function() {
    console.log('Testing browser warning...');
    console.log('hasUnsavedChanges:', hasUnsavedChanges);
    hasUnsavedChanges = true;
    isSubmitting = false;
    sessionExpired = false;
    console.log('Browser warning should now work. Try closing tab.');
};

// Activity listeners
document.addEventListener('input', startIdleTimer);
document.addEventListener('click', startIdleTimer);
document.addEventListener('keypress', startIdleTimer);

// Initialize
startIdleTimer();
console.log('Navigation guard loaded successfully');
console.log('To test browser warning, run: testBrowserWarning()');

// Toggle switch dynamic helper text
document.addEventListener('DOMContentLoaded', function() {
    const saveAsDraftToggle = document.getElementById('save_as_draft');
    const helperText = document.getElementById('visibility-helper');
    const statusText = document.getElementById('draft-status-text');

    if (saveAsDraftToggle && helperText && statusText) {
        saveAsDraftToggle.addEventListener('change', function() {
            if (this.checked) {
                helperText.textContent = 'Your prompt will be saved privately. You can publish it later.';
                statusText.textContent = '(private, only you can see)';
                statusText.className = 'toggle-status draft';
            } else {
                helperText.textContent = 'Your prompt will be published after moderation review.';
                statusText.textContent = '(public, visible to everyone)';
                statusText.className = 'toggle-status published';
            }
        });
    }
});
</script>

<script>
// PHASE N1: Display local preview from browser memory
document.addEventListener('DOMContentLoaded', function() {
    const localPreviewData = sessionStorage.getItem('localPreviewData');
    const localPreviewType = sessionStorage.getItem('localPreviewType');
    const isVideo = sessionStorage.getItem('localPreviewIsVideo') === 'true';
    
    if (localPreviewData) {
        const previewContainer = document.querySelector('.preview-image, .upload-preview, #preview-container, .card-img-top');
        
        if (previewContainer) {
            if (isVideo) {
                const video = document.createElement('video');
                video.src = localPreviewData;
                video.controls = true;
                video.muted = true;
                video.style.maxWidth = '100%';
                previewContainer.replaceWith(video);
            } else {
                previewContainer.src = localPreviewData;
            }
        }
        
        // Cleanup: Revoke object URL to free memory
        if (localPreviewType === 'objectUrl') {
            URL.revokeObjectURL(localPreviewData);
        }
        
        // Cleanup: Clear sessionStorage
        sessionStorage.removeItem('localPreviewData');
        sessionStorage.removeItem('localPreviewType');
        sessionStorage.removeItem('localPreviewIsVideo');
    }
});
</script>

<script>
// ==========================================
// PHASE N2: NSFW Background Validation
// ==========================================

(function() {
    'use strict';
    
    const POLL_INTERVAL = 2000; // 2 seconds
    const MAX_POLL_ATTEMPTS = 45; // 90 seconds max wait
    
    let pollCount = 0;
    let pollTimer = null;
    let uploadId = null;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    // Get image URL from page (passed from Django)
    const imageUrl = '{{ secure_url|escapejs }}';
    
    // UI Elements
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const nsfwChecking = document.getElementById('nsfw-checking');
    const nsfwApproved = document.getElementById('nsfw-approved');
    const nsfwFlagged = document.getElementById('nsfw-flagged');
    const nsfwFlaggedBanner = document.getElementById('nsfw-flagged-banner'); // Top banner
    const uploadForm = document.getElementById('upload-form');
    
    /**
     * Queue NSFW moderation task
     */
    async function queueNsfwTask() {
        if (!imageUrl) {
            console.error('[N2] No image URL available');
            handleModerationError('Upload data not found');
            return;
        }
        
        try {
            const response = await fetch('/api/upload/nsfw/queue/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ image_url: imageUrl }),
            });
            
            const data = await response.json();
            
            if (data.success && data.upload_id) {
                uploadId = data.upload_id;
                console.log('[N2] NSFW task queued:', uploadId);
                startPolling();
            } else {
                console.error('[N2] Failed to queue task:', data.error);
                handleModerationError('Failed to start content check');
            }
        } catch (error) {
            console.error('[N2] Queue error:', error);
            handleModerationError('Network error during content check');
        }
    }
    
    /**
     * Poll for moderation status
     */
    async function pollStatus() {
        if (!uploadId) return;
        
        pollCount++;
        
        if (pollCount > MAX_POLL_ATTEMPTS) {
            console.warn('[N2] Max poll attempts reached');
            handleModerationError('Content check timed out');
            return;
        }
        
        try {
            const response = await fetch(`/api/upload/nsfw/status/?upload_id=${uploadId}`);
            const data = await response.json();
            
            console.log('[N2] Poll result:', data.status);
            
            if (data.status === 'processing') {
                // Still processing, continue polling
                return;
            }
            
            // Moderation complete - stop polling
            stopPolling();
            
            if (data.status === 'approved') {
                handleApproved();
            } else if (data.status === 'flagged') {
                handleFlagged(data.categories || []);
            } else if (data.status === 'rejected') {
                handleRejected(data.explanation || 'Content violates community guidelines');
            }
            
        } catch (error) {
            console.error('[N2] Poll error:', error);
            // Continue polling on network errors
        }
    }
    
    /**
     * Start polling timer
     */
    function startPolling() {
        pollTimer = setInterval(pollStatus, POLL_INTERVAL);
        // Also do immediate first check
        pollStatus();
    }
    
    /**
     * Stop polling timer
     */
    function stopPolling() {
        if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
        }
    }
    
    /**
     * Handle approved status
     */
    function handleApproved() {
        nsfwChecking.classList.add('d-none');
        nsfwChecking.classList.remove('d-flex');
        
        // Show approved with fade animation
        nsfwApproved.classList.remove('d-none');
        nsfwApproved.classList.add('d-flex', 'fade-notification');
        
        nsfwFlagged.classList.add('d-none');
        nsfwFlagged.classList.remove('d-flex');
        
        // Hide top banner if visible
        if (nsfwFlaggedBanner) {
            nsfwFlaggedBanner.classList.add('d-none');
        }
        
        submitBtn.disabled = false;
        submitText.textContent = 'Submit your content';
        
        console.log('[N2] Content approved');
    }
    
    /**
     * Handle flagged status (light NSFW - can still submit)
     */
    function handleFlagged(categories) {
        nsfwChecking.classList.add('d-none');
        nsfwChecking.classList.remove('d-flex');
        
        nsfwApproved.classList.add('d-none');
        nsfwApproved.classList.remove('d-flex');
        
        // Hide the inline indicator
        nsfwFlagged.classList.add('d-none');
        nsfwFlagged.classList.remove('d-flex');
        
        // Show TOP banner (consistent with site alerts)
        if (nsfwFlaggedBanner) {
            nsfwFlaggedBanner.classList.remove('d-none');
        }
        
        // Show TOAST notification (visible regardless of scroll position)
        const toast = document.getElementById('nsfw-flagged-toast');
        if (toast) {
            toast.classList.add('show');
        }
        
        submitBtn.disabled = false;
        submitText.textContent = 'Submit for review';
        
        console.log('[N2] Content flagged:', categories);
    }
    
    /**
     * Handle rejected status (hardcore NSFW - cannot submit)
     */
    function handleRejected(reason) {
        nsfwChecking.classList.add('d-none');
        nsfwChecking.classList.remove('d-flex');
        
        nsfwApproved.classList.add('d-none');
        nsfwApproved.classList.remove('d-flex');
        
        nsfwFlagged.classList.add('d-none');
        nsfwFlagged.classList.remove('d-flex');
        
        // Update rejection reason in modal
        document.getElementById('rejection-reason').textContent = reason;
        
        // Show rejection modal (non-dismissible)
        const modal = new bootstrap.Modal(document.getElementById('contentRejectedModal'));
        modal.show();
        
        // Disable entire form
        if (uploadForm) {
            const inputs = uploadForm.querySelectorAll('input, textarea, select, button');
            inputs.forEach(el => el.disabled = true);
        }
        
        console.log('[N2] Content rejected:', reason);
    }
    
    /**
     * Handle moderation errors
     */
    function handleModerationError(message) {
        stopPolling();
        
        // On error, fail-closed: show as rejected
        handleRejected(message + '. Please try again with different content.');
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[N2] Starting NSFW validation');
        queueNsfwTask();
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopPolling();
    });
    
    
})();
</script>
{% endblock %}

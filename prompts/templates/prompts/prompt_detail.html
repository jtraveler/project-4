{% extends 'base.html' %}
{% load static %}
{% load cloudinary_tags %}
{% load prompt_tags %}
{% load cache %}

{% block title %}{{ prompt.title }} - {{ prompt.ai_generator }} AI Prompt | PromptFinder{% endblock %}

{% block meta_description %}{{ prompt.description|default:prompt.excerpt|truncatechars:160 }}{% endblock %}

{% block og_tags %}
<meta property="og:site_name" content="PromptFinder">
<meta property="og:title" content="{{ prompt.title }} - {{ prompt.ai_generator }} AI Prompt">
<meta property="og:description" content="{{ prompt.description|default:prompt.excerpt|truncatechars:200 }}">
{% if prompt.display_large_url %}
<meta property="og:image" content="{{ prompt.display_large_url }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="1200">
<meta property="og:image:alt" content="{{ prompt.title }} - {{ prompt.ai_generator }} AI Prompt">
{% endif %}
{% if prompt.is_video and prompt.display_video_url %}
<meta property="og:video" content="{{ prompt.display_video_url }}">
<meta property="og:video:type" content="video/mp4">
<meta property="og:video:secure_url" content="{{ prompt.display_video_url }}">
{% endif %}
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.promptfinder.net{{ request.path }}">
<meta property="article:author" content="{{ prompt.author.username }}">
<meta property="article:published_time" content="{{ prompt.created_on|date:'c' }}">
<meta property="article:modified_time" content="{{ prompt.updated_on|date:'c' }}">
{% endblock og_tags %}

{% block twitter_tags %}
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@promptfinder">
<meta name="twitter:title" content="{{ prompt.title }} - {{ prompt.ai_generator }} AI Prompt">
<meta name="twitter:description" content="{{ prompt.description|default:prompt.excerpt|truncatechars:200 }}">
{% if prompt.display_large_url %}
<meta name="twitter:image" content="{{ prompt.display_large_url }}">
<meta name="twitter:image:alt" content="{{ prompt.title }} - {{ prompt.ai_generator }} AI Prompt">
{% endif %}
{% endblock twitter_tags %}

{% block extra_head %}
<!-- Preconnect to critical origins (DNS + TCP + TLS handshake) -->
<link rel="preconnect" href="https://cdn.promptfinder.net" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- DNS prefetch for non-critical resources -->
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">

<!-- Preload LCP media with full srcset for optimal resource discovery -->
{% if prompt.is_video %}
    <!-- Preload video poster/thumbnail -->
    {% with thumbnail_url=prompt.get_thumbnail_url %}
        {% if thumbnail_url %}
            <link rel="preload" as="image" href="{{ thumbnail_url }}" fetchpriority="high" />
        {% endif %}
    {% endwith %}
{% else %}
    <!-- Preload hero image with responsive hints for LCP optimization -->
    {% if prompt.display_large_url %}
        <link rel="preload" 
              as="image" 
              href="{{ prompt.display_large_url }}"
              imagesrcset="{{ prompt.display_medium_url }} 600w, {{ prompt.display_large_url }} 1200w"
              imagesizes="(max-width: 768px) 100vw, 60vw"
              fetchpriority="high" />
    {% endif %}
{% endif %}

<!-- Critical CSS for above-the-fold content (reduces render-blocking) -->
<style>
/* Critical CSS - Prompt Detail Page */
.prompt-detail-page{max-width:1400px;margin:0 auto;padding:1rem}
.prompt-breadcrumb{margin-bottom:1rem}
.prompt-breadcrumb .breadcrumb{display:flex;flex-wrap:wrap;padding:0;margin:0;list-style:none;font-size:.875rem}
.prompt-breadcrumb .breadcrumb-item+.breadcrumb-item::before{content:"/";padding:0 .5rem;color:#6c757d}
.prompt-breadcrumb .breadcrumb-item a{color:var(--main-blue,#0d6efd);text-decoration:none}
.prompt-content-wrapper{padding:0}
.prompt-left-column{margin-bottom:2rem}
.media-container-shell{position:relative;background:var(--bg-tertiary,#f5f5f5);border-radius:var(--radius-lg,12px);overflow:hidden}
.media-container{position:relative;width:100%}
.hero-image,.hero-video{width:100%;height:auto;display:block;border-radius:var(--radius-lg,12px)}
.prompt-title{font-size:1.75rem;font-weight:700;margin:1rem 0;line-height:1.3;color:var(--text-primary,#1a1a2e)}
.prompt-description{color:var(--text-secondary,#6c757d);line-height:1.6;margin-bottom:1.5rem}
.rail-card{background:var(--bg-primary,#fff);border-radius:var(--radius-lg,12px);padding:1.25rem;margin-bottom:1rem;border:1px solid var(--border-color,#e0e0e0)}
.rail-card-title{font-size:1rem;font-weight:600;margin-bottom:1rem;color:var(--text-primary,#1a1a2e)}
.author-card{display:flex;align-items:center;gap:.75rem}
.author-avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0}
.author-avatar img,.avatar-img{width:100%;height:100%;object-fit:cover}
.avatar-letter{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--main-blue,#0d6efd);color:#fff;font-weight:600;font-size:1.25rem}
@media(min-width:992px){.prompt-left-column{margin-bottom:0}}
</style>

<!-- Non-critical CSS loaded asynchronously -->
<link rel="preload" href="{% static 'css/pages/prompt-detail.css' %}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{% static 'css/pages/prompt-detail.css' %}"></noscript>

<!-- Prevent draft prompts from being indexed -->
{% if prompt.status == 0 %}
<meta name="robots" content="noindex, nofollow">
{% endif %}

<!-- Canonical URL to prevent duplicate content issues -->
<link rel="canonical" href="https://www.promptfinder.net{{ request.path }}">

<!-- Schema.org Structured Data for SEO -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "{% if prompt.is_video %}VideoObject{% else %}ImageObject{% endif %}",
    "name": "{{ prompt.title|escapejs }}",
    "description": "{{ prompt.description|default:prompt.excerpt|truncatechars:300|escapejs }}",
    "contentUrl": "{% if prompt.is_video %}{{ prompt.display_video_url|default:'' }}{% else %}{{ prompt.display_large_url|default:'' }}{% endif %}",
    "thumbnailUrl": "{% if prompt.is_video %}{{ prompt.display_video_thumb_url|default:prompt.display_medium_url|default:'' }}{% else %}{{ prompt.display_medium_url|default:prompt.display_large_url|default:'' }}{% endif %}",
    {% if prompt.is_video and prompt.video_duration %}"duration": "PT{{ prompt.video_duration|floatformat:0 }}S",{% endif %}
    "author": {
        "@type": "Person",
        "name": "{{ prompt.author.username|escapejs }}",
        "url": "https://www.promptfinder.net{% url 'prompts:user_profile' prompt.author.username %}"
    },
    "datePublished": "{{ prompt.created_on|date:'c' }}",
    "dateModified": "{{ prompt.updated_on|date:'c' }}",
    {% if prompt.tags.all %}"keywords": "{% for tag in prompt.tags.all %}{{ tag.name|escapejs }}{% if not forloop.last %}, {% endif %}{% endfor %}",{% endif %}
    "creator": {
        "@type": "Organization",
        "name": "PromptFinder",
        "url": "https://www.promptfinder.net"
    }
}
</script>

<!-- BreadcrumbList Schema for SERP breadcrumbs -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https://www.promptfinder.net/"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "{{ prompt.ai_generator|escapejs }}",
            "item": "https://www.promptfinder.net/?search={{ prompt.ai_generator|urlencode }}"
        },
        {
            "@type": "ListItem",
            "position": 3,
            "name": "{{ prompt.title|truncatechars:50|escapejs }}",
            "item": "https://www.promptfinder.net{{ request.path }}"
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<div class="prompt-detail-page container">
{# Draft banner handled in base.html notification container #}



            <!-- Visual Breadcrumb Navigation (matches BreadcrumbList JSON-LD) -->
            <nav aria-label="Breadcrumb" class="prompt-breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="/">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/?search={{ prompt.ai_generator|urlencode }}">{{ prompt.ai_generator }}</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        {{ prompt.title }}
                    </li>
                </ol>
            </nav>
<!-- ============================================================
     SIDE-BY-SIDE LAYOUT (PromptHero Style)
     Left Column: Image, Actions, Title, Description, Comments
     Right Rail: Author Card, Stats, Details, Prompt, Tags
     ============================================================ -->
<div class="container prompt-content-wrapper">
    <div class="row">
        <!-- ========================================
             LEFT COLUMN (col-lg-7)
             Image at TOP, then content below
             ======================================== -->
        <div class="col-lg-7 prompt-left-column">

            <!-- Featured Media (Image/Video) - NOW IN LEFT COLUMN -->
            <div class="media-container-shell prompt-media-container-shell">
                <div class="media-container prompt-media-container">
                    {% if prompt.display_video_url %}
                        <!-- Video Display (B2 or Cloudinary) -->
                        <video controls class="hero-video"
                            aria-label="{{ prompt.title }} - {{ prompt.ai_generator }} AI Video Prompt"
                            poster="{{ prompt.display_video_thumb_url|default:prompt.get_thumbnail_url }}"
                            preload="metadata"
                            autoplay
                            loop
                            muted
                            {% if prompt.video_width and prompt.video_height %}
                            style="aspect-ratio: {{ prompt.video_width }} / {{ prompt.video_height }};"
                            width="{{ prompt.video_width }}"
                            height="{{ prompt.video_height }}"
                            {% endif %}>
                            <source src="{{ prompt.display_video_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% elif prompt.display_large_url %}
                        <!-- Image Display (B2 or Cloudinary) -->
                        <img src="{{ prompt.display_large_url }}"
                             srcset="{{ prompt.display_medium_url }} 600w,
                                     {{ prompt.display_large_url }} 1200w"
                             sizes="(max-width: 768px) 100vw,
                                    60vw"
                             class="hero-image"
                             alt="{{ prompt.title }} - {{ prompt.ai_generator }} AI Art Prompt for Image Generation"
                             width="1200"
                             height="1200"
                             loading="eager"
                             fetchpriority="high">
                    {% elif prompt.featured_image %}
                        <!-- Fallback: Direct Cloudinary URL -->
                        {% if "placeholder" in prompt.featured_image.url %}
                            <img src="{% static 'images/placeholder-prompt.svg' %}"
                                 class="hero-image"
                                 alt="{{ prompt.title }} - No image available"
                                 loading="eager"
                                 style="background-color: #f0f0f0; object-fit: contain;">
                        {% else %}
                            <img src="{{ prompt.featured_image.url|cloudinary_transform:'w_1200,c_limit,f_webp,q_90' }}"
                                 class="hero-image"
                                 alt="{{ prompt.title }} - {{ prompt.ai_generator }} AI Art Prompt for Image Generation"
                                 width="1200"
                                 height="1200"
                                 loading="eager"
                                 fetchpriority="high">
                        {% endif %}
                    {% else %}
                        <!-- No media available -->
                        <div class="alert alert-warning mb-3" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Media Missing</strong>
                            <p class="mb-2">This prompt is missing its image or video.</p>
                            {% if user.is_authenticated and user == prompt.author %}
                                <a href="{% url 'prompts:prompt_edit' prompt.slug %}" class="btn btn-sm btn-primary">
                                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-edit"/></svg> Edit Prompt to Add Media
                                </a>
                            {% endif %}
                        </div>
                        <img src="{% static 'images/placeholder-prompt.svg' %}"
                             class="hero-image"
                             alt="{{ prompt.title }} - No image available"
                             loading="eager"
                             style="background-color: #f0f0f0; object-fit: contain;">
                    {% endif %}
                </div>
            </div>

            <!-- Title -->
            <h1 class="prompt-title">
                {{ prompt.title }}
                {% if prompt.is_video %}
                <span class="media-type-indicator">
                    <i class="fas fa-video"></i>
                    Video
                </span>
                {% endif %}
            </h1>

            <!-- Description (show full AI-generated description for SEO, fallback to excerpt) -->
            {% if prompt.description %}
            <div class="prompt-description">
                {{ prompt.description|linebreaks }}
            </div>
            {% elif prompt.excerpt %}
            <div class="prompt-description">
                {{ prompt.excerpt|linebreaks }}
            </div>
            {% endif %}

        </div>

        <!-- ========================================
             RIGHT RAIL (col-lg-5)
             Starts at SAME level as image
             ======================================== -->
        <div class="col-lg-5 prompt-right-rail">

            <!-- Author Card (PromptHero Style - Two Column Layout) -->
            <div class="rail-card author-details-combined">
                <div class="author-details-row">
                    <!-- First Row: Avatar + Follow Button (flex container) -->
                    <div class="author-first-row">
                        <!-- Left Column: Avatar + Info -->
                        <div class="author-card">
                            <div class="author-avatar">
                                {% if prompt.author.userprofile.avatar and prompt.author.userprofile.avatar.url %}
                                    <img src="{{ prompt.author.userprofile.avatar.url }}"
                                         alt="{{ prompt.author.username }}'s avatar"
                                         class="avatar-img"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                    <span class="avatar-letter" style="display: none;">{{ prompt.author.username|first|upper }}</span>
                                {% else %}
                                    <span class="avatar-letter">{{ prompt.author.username|first|upper }}</span>
                                {% endif %}
                            </div>
                            <div class="author-info">
                                <a href="{% url 'prompts:user_profile' prompt.author.username %}" class="author-name">
                                    @{{ prompt.author.username }}
                                </a>
                                <span class="post-time">{{ prompt.created_on|simple_timesince }}</span>
                            </div>
                        </div>
                        <!-- Right Column: Follow Button -->
                        <div class="author-card-right">
                            {% if user.is_authenticated and user != prompt.author %}
                            <button class="btn-outline-standard follow-btn {% if is_following_author %}following{% endif %}"
                                    data-username="{{ prompt.author.username }}"
                                    data-following="{{ is_following_author|yesno:'true,false' }}"
                                    aria-label="{% if is_following_author %}Unfollow{% else %}Follow{% endif %} {{ prompt.author.username }}">
                                <span class="btn-text">{% if is_following_author %}Following{% else %}Follow{% endif %}</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                            {% elif not user.is_authenticated %}
                            <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-outline-standard follow-btn" aria-label="Log in to follow">
                                Follow
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Views Row (block-level sibling, naturally on new line) -->
                    {% if can_see_views %}
                    <div class="views-row">
                        <span class="views-count" aria-label="Views" title="Views">
                            <i class="fas fa-eye" aria-hidden="true"></i>
                            {{ view_count }} views
                        </span>
                    </div>
                    {% endif %}
                </div>
                <!-- Action Icons Row -->
                <div class="author-card-actions">
                    {% if not is_processing %}
                    <!-- Save to Collection Button (hidden during processing) -->
                    {% if user.is_authenticated %}
                    <button type="button"
                            class="btn-outline-standard action-icon-btn"
                            id="savePromptBtn"
                            data-action="open-collections-modal"
                            data-prompt-id="{{ prompt.id }}"
                            title="Save to collection">
                        <svg class="icon icon-sm" aria-hidden="true">
                            <use href="{% static 'icons/sprite.svg' %}#icon-bookmark"/>
                        </svg>
                    </button>
                    {% endif %}

                    <!-- Comment Button (hidden during processing) -->
                    <button class="btn-outline-standard action-icon-btn" onclick="scrollToComments()" aria-label="Scroll to comments" title="Comments">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-comment"/></svg>
                    </button>

                    <!-- Like Button (hidden during processing) -->
                    {% if user.is_authenticated %}
                        <button class="btn-outline-standard action-icon-btn like-btn-detail {% if prompt_is_liked %}liked{% endif %}"
                                data-prompt-slug="{{ prompt.slug }}"
                                onclick="toggleLike(this)"
                                aria-label="{{ number_of_likes }} like{{ number_of_likes|pluralize }}, {% if prompt_is_liked %}unlike{% else %}like{% endif %}"
                                title="Like">
                            <!-- Outline heart (shown when NOT liked) -->
                            <svg class="icon icon-sm heart-outline" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-heart"/></svg>
                            <!-- Filled heart (shown when liked) -->
                            <svg class="icon icon-sm heart-filled" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-heart-filled"/></svg>
                            <span class="action-count like-count">{{ number_of_likes }}</span>
                        </button>
                    {% else %}
                        <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-outline-standard action-icon-btn like-btn-detail" aria-label="{{ number_of_likes }} like{{ number_of_likes|pluralize }}, log in to like" title="Like">
                            <svg class="icon icon-sm heart-outline" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-heart"/></svg>
                            <span class="action-count like-count">{{ number_of_likes }}</span>
                        </a>
                    {% endif %}
                    {% endif %}

                    <!-- Edit Button (only for author) -->
                    {% if user.is_authenticated and prompt.author == user %}
                    <a href="{% url 'prompts:prompt_edit' prompt.slug %}" class="btn-outline-standard action-icon-btn" aria-label="Edit" title="Edit">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-edit"/></svg>
                    </a>

                    <!-- Delete Button (only for author) -->
                    <button class="btn-outline-standard action-icon-btn"
                            onclick="confirmDelete('{% url 'prompts:prompt_delete' prompt.slug %}')"
                            aria-label="Delete" title="Delete">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>
                    </button>
                    {% endif %}

                    <!-- Report Button (authenticated, not author) -->
                    {% if user.is_authenticated and prompt.author != user %}
                    <button class="btn-outline-standard action-icon-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#reportModal"
                            aria-label="Report" title="Report">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-flag"/></svg>
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- MODEL USED Section (Separate Card) -->
            <div class="rail-card model-used-card">
                <h2 class="rail-card-title">Model Used</h2>
                <div class="model-used-row">
                    <div class="model-used-info">
                        <a href="{% url 'prompts:ai_generator_category' prompt.get_generator_url_slug %}" class="model-name">
                            <i class="fas fa-robot"></i>
                            {{ prompt.get_ai_generator_display|default:"Not specified" }}
                        </a>
                        <span class="model-type">
                            {% if prompt.is_video %}
                            <i class="fas fa-video"></i>
                            Video
                            {% else %}
                            <i class="fas fa-image"></i>
                            Image
                            {% endif %}
                        </span>
                    </div>
                    {% if prompt.get_generator_url %}
                    <a href="{{ prompt.get_generator_url }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="btn-outline-standard btn-affiliate action-icon-btn"
                       aria-label="Try in {{ prompt.get_ai_generator_display }} (opens in new tab)">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-external-link"/></svg>
                        <span>Try in {{ prompt.get_ai_generator_display }}</span>
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Prompt Text Card -->
            <div class="rail-card prompt-card">
                <div class="prompt-card-header">
                    <h2 class="rail-card-title">Prompt</h2>
                    {% if user.is_authenticated %}
                    <button class="btn-outline-standard copy-btn action-icon-btn" onclick="copyPromptText()" id="copyButton">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-copy"/></svg>
                        <span id="copyButtonText">Copy</span>
                    </button>
                    {% else %}
                    <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-outline-standard copy-btn action-icon-btn">
                        <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-login"/></svg>
                        Login to Copy
                    </a>
                    {% endif %}
                </div>
                <div class="prompt-text-content" id="promptContent">
                    {{ prompt.content }}
                </div>
            </div>

            <!-- Tags Card -->
            {% if prompt.tags.all %}
            {% cache 300 prompt_tags prompt.id %}
            <div class="rail-card">
                <h2 class="rail-card-title">Tags</h2>
                <div class="tags-container">
                    {% for tag in prompt.tags.all %}
                        <a href="{% url 'prompts:home' %}?search={{ tag.name|urlencode }}"
                           class="tag-badge"
                           title="Search prompts tagged with {{ tag.name }}">
                            {{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
            {% endcache %}
            {% endif %}

            <!-- More from Author Section (Phase J.2) -->
            <!-- Only show if author has at least 1 other published prompt -->
            {% if more_from_author_count >= 1 %}
            {% cache 300 more_from_author prompt.author.id prompt.id %}
            <div class="rail-card more-from-author-card">
                <h2 class="rail-card-title">
                    More from
                    <a href="{% url 'prompts:user_profile' prompt.author.username %}"
                       class="author-link">@{{ prompt.author.username }}</a>
                </h2>
                <div class="more-from-author-thumbnails">
                    {% for author_prompt in more_from_author %}
                    {# Phase J.2 Fix 4: 4th thumbnail gets "+N more" overlay if author has 5+ prompts #}
                    {% if forloop.counter == 4 and author_remaining_count > 0 %}
                    <a href="{% url 'prompts:user_profile' prompt.author.username %}"
                       class="author-thumbnail-link author-thumbnail-more"
                       aria-label="+{{ author_remaining_count }} more, see all prompts from {{ prompt.author.username }}">
                        <div class="author-thumbnail-wrapper">
                            {% with thumb_url=author_prompt.display_thumb_url medium_url=author_prompt.display_medium_url %}
                            {% if thumb_url %}
                            <img src="{{ thumb_url }}"
                                 srcset="{{ thumb_url }} 300w{% if medium_url %}, {{ medium_url }} 600w{% endif %}"
                                 sizes="120px"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy"
                                 decoding="async">
                            {% else %}
                            <img src="{{ author_prompt.get_thumbnail_url }}"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy"
                                 decoding="async">
                            {% endif %}
                            {% endwith %}
                            <div class="author-thumbnail-count-overlay">
                                <span class="author-more-count">+{{ author_remaining_count }}</span>
                                <span class="author-more-text">See all prompts</span>
                            </div>
                        </div>
                    </a>
                    {% else %}
                    <a href="{% url 'prompts:prompt_detail' author_prompt.slug %}"
                       class="author-thumbnail-link"
                       aria-label="View {{ author_prompt.title }}">
                        <div class="author-thumbnail-wrapper">
                            {# Phase J.3: Video thumbnails get play icon and hover autoplay #}
                            {% if author_prompt.is_video %}
                            <div class="video-thumbnail-container">
                                {% with thumb_url=author_prompt.display_video_thumb_url|default:author_prompt.display_thumb_url medium_url=author_prompt.display_medium_url %}
                                <img src="{{ thumb_url|default:author_prompt.get_thumbnail_url }}"
                                     {% if thumb_url %}srcset="{{ thumb_url }} 300w{% if medium_url %}, {{ medium_url }} 600w{% endif %}"
                                     sizes="120px"{% endif %}
                                     alt="{{ author_prompt.title }}"
                                     class="author-thumbnail"
                                     loading="lazy"
                                     decoding="async">
                                {% endwith %}
                                <video class="thumbnail-video" muted loop playsinline preload="none">
                                    <source src="{{ author_prompt.get_video_url }}" type="video/mp4">
                                </video>
                                <div class="play-icon-overlay" aria-hidden="true">
                                    <svg class="play-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="24" fill="rgba(0,0,0,0.6)"/>
                                        <path d="M20 16L32 24L20 32V16Z" fill="white"/>
                                    </svg>
                                </div>
                                <div class="author-thumbnail-overlay" aria-hidden="true"></div>
                            </div>
                            {% else %}
                            {# Image prompt - use B2 or Cloudinary #}
                            {% with thumb_url=author_prompt.display_thumb_url medium_url=author_prompt.display_medium_url %}
                            {% if thumb_url %}
                            <img src="{{ thumb_url }}"
                                 srcset="{{ thumb_url }} 300w{% if medium_url %}, {{ medium_url }} 600w{% endif %}"
                                 sizes="120px"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy"
                                 decoding="async">
                            {% else %}
                            <img src="{{ author_prompt.get_thumbnail_url }}"
                                 alt="{{ author_prompt.title }}"
                                 class="author-thumbnail"
                                 loading="lazy"
                                 decoding="async">
                            {% endif %}
                            {% endwith %}
                            <div class="author-thumbnail-overlay" aria-hidden="true"></div>
                            {% endif %}
                        </div>
                    </a>
                    {% endif %}
                    {% endfor %}
                    {# Phase J.2 Fix 3: Add grey placeholders for empty slots #}
                    {% if more_from_author_count == 1 %}
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    {% elif more_from_author_count == 2 %}
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    {% elif more_from_author_count == 3 %}
                    <div class="author-thumbnail-placeholder" aria-hidden="true"></div>
                    {% endif %}
                </div>
            </div>
            {% endcache %}
            {% endif %}

        </div>

        <!-- ========================================
             COMMENTS SECTION (col-12)
             Full width, appears after right rail on mobile
             ======================================== -->
        <div class="col-12 comments-column">
            <div class="comments-section" id="comments">
                <h2 class="section-title">Comments ({{ comment_count }})</h2>

                <!-- Comment Form (Authenticated Users) -->
                {% if user.is_authenticated %}
                <div class="comment-form-wrapper mb-4">
                    {% load crispy_forms_tags %}
                    <form id="commentForm" method="post" class="comment-form">
                        {% csrf_token %}
                        {{ comment_form|crispy }}
                        <button id="submitButton" type="submit" class="btn btn-primary mt-3">Submit Comment</button>
                    </form>
                </div>
                {% else %}
                <div class="login-prompt mb-4">
                    <p><a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a> to leave a comment.</p>
                </div>
                {% endif %}

                <!-- Comments List -->
                <div class="comments-list">
                    {% for comment in comments %}
                        <div class="comment-card p-3 mb-3
                            {% if not comment.approved and comment.author == user %}
                                border border-warning faded
                            {% endif %}">
                            <p class="font-weight-bold comment-author">
                                By <a href="{% url 'prompts:user_profile' comment.author.username %}"
                                      class="text-decoration-none text-dark profile-link">
                                    {{ comment.author }}
                                </a>
                                <span class="font-weight-normal text-muted">
                                    on {{ comment.created_on }}
                                </span>
                            </p>
                            {% if not comment.approved and comment.author == user %}
                                <p class="approval">This comment is awaiting approval</p>
                            {% endif %}
                            <div id="comment{{ comment.id }}">
                                {{ comment.body | linebreaks }}
                            </div>
                            {% if user.is_authenticated and comment.author == user %}
                            <div class="mt-2 d-flex gap-2 mt-4">
                                <button class="btn btn-small btn-primary" onclick="toggleEditForm({{ comment.id }})">
                                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-edit"/></svg>&nbsp; Edit
                                </button>
                                <button type="button" class="btn btn-small btn-primary"
                                        onclick="confirmDelete('{% url 'prompts:comment_delete' prompt.slug comment.id %}')">
                                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>&nbsp; Delete
                                </button>

                                <!-- Hidden inline edit form -->
                                <div id="editForm{{ comment.id }}" style="display: none;" class="mt-3">
                                    <form method="post" action="{% url 'prompts:comment_edit' prompt.slug comment.id %}">
                                        {% csrf_token %}
                                        <div class="mb-2">
                                            <textarea name="body" class="form-control" rows="3" required>{{ comment.body }}</textarea>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-save"></i> Update
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEditForm({{ comment.id }})">
                                                <i class="fas fa-times"></i> Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="no-comments">
                            <p class="text-center text-muted">No comments yet. Be the first to share your thoughts!</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{# === Related Prompts Section (CSS column-count layout) === #}
{% if related_prompts %}
<section class="related-prompts-section">
    <div class="masonry-container related-prompts-container">
        <h2 class="related-prompts-title">You Might Also Like</h2>
        <div class="masonry-wrapper">
            <div class="masonry-grid related-prompts-grid" id="related-prompts-grid">
                {% for related_prompt in related_prompts %}
                    {% include 'prompts/partials/_prompt_card.html' with prompt=related_prompt %}
                {% endfor %}
            </div>
        </div>
        {% if has_more_related %}
        <div class="load-more-container text-center mt-4">
            <button id="load-more-related"
                    class="btn btn-primary btn-lg"
                    data-slug="{{ related_prompt_slug }}"
                    data-next-page="2"
                    aria-label="Load more related prompts">
                <i class="fas fa-plus-circle me-2"></i>
                Load More
            </button>
            <div id="related-loading-spinner" class="mt-3" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Loading more prompts...
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- Enhanced Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to move this prompt to trash?</p>
                <div class="alert alert-info mt-3" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> This prompt will be moved to your trash bin and kept for 5 days (free) or 30 days (premium) before permanent deletion. You can restore it anytime from your trash.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>&nbsp; Cancel
                </button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                    <svg class="icon icon-sm" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-trash"/></svg>&nbsp; Delete
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Report Prompt Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">
                    <svg class="icon icon-sm me-2" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-flag"/></svg>Report Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm" method="post" action="{% url 'prompts:report_prompt' prompt.slug %}">
                    {% csrf_token %}

                    <!-- Reason Selection -->
                    <div class="mb-3">
                        <label for="id_reason" class="form-label fw-bold">
                            <i class="fas fa-exclamation-triangle me-1"></i> Reason for Reporting *
                        </label>
                        <select name="reason" id="id_reason" class="form-control form-select" required>
                            <option value="">-- Select a reason --</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="copyright">Copyright Violation</option>
                            <option value="harassment">Harassment or Bullying</option>
                            <option value="other">Other</option>
                        </select>
                        <small class="form-text text-muted">Select the reason that best describes the issue</small>
                    </div>

                    <!-- Additional Comment -->
                    <div class="mb-3">
                        <label for="id_comment" class="form-label fw-bold">
                            <svg class="icon icon-sm me-1" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-comment"/></svg> Additional Details (Optional)
                        </label>
                        <textarea name="comment" id="id_comment" class="form-control"
                                  rows="4" maxlength="1000"
                                  placeholder="Please provide additional context to help us review this report..."></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>Provide context to help us review (max 1000 characters)
                            </small>
                            <small id="comment-counter" class="text-muted fw-bold">0 / 1000</small>
                        </div>
                    </div>

                    <!-- Error Display Area -->
                    <div id="reportError" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="reportErrorMessage"></span>
                    </div>

                    <!-- Success Display Area -->
                    <div id="reportSuccess" class="alert alert-success d-none" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="reportSuccessMessage"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="submit" form="reportForm" class="btn btn-danger" id="submitReportBtn">
                    <svg class="icon icon-sm me-1" aria-hidden="true"><use href="{% static 'icons/sprite.svg' %}#icon-flag"/></svg> Submit Report
                </button>
            </div>
        </div>
    </div>
</div>
</div><!-- .prompt-detail-page -->

{% endblock content %}

{% block extras %}
<!-- Prompt Detail Page JavaScript (deferred for performance) -->
<script src="{% static 'js/prompt-detail.js' %}" defer></script>

{% if has_more_related %}
<!-- Related Prompts Load More (CSS column-count handles layout) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    var loadMoreBtn = document.getElementById('load-more-related');
    if (!loadMoreBtn) return;

    var grid = document.getElementById('related-prompts-grid');
    var spinner = document.getElementById('related-loading-spinner');
    var isLoading = false;

    loadMoreBtn.addEventListener('click', function() {
        if (isLoading) return;
        isLoading = true;

        var slug = this.dataset.slug;
        var page = this.dataset.nextPage;

        this.style.display = 'none';
        spinner.style.display = 'block';

        fetch('/prompt/' + slug + '/related/?page=' + page, {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            // Append new items directly to grid (CSS column-count handles layout)
            grid.insertAdjacentHTML('beforeend', data.html);

            spinner.style.display = 'none';
            isLoading = false;

            if (data.has_more) {
                loadMoreBtn.dataset.nextPage = parseInt(page) + 1;
                loadMoreBtn.style.display = 'inline-block';
            }
        })
        .catch(function(err) {
            console.error('Failed to load related prompts:', err);
            spinner.style.display = 'none';
            loadMoreBtn.style.display = 'inline-block';
            isLoading = false;
        });
    });
});
</script>
{% endif %}
{% endblock %}